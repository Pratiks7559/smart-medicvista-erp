{% extends 'base.html' %}
{% load static %}

{% block title %}Database Backups{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-database"></i> Database Backups
            </h6>
            <button onclick="createBackup()" class="btn btn-success btn-sm">
                <i class="fas fa-plus"></i> Create New Backup
            </button>
        </div>
        <div class="card-body">
            {% if backups %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>Backup File</th>
                            <th>Date & Time</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup in backups %}
                        <tr>
                            <td>
                                <i class="fas fa-file-archive text-primary"></i>
                                {{ backup.filename }}
                                {% if backup.size == '0.00 MB' %}
                                <span class="badge badge-danger">Empty/Corrupt</span>
                                {% endif %}
                            </td>
                            <td>{{ backup.date }}</td>
                            <td>
                                <strong>{{ backup.size }}</strong>
                                {% if backup.size == '0.00 MB' %}
                                <br><small class="text-danger">⚠️ File may be corrupt</small>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'download_backup' backup.filename %}" class="btn btn-info btn-sm" title="Download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button onclick="restoreBackup('{{ backup.filename }}')" class="btn btn-warning btn-sm" title="Restore">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button onclick="deleteBackup('{{ backup.filename }}')" class="btn btn-danger btn-sm" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No backups found. Create your first backup!
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-info">
                <i class="fas fa-info-circle"></i> Backup Information
            </h6>
        </div>
        <div class="card-body">
            <ul>
                <li><strong>Create Backup:</strong> Creates a copy of your current database</li>
                <li><strong>Download:</strong> Download backup file to your computer</li>
                <li><strong>Restore:</strong> Replace current database with backup (creates safety backup first)</li>
                <li><strong>Delete:</strong> Remove backup file permanently</li>
            </ul>
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Important:</strong> After restoring a backup, you must restart the Django server for changes to take effect.
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function createBackup() {
    if (!confirm('Create a new backup of the database?')) return;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('/system/backups/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error: ' + error.message);
    });
}

function restoreBackup(filename) {
    if (!confirm('⚠️ WARNING: This will replace your current database with the backup.\n\nA safety backup will be created first.\n\nContinue?')) return;
    
    const csrftoken = getCookie('csrftoken');
    const formData = new FormData();
    formData.append('filename', filename);
    
    fetch('/system/backups/restore/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error: ' + error.message);
    });
}

function deleteBackup(filename) {
    if (!confirm('Delete backup: ' + filename + '?')) return;
    
    const csrftoken = getCookie('csrftoken');
    const formData = new FormData();
    formData.append('filename', filename);
    
    fetch('/system/backups/delete/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error: ' + error.message);
    });
}
</script>
{% endblock %}
