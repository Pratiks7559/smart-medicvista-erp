{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customer_challan_form.css' %}">
<link rel="stylesheet" href="{% static 'css/customer_challan_modals.css' %}">
{% endblock %}

{% block content %}
<div class="cust-chal-form-container">
    <div class="cust-chal-form-wrapper">
        <div class="cust-chal-form-card">
            <div class="cust-chal-form-header">
                <h5 class="cust-chal-form-title">Add Customer Challan with Products</h5>
                <small class="cust-chal-preview-no">Challan Number: Will be auto-generated</small>
            </div>
            <div class="cust-chal-form-body">
                <form method="post" id="custChallanForm" class="cust-chal-form">
                    {% csrf_token %}
                    
                    <!-- Challan Details Section -->
                    <div class="cust-chal-details-section">
                        <div class="cust-chal-form-row">
                            <div class="cust-chal-form-group">
                                <label for="challan_date" class="cust-chal-label">Challan Date</label>
                                <input type="date" name="challan_date" id="challan_date" class="cust-chal-input" required>
                            </div>
                            <div class="cust-chal-form-group">
                                <div class="cust-chal-series-header">
                                    <label for="challan_series" class="cust-chal-label">Challan Series</label>
                                    <button type="button" class="cust-chal-add-series-btn" onclick="openChallanSeriesDialog()">
                                        <i class="fas fa-plus"></i> Add Series
                                    </button>
                                </div>
                                <select name="challan_series" id="challan_series" class="cust-chal-input" onchange="updateChallanPreview()" required>
                                    <option value="">Select Series</option>
                                    {% for series in invoice_series %}
                                    <option value="{{ series.series_id }}" data-series-name="{{ series.series_name }}">{{ series.series_name }}</option>
                                    {% endfor %}
                                </select>
                                <div id="challanPreview" class="cust-chal-preview" style="display: none;">
                                    <small class="cust-chal-preview-text"></small>
                                </div>
                            </div>
                            <div class="cust-chal-form-group">
                                <div class="cust-chal-customer-header">
                                    <label for="customer_id" class="cust-chal-label">Customer</label>
                                    <button type="button" class="cust-chal-add-customer-btn" onclick="openCustomerDialog()">
                                        <i class="fas fa-plus"></i> Add Customer
                                    </button>
                                </div>
                                <select name="customer_id" id="customer_id" class="cust-chal-input" onchange="showCustomerType()" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.customerid }}" data-customer-type="{{ customer.customer_type }}">{{ customer.customer_name }}</option>
                                    {% endfor %}
                                </select>
                                <div id="customerRateInfo" class="cust-chal-rate-info" style="display: none;">
                                    <small class="cust-chal-rate-text"></small>
                                </div>
                            </div>
                            <div class="cust-chal-form-group">
                                <label for="transport_charges" class="cust-chal-label">Transport Charges</label>
                                <input type="number" name="transport_charges" id="transport_charges" class="cust-chal-input" value="0" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div class="cust-chal-products-section">
                        <div class="cust-chal-products-header">
                            <h6 class="cust-chal-section-title">Products</h6>
                            <button type="button" class="cust-chal-add-product-btn" onclick="addProductRow()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                        <div class="cust-chal-products-table-container">
                            <table class="cust-chal-products-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Batch No</th>
                                        <th>Expiry</th>
                                        <th>MRP</th>
                                        <th>Rate</th>
                                        <th>Qty</th>
                                        <th>Discount</th>
                                        <th>CGST%</th>
                                        <th>SGST%</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="productRows"></tbody>
                            </table>
                            <div class="cust-chal-total-section">
                                <strong>Grand Total: ‚Çπ<span id="grandTotal">0.00</span></strong>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="products_data" id="productsData">

                    <!-- Form Actions -->
                    <div class="cust-chal-form-actions">
                        <button type="submit" class="cust-chal-save-btn">
                            <i class="fas fa-save"></i> Save Challan
                        </button>
                        <a href="{% url 'customer_challan_list' %}" class="cust-chal-back-btn">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let productRowIndex = 0;
let selectedCustomerRateType = 'A';

// Set current date
document.addEventListener('DOMContentLoaded', function() {
    const dateField = document.getElementById('challan_date');
    if (dateField) {
        const today = new Date();
        dateField.value = today.toISOString().split('T')[0];
    }
    addProductRow();
});

// Update challan preview when series or date changes
function updateChallanPreview() {
    const seriesSelect = document.getElementById('challan_series');
    const dateField = document.getElementById('challan_date');
    const previewDiv = document.getElementById('challanPreview');
    const previewText = previewDiv.querySelector('.cust-chal-preview-text');
    
    if (seriesSelect.value && dateField.value) {
        const selectedOption = seriesSelect.options[seriesSelect.selectedIndex];
        const seriesName = selectedOption.getAttribute('data-series-name');
        const challanDate = new Date(dateField.value);
        
        // Format date as DDMMYYYY
        const day = String(challanDate.getDate()).padStart(2, '0');
        const month = String(challanDate.getMonth() + 1).padStart(2, '0');
        const year = challanDate.getFullYear();
        const dateStr = `${day}${month}${year}`;
        
        // Fetch next counter from backend
        fetch(`/api/get-next-challan-number/?series_name=${seriesName}&date=${dateField.value}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    previewText.innerHTML = `<i class="fas fa-file-invoice"></i> Next Challan: <strong>${data.challan_number}</strong>`;
                    previewDiv.style.display = 'block';
                } else {
                    // Fallback preview
                    previewText.innerHTML = `<i class="fas fa-file-invoice"></i> Next Challan: <strong>${seriesName}${dateStr}001</strong>`;
                    previewDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback preview
                previewText.innerHTML = `<i class="fas fa-file-invoice"></i> Next Challan: <strong>${seriesName}${dateStr}001</strong>`;
                previewDiv.style.display = 'block';
            });
    } else {
        previewDiv.style.display = 'none';
    }
}

// Update preview when date changes
document.addEventListener('DOMContentLoaded', function() {
    const dateField = document.getElementById('challan_date');
    if (dateField) {
        dateField.addEventListener('change', updateChallanPreview);
    }
});

// Show customer type when customer is selected
function showCustomerType() {
    const customerSelect = document.getElementById('customer_id');
    const rateInfo = document.getElementById('customerRateInfo');
    const rateText = rateInfo.querySelector('.cust-chal-rate-text');
    
    if (customerSelect.value) {
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        const customerType = selectedOption.getAttribute('data-customer-type');
        
        // Extract rate type from customer type (Type-A -> A)
        let rateType = 'A';
        if (customerType.includes('B')) {
            rateType = 'B';
            selectedCustomerRateType = 'B';
        } else if (customerType.includes('C')) {
            rateType = 'C';
            selectedCustomerRateType = 'C';
        } else {
            selectedCustomerRateType = 'A';
        }
        
        rateText.innerHTML = `<i class="fas fa-user"></i> Customer Type: <strong>${customerType}</strong> | Rate: <strong>Rate ${rateType}</strong>`;
        rateInfo.style.display = 'block';
    } else {
        rateInfo.style.display = 'none';
    }
}

function addProductRow() {
    const tbody = document.getElementById('productRows');
    const row = document.createElement('tr');
    row.id = `productRow_${productRowIndex}`;
    
    row.innerHTML = `
        <td><select class="cust-chal-product-select" onchange="loadProductDetails(this, ${productRowIndex})" required>
            <option value="">Select Product</option>
            {% for product in products %}
            <option value="{{ product.productid }}">{{ product.product_name }} - {{ product.product_company }}</option>
            {% endfor %}
        </select></td>
        <td><input type="text" class="cust-chal-batch-no" placeholder="Batch" required></td>
        <td><input type="text" class="cust-chal-expiry" placeholder="MM-YYYY" required></td>
        <td><input type="number" class="cust-chal-mrp" step="0.01" placeholder="0.00" required></td>
        <td>
            <input type="number" class="cust-chal-rate" step="0.01" placeholder="0.00" onchange="calculateRowTotal(${productRowIndex})" required>
            <div class="rate-info-display" style="display:none;"></div>
        </td>
        <td>
            <input type="number" class="cust-chal-quantity" step="0.01" placeholder="0" onchange="calculateRowTotal(${productRowIndex})" required>
            <div class="stock-info-display" style="display:none;"></div>
        </td>
        <td><input type="number" class="cust-chal-discount" step="0.01" placeholder="0.00" value="0" onchange="calculateRowTotal(${productRowIndex})"></td>
        <td><input type="number" class="cust-chal-cgst" step="0.01" placeholder="2.5" value="2.5" onchange="calculateRowTotal(${productRowIndex})"></td>
        <td><input type="number" class="cust-chal-sgst" step="0.01" placeholder="2.5" value="2.5" onchange="calculateRowTotal(${productRowIndex})"></td>
        <td><strong class="cust-chal-row-total">‚Çπ0.00</strong></td>
        <td><button type="button" class="cust-chal-remove-btn" onclick="removeProductRow(${productRowIndex})"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    productRowIndex++;
}

function removeProductRow(index) {
    const row = document.getElementById(`productRow_${index}`);
    if (row) {
        row.remove();
        calculateGrandTotal();
    }
}

function calculateRowTotal(index) {
    const row = document.getElementById(`productRow_${index}`);
    if (!row) return;
    
    const rate = parseFloat(row.querySelector('.cust-chal-rate').value) || 0;
    const quantity = parseFloat(row.querySelector('.cust-chal-quantity').value) || 0;
    const discount = parseFloat(row.querySelector('.cust-chal-discount').value) || 0;
    const cgst = parseFloat(row.querySelector('.cust-chal-cgst').value) || 0;
    const sgst = parseFloat(row.querySelector('.cust-chal-sgst').value) || 0;
    
    const baseAmount = rate * quantity;
    const discountedAmount = baseAmount - discount;
    const totalAmount = discountedAmount * (1 + ((cgst + sgst) / 100));
    
    row.querySelector('.cust-chal-row-total').textContent = '‚Çπ' + totalAmount.toFixed(2);
    calculateGrandTotal();
}

function calculateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll('.cust-chal-row-total').forEach(span => {
        const amount = parseFloat(span.textContent.replace('‚Çπ', '')) || 0;
        grandTotal += amount;
    });
    
    const transportCharges = parseFloat(document.getElementById('transport_charges').value) || 0;
    const finalTotal = grandTotal + transportCharges;
    
    if (transportCharges > 0) {
        document.getElementById('grandTotal').innerHTML = `${grandTotal.toFixed(2)} + ${transportCharges.toFixed(2)} = <strong>${finalTotal.toFixed(2)}</strong>`;
    } else {
        document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
    }
}

// Add event listener for transport charges input
document.addEventListener('DOMContentLoaded', function() {
    const transportInput = document.getElementById('transport_charges');
    if (transportInput) {
        transportInput.addEventListener('input', calculateGrandTotal);
    }
});

function loadProductDetails(select, rowIndex) {
    if (!select.value) return;
    // Auto-open batch selection modal
    showBatchSelectionDialog(select.value, rowIndex);
}

// F2 Quick Product Search & Alt+W Batch Selection
document.addEventListener('keydown', function(e) {
    if (e.key === 'F2') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    // Alt+W for batch selection
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        
        if (focusedElement && focusedElement.classList.contains('cust-chal-batch-no')) {
            const row = focusedElement.closest('tr');
            const productSelect = row.querySelector('.cust-chal-product-select');
            const rowIndex = row.id.split('_')[1];
            
            if (productSelect && productSelect.value) {
                showBatchSelectionDialog(productSelect.value, rowIndex);
            } else {
                alert('Please select a product first!');
            }
        }
    }
});

function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name..." onkeyup="quickSearchProducts(event)">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Home/End: First/Last | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        
        // Add comprehensive keyboard handling with throttling
        let keyThrottle = false;
        
        input.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('quickResults');
            
            switch(e.key) {
                case 'Escape':
                    closeQuickSearch();
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    if (!keyThrottle) {
                        keyThrottle = true;
                        navigateResults(1);
                        setTimeout(() => { keyThrottle = false; }, 100);
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (!keyThrottle) {
                        keyThrottle = true;
                        navigateResults(-1);
                        setTimeout(() => { keyThrottle = false; }, 100);
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get selected item or first item if none selected
                    let selected = resultsDiv.querySelector('.selected');
                    if (!selected) {
                        selected = resultsDiv.querySelector('.quick-result-item');
                    }
                    
                    if (selected) {
                        // Extract product info and call selection function directly
                        const productName = selected.querySelector('.product-name').textContent;
                        const productCompany = selected.querySelector('.product-company').textContent;
                        
                        // Find product ID from the products array
                        const products = [{% for product in products %}{
                            id: {{ product.productid }},
                            name: '{{ product.product_name|escapejs }}',
                            company: '{{ product.product_company|escapejs }}'
                        },{% endfor %}];
                        
                        const matchedProduct = products.find(p => 
                            p.name === productName && p.company === productCompany
                        );
                        
                        if (matchedProduct) {
                            quickSelectProduct(matchedProduct.id, matchedProduct.name, matchedProduct.company);
                        }
                    }
                    break;
                    
                case 'Home':
                    e.preventDefault();
                    const firstItem = resultsDiv.querySelector('.quick-result-item');
                    if (firstItem) {
                        resultsDiv.querySelectorAll('.quick-result-item').forEach(item => 
                            item.classList.remove('selected'));
                        firstItem.classList.add('selected');
                        firstItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    break;
                    
                case 'End':
                    e.preventDefault();
                    const items = resultsDiv.querySelectorAll('.quick-result-item');
                    if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        const lastItem = items[items.length - 1];
                        lastItem.classList.add('selected');
                        lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    break;
            }
        });
    }, 100);
}

let navigationThrottle = false;

function navigateResults(direction) {
    // Throttle navigation to prevent too fast movement
    if (navigationThrottle) return;
    navigationThrottle = true;
    
    setTimeout(() => {
        navigationThrottle = false;
    }, 150); // 150ms delay between navigations
    
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        // Wrap around navigation
        if (newIndex < 0) {
            newIndex = items.length - 1;
        } else if (newIndex >= items.length) {
            newIndex = 0;
        }
        
        current.classList.remove('selected');
    } else {
        // If no item selected, select first or last based on direction
        newIndex = direction > 0 ? 0 : items.length - 1;
    }
    
    items[newIndex].classList.add('selected');
    
    // Scroll selected item into view
    items[newIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
    });
}

function quickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    // Skip navigation keys - handled in keydown event
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Home', 'End'].includes(event.key)) {
        return;
    }
    
    // Handle search input
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    // Filter products from existing data
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectProduct(${product.id}, '${product.name}', '${product.company}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function quickSelectProduct(productId, productName, productCompany) {
    const rows = document.querySelectorAll('#productRows tr');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('.cust-chal-product-select');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addProductRow();
        setTimeout(() => {
            const newRows = document.querySelectorAll('#productRows tr');
            targetRow = newRows[newRows.length - 1];
            fillProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}

function fillProductInRow(row, productId) {
    const productSelect = row.querySelector('.cust-chal-product-select');
    if (productSelect) {
        productSelect.value = productId;
        const rowIndex = row.id.split('_')[1];
        loadProductDetails(productSelect, rowIndex);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) modal.remove();
}

function showBatchSelectionDialog(productId, rowIndex) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createBatchModal(data.batches, rowIndex);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading batch information.');
        });
}

function createBatchModal(batches, rowIndex) {
    const existingModal = document.getElementById('batchModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="batchModal" class="cust-chal-modal-overlay" tabindex="0">
            <div class="cust-chal-modal-content" onclick="event.stopPropagation()">
                <div class="cust-chal-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" onclick="closeBatchModal()">&times;</button>
                </div>
                <div class="cust-chal-batch-search">
                    <input type="text" id="batchSearchInput" placeholder="Search batch..." oninput="filterBatches()">
                </div>
                <div class="cust-chal-modal-body" id="batchListContainer">
                    ${batches.map((batch, index) => `
                        <div class="cust-chal-batch-item ${index === 0 ? 'highlighted' : ''}" 
                             data-batch-data='${JSON.stringify(batch).replace(/'/g, "&apos;")}'
                             onclick="selectBatchFromModal(${rowIndex}, this)">
                            <div class="batch-main-info">
                                <strong class="batch-number">${batch.batch_no}</strong>
                                <span class="batch-expiry">Exp: ${batch.expiry}</span>
                                <span class="batch-stock">Stock: ${batch.stock}</span>
                                <span class="batch-mrp">MRP: ‚Çπ${batch.mrp}</span>
                            </div>
                            <div class="batch-rates">
                                <span class="rate-a">A: ‚Çπ${batch.rates ? batch.rates.rate_A : 0}</span>
                                <span class="rate-b">B: ‚Çπ${batch.rates ? batch.rates.rate_B : 0}</span>
                                <span class="rate-c">C: ‚Çπ${batch.rates ? batch.rates.rate_C : 0}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="cust-chal-modal-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const modal = document.getElementById('batchModal');
    const searchInput = document.getElementById('batchSearchInput');
    
    // Add keyboard navigation
    modal.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeBatchModal();
        } else if (e.key === 'Enter') {
            const highlighted = document.querySelector('.cust-chal-batch-item.highlighted');
            if (highlighted) highlighted.click();
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            navigateBatchItems(e.key === 'ArrowDown' ? 1 : -1);
        }
    });
    
    // Focus on search input
    setTimeout(() => {
        if (searchInput) searchInput.focus();
    }, 100);
}

function filterBatches() {
    const searchTerm = document.getElementById('batchSearchInput').value.toLowerCase();
    const batchItems = document.querySelectorAll('.cust-chal-batch-item');
    
    let firstVisible = null;
    batchItems.forEach(item => {
        const batchData = JSON.parse(item.getAttribute('data-batch-data'));
        const batchNo = batchData.batch_no.toLowerCase();
        const expiry = batchData.expiry.toLowerCase();
        
        if (batchNo.includes(searchTerm) || expiry.includes(searchTerm)) {
            item.style.display = 'block';
            if (!firstVisible) firstVisible = item;
        } else {
            item.style.display = 'none';
        }
        item.classList.remove('highlighted');
    });
    
    // Auto-highlight first visible item
    if (firstVisible) {
        firstVisible.classList.add('highlighted');
    }
}

function navigateBatchItems(direction) {
    const allItems = Array.from(document.querySelectorAll('.cust-chal-batch-item'));
    const visibleItems = allItems.filter(item => item.style.display !== 'none');
    
    if (visibleItems.length === 0) return;
    
    const highlighted = document.querySelector('.cust-chal-batch-item.highlighted');
    let newIndex = 0;
    
    if (highlighted) {
        const currentIndex = visibleItems.indexOf(highlighted);
        newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = visibleItems.length - 1;
        if (newIndex >= visibleItems.length) newIndex = 0;
        highlighted.classList.remove('highlighted');
    }
    
    visibleItems[newIndex].classList.add('highlighted');
    visibleItems[newIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

function selectBatchFromModal(rowIndex, element) {
    const batchData = JSON.parse(element.getAttribute('data-batch-data'));
    selectBatch(batchData.batch_no, rowIndex, batchData);
}

function selectBatch(batchNo, rowIndex, batchData) {
    const row = document.getElementById(`productRow_${rowIndex}`);
    if (row) {
        row.querySelector('.cust-chal-batch-no').value = batchNo;
        row.querySelector('.cust-chal-expiry').value = batchData.expiry;
        row.querySelector('.cust-chal-mrp').value = batchData.mrp;
        
        // Select rate based on customer rate type
        let selectedRate = batchData.mrp;
        let rateSource = 'MRP';
        
        if (batchData.rates) {
            if (selectedCustomerRateType === 'A' && batchData.rates.rate_A > 0) {
                selectedRate = batchData.rates.rate_A;
                rateSource = 'Rate A';
            } else if (selectedCustomerRateType === 'B' && batchData.rates.rate_B > 0) {
                selectedRate = batchData.rates.rate_B;
                rateSource = 'Rate B';
            } else if (selectedCustomerRateType === 'C' && batchData.rates.rate_C > 0) {
                selectedRate = batchData.rates.rate_C;
                rateSource = 'Rate C';
            }
        }
        
        row.querySelector('.cust-chal-rate').value = selectedRate;
        row.querySelector('.cust-chal-quantity').value = '1';
        
        // Show rate info below rate input
        const rateInfoDiv = row.querySelector('.rate-info-display');
        if (rateInfoDiv) {
            rateInfoDiv.innerHTML = `<small style="color: #28a745; font-weight: 500;"><i class="fas fa-tag"></i> Applied: ${rateSource} = ‚Çπ${selectedRate}</small>`;
            rateInfoDiv.style.display = 'block';
        }
        
        // Show stock info below quantity input
        const stockInfoDiv = row.querySelector('.stock-info-display');
        if (stockInfoDiv) {
            stockInfoDiv.innerHTML = `<small style="color: #007bff; font-weight: 500;"><i class="fas fa-box"></i> Stock: ${batchData.stock}</small>`;
            stockInfoDiv.style.display = 'block';
        }
        
        calculateRowTotal(rowIndex);
        
        // Focus on quantity field after batch selection
        setTimeout(() => {
            const qtyInput = row.querySelector('.cust-chal-quantity');
            if (qtyInput) {
                qtyInput.focus();
                qtyInput.select();
            }
        }, 100);
    }
    closeBatchModal();
}

function closeBatchModal() {
    const modal = document.getElementById('batchModal');
    if (modal) modal.remove();
}

document.getElementById('custChallanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const products = [];
    const rows = document.querySelectorAll('#productRows tr');
    
    rows.forEach(row => {
        const productSelect = row.querySelector('.cust-chal-product-select');
        if (productSelect && productSelect.value) {
            products.push({
                productid: productSelect.value,
                batch_no: row.querySelector('.cust-chal-batch-no').value,
                expiry: row.querySelector('.cust-chal-expiry').value,
                mrp: parseFloat(row.querySelector('.cust-chal-mrp').value) || 0,
                sale_rate: parseFloat(row.querySelector('.cust-chal-rate').value) || 0,
                quantity: parseFloat(row.querySelector('.cust-chal-quantity').value) || 0,
                discount: parseFloat(row.querySelector('.cust-chal-discount').value) || 0,
                cgst: parseFloat(row.querySelector('.cust-chal-cgst').value) || 0,
                sgst: parseFloat(row.querySelector('.cust-chal-sgst').value) || 0,
                rate_applied: selectedCustomerRateType
            });
        }
    });
    
    if (products.length === 0) {
        alert('Please add at least one product');
        return;
    }
    
    document.getElementById('productsData').value = JSON.stringify(products);
    this.submit();
});

// Customer Dialog Functions
function openCustomerDialog() {
    document.getElementById('customerDialog').style.display = 'flex';
    setTimeout(() => {
        document.querySelector('#customerDialogForm input[type="text"]')?.focus();
    }, 100);
}

function closeCustomerDialog() {
    document.getElementById('customerDialog').style.display = 'none';
    document.getElementById('customerDialogForm').reset();
}

function saveCustomer() {
    const form = document.getElementById('customerDialogForm');
    const formData = new FormData(form);
    
    if (!formData.get('customer_name') || !formData.get('customer_type') || !formData.get('customer_credit_days')) {
        alert('Please fill in all required fields');
        return;
    }
    
    const saveBtn = document.querySelector('.customer-dialog-btn-primary');
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    fetch('{% url "add_customer" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const customerSelect = document.getElementById('customer_id');
            const newOption = document.createElement('option');
            newOption.value = data.customer_id;
            newOption.textContent = data.customer_name;
            newOption.selected = true;
            customerSelect.appendChild(newOption);
            closeCustomerDialog();
            alert(data.message);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    })
    .finally(() => {
        saveBtn.innerHTML = 'Save Customer';
        saveBtn.disabled = false;
    });
}

// Series Dialog Functions
function openChallanSeriesDialog() {
    document.getElementById('seriesDialog').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('seriesNameInput')?.focus();
    }, 100);
}

function closeSeriesDialog() {
    document.getElementById('seriesDialog').style.display = 'none';
    document.getElementById('seriesForm').reset();
}

function saveSeries() {
    const form = document.getElementById('seriesForm');
    const formData = new FormData(form);
    const seriesName = formData.get('series_name');
    
    if (!seriesName || seriesName.trim().length === 0) {
        alert('Please enter a series name');
        return;
    }
    
    if (seriesName.length > 10) {
        alert('Series name must be 10 characters or less');
        return;
    }
    
    const saveBtn = document.querySelector('.series-dialog-btn-primary');
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    saveBtn.disabled = true;
    
    fetch('/api/add-challan-series/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const seriesSelect = document.getElementById('challan_series');
            const newOption = document.createElement('option');
            newOption.value = data.series_id;
            newOption.textContent = data.series_name;
            newOption.setAttribute('data-series-name', data.series_name);
            newOption.selected = true;
            seriesSelect.appendChild(newOption);
            closeSeriesDialog();
            alert(data.message);
            updateChallanPreview();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    })
    .finally(() => {
        saveBtn.innerHTML = 'Add Series';
        saveBtn.disabled = false;
    });
}
</script>

<!-- Customer Dialog Modal -->
<div id="customerDialog" class="customer-dialog-overlay" style="display: none;">
    <div class="customer-dialog-content">
        <div class="customer-dialog-header">
            <h3><i class="fas fa-user-plus"></i> Add New Customer</h3>
            <button type="button" class="customer-dialog-close" onclick="closeCustomerDialog()">&times;</button>
        </div>
        <div class="customer-dialog-body">
            <form id="customerDialogForm" class="customer-dialog-form">
                {% csrf_token %}
                <div class="customer-form-row">
                    <div class="customer-form-col">
                        <label class="customer-form-label">Customer Name*</label>
                        <input type="text" name="customer_name" class="customer-form-input" required>
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Customer Type*</label>
                        <select name="customer_type" class="customer-form-input" required>
                            <option value="">Select Type</option>
                            <option value="Type-A">Type-A</option>
                            <option value="Type-B">Type-B</option>
                            <option value="Type-C">Type-C</option>
                        </select>
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Mobile Number</label>
                        <input type="text" name="customer_mobile" class="customer-form-input">
                    </div>
                </div>
                <div class="customer-form-row">
                    <div class="customer-form-col">
                        <label class="customer-form-label">WhatsApp Number</label>
                        <input type="text" name="customer_whatsapp" class="customer-form-input">
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Email Address</label>
                        <input type="email" name="customer_emailid" class="customer-form-input">
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Contact Person</label>
                        <input type="text" name="customer_spoc" class="customer-form-input">
                    </div>
                </div>
                <div class="customer-form-row">
                    <div class="customer-form-col">
                        <label class="customer-form-label">Address</label>
                        <textarea name="customer_address" class="customer-form-input" rows="2"></textarea>
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Drug License</label>
                        <input type="text" name="customer_dlno" class="customer-form-input">
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">GST Number</label>
                        <input type="text" name="customer_gstno" class="customer-form-input">
                    </div>
                </div>
                <div class="customer-form-row">
                    <div class="customer-form-col">
                        <label class="customer-form-label">Food License</label>
                        <input type="text" name="customer_food_license_no" class="customer-form-input">
                    </div>
                    <div class="customer-form-col">
                        <label class="customer-form-label">Credit Days*</label>
                        <input type="number" name="customer_credit_days" class="customer-form-input" value="0" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="customer-dialog-footer">
            <button type="button" class="customer-dialog-btn customer-dialog-btn-secondary" onclick="closeCustomerDialog()">Cancel</button>
            <button type="button" class="customer-dialog-btn customer-dialog-btn-primary" onclick="saveCustomer()">Save Customer</button>
        </div>
    </div>
</div>

<!-- Series Dialog Modal -->
<div id="seriesDialog" class="series-dialog-overlay" style="display: none;">
    <div class="series-dialog-content">
        <div class="series-dialog-header">
            <h3><i class="fas fa-plus-circle"></i> Add New Series</h3>
            <button type="button" class="series-dialog-close" onclick="closeSeriesDialog()">&times;</button>
        </div>
        <div class="series-dialog-body">
            <form id="seriesForm" class="series-dialog-form">
                {% csrf_token %}
                <div class="series-form-row">
                    <div class="series-form-col">
                        <label class="series-form-label">Series Name*</label>
                        <input type="text" name="series_name" id="seriesNameInput" class="series-form-input" 
                               placeholder="e.g., ABC, XYZ" maxlength="10" required style="text-transform: uppercase;">
                        <small class="series-help-text">Maximum 10 characters</small>
                    </div>
                </div>
            </form>
        </div>
        <div class="series-dialog-footer">
            <button type="button" class="series-dialog-btn series-dialog-btn-secondary" onclick="closeSeriesDialog()">Cancel</button>
            <button type="button" class="series-dialog-btn series-dialog-btn-primary" onclick="saveSeries()">Add Series</button>
        </div>
    </div>
</div>

<style>
.customer-dialog-overlay, .series-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.customer-dialog-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.series-dialog-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.customer-dialog-header, .series-dialog-header {
    padding: 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.customer-dialog-header h3, .series-dialog-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.customer-dialog-close, .series-dialog-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
}

.customer-dialog-body, .series-dialog-body {
    padding: 20px;
}

.customer-form-row, .series-form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.customer-form-col, .series-form-col {
    flex: 1;
}

.customer-form-label, .series-form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.customer-form-input, .series-form-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.customer-form-input:focus, .series-form-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.customer-dialog-footer, .series-dialog-footer {
    padding: 20px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
}

.customer-dialog-btn, .series-dialog-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}

.customer-dialog-btn-primary, .series-dialog-btn-primary {
    background-color: #007bff;
    color: white;
}

.customer-dialog-btn-primary:hover, .series-dialog-btn-primary:hover {
    background-color: #0056b3;
}

.customer-dialog-btn-secondary, .series-dialog-btn-secondary {
    background-color: #6c757d;
    color: white;
}

.customer-dialog-btn-secondary:hover, .series-dialog-btn-secondary:hover {
    background-color: #545b62;
}

.series-help-text {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    display: block;
}

.cust-chal-preview {
    margin-top: 8px;
    padding: 8px;
    background: #e8f5e9;
    border-radius: 4px;
    border-left: 3px solid #4caf50;
}

.cust-chal-preview-text {
    color: #2e7d32;
    font-weight: 500;
    font-size: 13px;
}

@media (max-width: 768px) {
    .customer-form-row {
        flex-direction: column;
        gap: 10px;
    }
    .customer-dialog-content, .series-dialog-content {
        width: 95%;
        margin: 10px;
    }
}

/* Quick Product Search Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-search-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.quick-search-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e5e5e5;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.quick-search-header h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.quick-search-input {
    padding: 15px 20px;
}

.quick-search-input input {
    width: 100%;
    padding: 10px;
    border: 2px solid #007bff;
    border-radius: 4px;
    font-size: 16px;
}

.quick-search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
}

.quick-result-item {
    padding: 12px;
    border-bottom: 1px solid #e5e5e5;
    cursor: pointer;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #e9ecef;
}

.product-name {
    font-weight: 600;
    color: #333;
}

.product-company {
    font-size: 13px;
    color: #666;
}

.quick-search-footer {
    padding: 10px 20px;
    border-top: 1px solid #e5e5e5;
    background: #f8f9fa;
    text-align: center;
    border-radius: 0 0 8px 8px;
}

.cust-chal-batch-item.highlighted {
    background: #e9ecef !important;
    border-left: 3px solid #007bff;
}

.cust-chal-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cust-chal-modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.cust-chal-modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.cust-chal-modal-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
}

.cust-chal-batch-search {
    padding: 15px 20px;
    border-bottom: 1px solid #e5e5e5;
}

.cust-chal-batch-search input {
    width: 100%;
    padding: 10px;
    border: 2px solid #007bff;
    border-radius: 4px;
    font-size: 14px;
}

.cust-chal-modal-body {
    padding: 10px;
    max-height: 400px;
    overflow-y: auto;
}

.cust-chal-batch-item {
    padding: 12px;
    border-bottom: 1px solid #e5e5e5;
    cursor: pointer;
    transition: all 0.2s;
}

.cust-chal-batch-item:hover {
    background: #f8f9fa;
}

.batch-main-info {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 8px;
}

.batch-number {
    font-size: 15px;
    color: #333;
    min-width: 100px;
}

.batch-expiry, .batch-stock, .batch-mrp {
    font-size: 13px;
    color: #666;
}

.batch-rates {
    display: flex;
    gap: 15px;
    font-size: 13px;
    padding-left: 5px;
}

.rate-a {
    color: #28a745;
    font-weight: 500;
}

.rate-b {
    color: #007bff;
    font-weight: 500;
}

.rate-c {
    color: #dc3545;
    font-weight: 500;
}

.cust-chal-modal-footer {
    padding: 10px 20px;
    border-top: 1px solid #e5e5e5;
    background: #f8f9fa;
    text-align: center;
    border-radius: 0 0 8px 8px;
}

.rate-info-display {
    margin-top: 4px;
    padding: 4px 8px;
    background: #d4edda;
    border-radius: 3px;
    border-left: 3px solid #28a745;
}

.rate-info-display small {
    font-size: 12px;
}

.stock-info-display {
    margin-top: 4px;
    padding: 4px 8px;
    background: #d1ecf1;
    border-radius: 3px;
    border-left: 3px solid #007bff;
}

.stock-info-display small {
    font-size: 12px;
}
</style>
{% endblock %}
