{% extends 'base.html' %}
{% load static %}

{% block title %}Challan {{ challan.challan_no }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0;">Challan Details - {{ challan.challan_no }}</h4>
                <button type="button" class="btn btn-light btn-sm" onclick="openEditChallanModal()">
                    <i class="fas fa-edit"></i> Edit Challan
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>Challan No:</strong> {{ challan.challan_no }}</p>
                    <p><strong>Date:</strong> {{ challan.challan_date|date:"d M, Y" }}</p>
                    <p><strong>Supplier:</strong> {{ challan.supplier.supplier_name }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Transport Charges:</strong> ‚Çπ{{ challan.transport_charges|floatformat:2 }}</p>
                    <p><strong>Total Amount:</strong> ‚Çπ{{ challan.challan_total|floatformat:2 }}</p>
                    <p><strong>Paid:</strong> ‚Çπ{{ challan.challan_paid|floatformat:2 }}</p>
                </div>
            </div>

            <h5>Products</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Expiry</th>
                            <th>MRP</th>
                            <th>Rate</th>
                            <th>Qty</th>
                            <th>Discount</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in challan_items %}
                        <tr>
                            <td>{{ item.product_name }}<br><small>{{ item.product_company }}</small></td>
                            <td>{{ item.product_batch_no }}</td>
                            <td>{{ item.product_expiry }}</td>
                            <td>‚Çπ{{ item.product_mrp|floatformat:2 }}</td>
                            <td>‚Çπ{{ item.product_purchase_rate|floatformat:2 }}</td>
                            <td>{{ item.product_quantity }}</td>
                            <td>‚Çπ{{ item.product_discount|floatformat:2 }}</td>
                            <td>{{ item.cgst }}%</td>
                            <td>{{ item.sgst }}%</td>
                            <td>‚Çπ{{ item.total_amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        {% if challan.transport_charges > 0 %}
                        <tr>
                            <td colspan="9" style="text-align: right; font-weight: 600;">Subtotal:</td>
                            <td style="font-weight: 600;">‚Çπ{{ products_total|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td colspan="9" style="text-align: right; font-weight: 600;">Transport Charges:</td>
                            <td style="font-weight: 600;">‚Çπ{{ challan.transport_charges|floatformat:2 }}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td colspan="9" style="text-align: right; font-weight: 700; font-size: 16px;">Grand Total:</td>
                            <td style="font-weight: 700; font-size: 16px;">‚Çπ{{ challan.challan_total|floatformat:2 }}</td>
                        </tr>
                        {% else %}
                        <tr style="background: #f8f9fa;">
                            <td colspan="9" style="text-align: right; font-weight: 700; font-size: 16px;">Grand Total:</td>
                            <td style="font-weight: 700; font-size: 16px;">‚Çπ{{ challan.challan_total|floatformat:2 }}</td>
                        </tr>
                        {% endif %}
                    </tfoot>
                </table>
            </div>

            <div class="mt-3">
                <a href="{% url 'supplier_challan_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Challan Modal -->
<div id="editChallanModal" class="modal" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Supplier Challan #{{ challan.challan_no }}</h3>
                <span class="close" onclick="closeEditChallanModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editChallanForm" method="post">
                    {% csrf_token %}
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="challan_date">Challan Date:</label>
                            <input type="date" id="challan_date" name="challan_date" value="{{ challan.challan_date|date:'Y-m-d' }}" required autofocus>
                        </div>
                        <div class="form-group">
                            <label for="supplier">Supplier:</label>
                            <select id="supplier" name="supplier" required>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.supplierid }}" {% if supplier.supplierid == challan.supplier.supplierid %}selected{% endif %}>
                                    {{ supplier.supplier_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transport_charges">Transport Charges:</label>
                            <input type="number" id="transport_charges" name="transport_charges" value="{{ challan.transport_charges }}" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <h4>Products</h4>
                    <div id="productsContainer"></div>
                    
                    <button type="button" onclick="addNewProduct()" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    
                    <div class="modal-footer">
                        <button type="button" onclick="closeEditChallanModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Challan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productCounter = 0;

function openEditChallanModal() {
    document.getElementById('editChallanModal').style.display = 'block';
    loadExistingProducts();
    setTimeout(() => {
        document.getElementById('challan_date').focus();
    }, 300);
}

function closeEditChallanModal() {
    document.getElementById('editChallanModal').style.display = 'none';
}

function loadExistingProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    
    {% for item in challan_items %}
    addProductRow({
        productid: {{ item.product_id.productid }},
        product_name: '{{ item.product_name|escapejs }}',
        product_batch_no: '{{ item.product_batch_no|escapejs }}',
        product_expiry: '{{ item.product_expiry }}',
        product_mrp: {{ item.product_mrp }},
        product_purchase_rate: {{ item.product_purchase_rate }},
        product_quantity: {{ item.product_quantity }},
        product_discount: {{ item.product_discount }},
        cgst: {{ item.cgst }},
        sgst: {{ item.sgst }}
    });
    {% endfor %}
}

function addNewProduct() {
    addProductRow({});
}

function addProductRow(data = {}) {
    const container = document.getElementById('productsContainer');
    const productId = `product_${productCounter++}`;
    
    const productRow = document.createElement('div');
    productRow.className = 'product-row';
    
    let productOptions = '<option value="">Select Product</option>';
    {% for product in products %}
    productOptions += `<option value="{{ product.productid }}" ${data.productid && data.productid == {{ product.productid }} ? 'selected' : ''}>{{ product.product_name|escapejs }} - {{ product.product_company|escapejs }}</option>`;
    {% endfor %}
    
    productRow.innerHTML = `
        <div class="product-grid">
            <div class="form-group">
                <label>Product:</label>
                <select name="products[${productId}][productid]">
                    ${productOptions}
                </select>
            </div>
            <div class="form-group">
                <label>Batch No:</label>
                <input type="text" name="products[${productId}][batch_no]" value="${data.product_batch_no || ''}">
            </div>
            <div class="form-group">
                <label>Expiry:</label>
                <input type="text" name="products[${productId}][expiry]" value="${data.product_expiry || ''}" placeholder="MM-YYYY">
            </div>
            <div class="form-group">
                <label>MRP:</label>
                <input type="number" name="products[${productId}][mrp]" value="${data.product_mrp || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Purchase Rate:</label>
                <input type="number" name="products[${productId}][purchase_rate]" value="${data.product_purchase_rate || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" name="products[${productId}][quantity]" value="${data.product_quantity || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Discount:</label>
                <input type="number" name="products[${productId}][discount]" value="${data.product_discount || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>CGST %:</label>
                <input type="number" name="products[${productId}][cgst]" value="${data.cgst || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <label>SGST %:</label>
                <input type="number" name="products[${productId}][sgst]" value="${data.sgst || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <button type="button" onclick="removeProduct(this)" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(productRow);
}

function removeProduct(button) {
    button.closest('.product-row').remove();
}

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editChallanForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const products = [];
            const productRows = document.querySelectorAll('.product-row');
            
            productRows.forEach(row => {
                const productSelect = row.querySelector('select[name*="[productid]"]');
                const batchInput = row.querySelector('input[name*="[batch_no]"]');
                const expiryInput = row.querySelector('input[name*="[expiry]"]');
                const mrpInput = row.querySelector('input[name*="[mrp]"]');
                const rateInput = row.querySelector('input[name*="[purchase_rate]"]');
                const qtyInput = row.querySelector('input[name*="[quantity]"]');
                const discountInput = row.querySelector('input[name*="[discount]"]');
                const cgstInput = row.querySelector('input[name*="[cgst]"]');
                const sgstInput = row.querySelector('input[name*="[sgst]"]');
                
                if (productSelect && productSelect.value) {
                    products.push({
                        productid: productSelect.value,
                        batch_no: batchInput ? batchInput.value : '',
                        expiry: expiryInput ? expiryInput.value : '',
                        mrp: mrpInput ? parseFloat(mrpInput.value) || 0 : 0,
                        purchase_rate: rateInput ? parseFloat(rateInput.value) || 0 : 0,
                        quantity: qtyInput ? parseFloat(qtyInput.value) || 0 : 0,
                        discount: discountInput ? parseFloat(discountInput.value) || 0 : 0,
                        cgst: cgstInput ? parseFloat(cgstInput.value) || 0 : 0,
                        sgst: sgstInput ? parseFloat(sgstInput.value) || 0 : 0
                    });
                }
            });
            
            formData.append('products_data', JSON.stringify(products));
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating challan');
            });
        });
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('editChallanModal');
    if (event.target === modal) {
        closeEditChallanModal();
    }
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('editChallanModal');
    
    // Ctrl+E to open modal (works globally)
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        if (!modal || modal.style.display === 'none') {
            openEditChallanModal();
        }
        return;
    }
    
    // Other shortcuts only work when modal is open
    if (!modal || modal.style.display === 'none') return;
    
    if (e.key === 'F2') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        if (focusedElement && focusedElement.name && focusedElement.name.includes('[batch_no]')) {
            const row = focusedElement.closest('.product-row');
            const productSelect = row.querySelector('select[name*="[productid]"]');
            if (productSelect && productSelect.value) {
                showBatchSelectionDialog(productSelect.value, row);
            } else {
                alert('Please select a product first!');
            }
        }
    }
    
    if (e.key === 'Escape') {
        const quickModal = document.getElementById('quickProductModal');
        const batchModal = document.getElementById('batchSelectionModal');
        if (quickModal) {
            closeQuickSearch();
        } else if (batchModal) {
            closeBatchModal();
        } else {
            closeEditChallanModal();
        }
    }
});

function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name...">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        input.addEventListener('input', quickSearchProducts);
        input.addEventListener('keydown', handleQuickSearchKeys);
    }, 100);
}

function quickSearchProducts(e) {
    const searchTerm = e.target.value.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    const filtered = products.filter(p => 
        p.name.toLowerCase().startsWith(searchTerm) || 
        p.company.toLowerCase().startsWith(searchTerm)
    ).sort((a, b) => a.name.localeCompare(b.name));
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             data-product-id="${product.id}"
             onclick="selectQuickProduct(${product.id})">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function handleQuickSearchKeys(e) {
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateQuickResults(1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateQuickResults(-1);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = document.querySelector('.quick-result-item.selected');
        if (selected) selectQuickProduct(selected.getAttribute('data-product-id'));
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeQuickSearch();
    }
}

function navigateQuickResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function selectQuickProduct(productId) {
    const rows = document.querySelectorAll('.product-row');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('select[name*="[productid]"]');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addNewProduct();
        setTimeout(() => {
            const newRows = document.querySelectorAll('.product-row');
            targetRow = newRows[newRows.length - 1];
            fillProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}

function fillProductInRow(row, productId) {
    const productSelect = row.querySelector('select[name*="[productid]"]');
    if (productSelect) {
        productSelect.value = productId;
        // Auto-open batch selection after product selection
        setTimeout(() => {
            showBatchSelectionDialog(productId, row);
        }, 200);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) modal.remove();
}

function showBatchSelectionDialog(productId, row) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createBatchSelectionModal(data.batches, row);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading batch information.');
        });
}

function createBatchSelectionModal(batches, row) {
    const existingModal = document.getElementById('batchSelectionModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="batchSelectionModal" class="batch-modal-overlay">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" class="batch-modal-close" onclick="closeBatchModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="batchSearch" placeholder="Search batch...">
                    </div>
                    <div class="batch-list" id="batchList">
                        ${batches.map((batch, index) => `
                            <div class="batch-item ${index === 0 ? 'batch-selected' : ''}" 
                                 data-batch-index="${index}" 
                                 data-batch-data='${JSON.stringify(batch)}'
                                 onclick="selectBatch(this)">
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span>Exp: ${batch.expiry}</span>
                                        <span>Stock: ${batch.stock}</span>
                                        <span>MRP: ‚Çπ${batch.mrp}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    setTimeout(() => {
        const searchInput = document.getElementById('batchSearch');
        searchInput.focus();
        searchInput.addEventListener('input', filterBatches);
        document.addEventListener('keydown', handleBatchKeys);
    }, 50);
}

function filterBatches(e) {
    const searchTerm = e.target.value.toLowerCase();
    const batchItems = document.querySelectorAll('.batch-item');
    batchItems.forEach(item => item.classList.remove('batch-selected'));
    
    let firstVisible = null;
    batchItems.forEach(item => {
        const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
        if (batchNo.includes(searchTerm)) {
            item.style.display = 'block';
            if (!firstVisible) firstVisible = item;
        } else {
            item.style.display = 'none';
        }
    });
    
    if (firstVisible) firstVisible.classList.add('batch-selected');
}

function handleBatchKeys(e) {
    const modal = document.getElementById('batchSelectionModal');
    if (!modal) return;
    
    const visibleItems = Array.from(document.querySelectorAll('.batch-item')).filter(item => item.style.display !== 'none');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateBatches(visibleItems, 1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateBatches(visibleItems, -1);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = document.querySelector('.batch-item.batch-selected');
        if (selected) selectBatch(selected);
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeBatchModal();
    }
}

function navigateBatches(items, direction) {
    if (items.length === 0) return;
    
    const current = items.find(item => item.classList.contains('batch-selected'));
    let newIndex = 0;
    
    if (current) {
        const currentIndex = items.indexOf(current);
        newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        current.classList.remove('batch-selected');
    }
    
    items[newIndex].classList.add('batch-selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function selectBatch(element) {
    const batchData = JSON.parse(element.getAttribute('data-batch-data'));
    const rows = document.querySelectorAll('.product-row');
    
    // Find the active row (where batch selection was triggered)
    let targetRow = null;
    for (let row of rows) {
        const batchInput = row.querySelector('input[name*="[batch_no]"]');
        if (batchInput && (document.activeElement.closest('.product-row') === row || !batchInput.value)) {
            targetRow = row;
            break;
        }
    }
    
    // If no specific row found, use the last row
    if (!targetRow && rows.length > 0) {
        targetRow = rows[rows.length - 1];
    }
    
    if (targetRow) {
        // Auto-fill all batch details
        targetRow.querySelector('input[name*="[batch_no]"]').value = batchData.batch_no;
        targetRow.querySelector('input[name*="[expiry]"]').value = batchData.expiry;
        targetRow.querySelector('input[name*="[mrp]"]').value = batchData.mrp;
        targetRow.querySelector('input[name*="[purchase_rate]"]').value = batchData.mrp;
        targetRow.querySelector('input[name*="[quantity]"]').value = '1';
        targetRow.querySelector('input[name*="[discount]"]').value = '0';
        targetRow.querySelector('input[name*="[cgst]"]').value = '2.5';
        targetRow.querySelector('input[name*="[sgst]"]').value = '2.5';
        
        // Focus on quantity field
        setTimeout(() => {
            const qtyField = targetRow.querySelector('input[name*="[quantity]"]');
            if (qtyField) {
                qtyField.focus();
                qtyField.select();
            }
        }, 100);
    }
    
    closeBatchModal();
}

function closeBatchModal() {
    const modal = document.getElementById('batchSelectionModal');
    if (modal) modal.remove();
    document.removeEventListener('keydown', handleBatchKeys);
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-dialog {
    margin: 2% auto;
    max-width: 1000px;
}

.modal-content {
    background-color: #fefefe;
    padding: 0;
    border-radius: 10px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
}

.modal-header h3 {
    font-size: 1.1rem;
    margin: 0;
}

.modal-body {
    padding: 1rem;
}

.close {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #2c3e50;
    font-size: 0.85rem;
}

.form-group input, .form-group select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.85rem;
}

.product-row {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: #f8f9fa;
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
}

.btn-primary {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid #ddd;
}

.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-search-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.quick-search-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 1rem;
    text-align: center;
}

.quick-search-input {
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.quick-search-input input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.quick-search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
}

.quick-result-item {
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    margin-bottom: 0.25rem;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #f8f9fa;
    border-color: #007bff;
    transform: translateX(4px);
}

.product-name {
    font-weight: 600;
    color: #2c3e50;
}

.product-company {
    font-size: 0.85rem;
    color: #6c757d;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.quick-search-footer {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #eee;
}

.batch-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
}

.batch-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.batch-modal-header {
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
}

.batch-modal-body {
    padding: 1rem;
}

.batch-search {
    margin-bottom: 1rem;
}

.batch-search input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
}

.batch-list {
    max-height: 400px;
    overflow-y: auto;
}

.batch-item {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.batch-item:hover,
.batch-item.batch-selected {
    background: #e8f5e9;
    border-color: #28a745;
}

.batch-no {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.batch-details {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: #6c757d;
}

.batch-modal-footer {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #eee;
}
</style>
{% endblock %}
