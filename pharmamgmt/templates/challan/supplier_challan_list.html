{% extends 'base.html' %}
{% load static %}

{% block title %}Supplier Challan List{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supplier_challan_list.css' %}">
{% endblock %}

{% block content %}
<div class="supplier-challan-container">
    <!-- Header Section -->
    <div class="supplier-challan-header">
        <h1 class="supplier-challan-title">Supplier Challan List</h1>
        <div style="display: flex; gap: 10px;">
            <button id="createInvoiceBtn" class="supplier-challan-add-btn" style="display: none; background: #10b981;" onclick="openCreateInvoiceDialog()">
                <i class="fas fa-file-invoice"></i>
                Create Invoice
            </button>
            <a href="{% url 'add_supplier_challan' %}" class="supplier-challan-add-btn">
                <i class="fas fa-plus"></i>
                Add New Challan
            </a>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="supplier-challan-controls">
        <div class="supplier-challan-search-wrapper">
            <input 
                type="text" 
                class="supplier-challan-search-input" 
                placeholder="Search by challan number, supplier name..."
                id="supplierChallanSearch"
                autocomplete="off"
            >
            <i class="fas fa-search supplier-challan-search-icon"></i>
            <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
        </div>
        <button class="supplier-challan-filter-btn" onclick="toggleFilterPanel()">
            <i class="fas fa-filter"></i>
            Filter
        </button>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel" style="display: none;">
        <div class="filter-header">
            <h3>Filter Challans</h3>
            <button onclick="toggleFilterPanel()" class="close-filter">&times;</button>
        </div>
        <div class="filter-body">
            <div class="filter-group">
                <label>Date From:</label>
                <input type="date" id="filterDateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Date To:</label>
                <input type="date" id="filterDateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Supplier Name:</label>
                <select id="filterSupplier" class="filter-input">
                    <option value="">All Suppliers</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.supplier_name }}">{{ supplier.supplier_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select id="filterStatus" class="filter-input">
                    <option value="">All</option>
                    <option value="paid">Paid</option>
                    <option value="partial">Partial</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>
        </div>
        <div class="filter-footer">
            <button onclick="applyFilters()" class="btn-apply-filter">Apply</button>
            <button onclick="resetFilters()" class="btn-reset-filter">Reset</button>
        </div>
    </div>

    <!-- Challan List Table -->
    <div class="supplier-challan-list-wrapper">
        <table class="supplier-challan-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Challan No.</th>
                    <th>Supplier Name</th>
                    <th>Date</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="supplierChallanTableBody">
                {% if challans %}
                    {% for challan in challans %}
                    <tr>
                        <td><input type="checkbox" class="challan-checkbox" data-challan-id="{{ challan.challan_id }}" data-challan-no="{{ challan.challan_no }}" data-supplier="{{ challan.supplier.supplier_name }}" data-amount="{{ challan.challan_total }}" onchange="updateCreateInvoiceBtn()"></td>
                        <td>{{ challan.challan_no }}</td>
                        <td>{{ challan.supplier.supplier_name }}</td>
                        <td>{{ challan.challan_date|date:"d M, Y" }}</td>
                        <td>₹{{ challan.challan_total|floatformat:2 }}</td>
                        <td>
                            {% if challan.challan_paid >= challan.challan_total %}
                                <span class="badge badge-success">Paid</span>
                            {% elif challan.challan_paid > 0 %}
                                <span class="badge badge-warning">Partial</span>
                            {% else %}
                                <span class="badge badge-danger">Unpaid</span>
                            {% endif %}
                        </td>
                        <td class="action-buttons">
                            <a href="{% url 'view_supplier_challan' challan.challan_id %}" class="btn-action btn-view" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="#" onclick="deleteChallan({{ challan.challan_id }}, '{{ challan.challan_no }}'); return false;" class="btn-action btn-delete" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7">
                            <div class="supplier-challan-empty">
                                <div class="supplier-challan-empty-icon">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                                <div class="supplier-challan-empty-text">No supplier challans found</div>
                                <p style="color: #999; font-size: 14px;">Click "Add New Challan" to create your first supplier challan</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Invoice Dialog -->
<div id="createInvoiceDialog" class="invoice-dialog" style="display: none;">
    <div class="invoice-dialog-content">
        <div class="invoice-dialog-header">
            <h3>Create Invoice from Selected Challans</h3>
            <button onclick="closeCreateInvoiceDialog()" class="close-dialog">&times;</button>
        </div>
        <div class="invoice-dialog-body">
            <div class="selected-challans-section">
                <h4>Selected Challans:</h4>
                <div id="selectedChallansList" class="selected-challans-list"></div>
            </div>
            <div class="invoice-details-section">
                <div class="invoice-field">
                    <label>Invoice No:</label>
                    <input type="text" id="invoiceNo" class="invoice-input" placeholder="Enter invoice number">
                </div>
                <div class="invoice-field">
                    <label>Invoice Date:</label>
                    <input type="date" id="invoiceDate" class="invoice-input">
                </div>
                <div class="invoice-field">
                    <label>Total Amount:</label>
                    <input type="text" id="totalAmount" class="invoice-input" readonly>
                </div>
            </div>
        </div>
        <div class="invoice-dialog-footer">
            <button onclick="saveInvoice()" class="btn-save-invoice">Save Invoice</button>
            <button onclick="closeCreateInvoiceDialog()" class="btn-cancel-invoice">Cancel</button>
        </div>
    </div>
</div>

<style>
.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}
.badge-success {
    background: #10b981;
    color: white;
}
.badge-warning {
    background: #f59e0b;
    color: white;
}
.badge-danger {
    background: #ef4444;
    color: white;
}
.action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
}
.btn-action {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-view {
    background: #3b82f6;
    color: white;
}
.btn-view:hover {
    background: #2563eb;
    transform: translateY(-2px);
}
.btn-delete {
    background: #ef4444;
    color: white;
}
.btn-delete:hover {
    background: #dc2626;
    transform: translateY(-2px);
}

.supplier-challan-search-wrapper {
    position: relative;
}

.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    margin-top: 4px;
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s;
}

.suggestion-item:hover {
    background: #f9fafb;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-challan {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
}

.suggestion-supplier {
    font-size: 13px;
    color: #6b7280;
}

.filter-panel {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.filter-header h3 {
    margin: 0;
    font-size: 18px;
    color: #1f2937;
}

.close-filter {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
}

.filter-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
    font-size: 14px;
}

.filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.filter-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.btn-apply-filter, .btn-reset-filter {
    padding: 8px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-apply-filter {
    background: #3b82f6;
    color: white;
}

.btn-apply-filter:hover {
    background: #2563eb;
}

.btn-reset-filter {
    background: #e5e7eb;
    color: #374151;
}

.btn-reset-filter:hover {
    background: #d1d5db;
}

/* Invoice Dialog Styles */
.invoice-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.invoice-dialog-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.invoice-dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.invoice-dialog-header h3 {
    margin: 0;
    color: #1f2937;
}

.close-dialog {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
}

.invoice-dialog-body {
    padding: 20px;
}

.selected-challans-section {
    margin-bottom: 20px;
}

.selected-challans-section h4 {
    margin: 0 0 10px 0;
    color: #374151;
}

.selected-challans-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px;
}

.selected-challan-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.selected-challan-item:last-child {
    border-bottom: none;
}

.invoice-details-section {
    display: grid;
    gap: 15px;
}

.invoice-field {
    display: flex;
    flex-direction: column;
}

.invoice-field label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #374151;
}

.invoice-input {
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.invoice-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.invoice-dialog-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding: 20px;
    border-top: 1px solid #e5e7eb;
}

.btn-save-invoice, .btn-cancel-invoice {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-save-invoice {
    background: #10b981;
    color: white;
}

.btn-save-invoice:hover {
    background: #059669;
}

.btn-cancel-invoice {
    background: #e5e7eb;
    color: #374151;
}

.btn-cancel-invoice:hover {
    background: #d1d5db;
}
</style>

<script>
    let searchTimeout;
    const allRows = [];
    
    // Store all rows data on page load
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('#supplierChallanTableBody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 1) {
                allRows.push({
                    element: row,
                    challanNo: cells[1].textContent.trim(),
                    supplier: cells[2].textContent.trim(),
                    date: cells[3].textContent.trim(),
                    amount: cells[4].textContent.trim(),
                    status: cells[5].textContent.trim().toLowerCase()
                });
            }
        });
        
        // Set today's date as default
        document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
    });
    
    // Search with suggestions
    document.getElementById('supplierChallanSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (searchTerm.length < 2) {
            document.getElementById('searchSuggestions').style.display = 'none';
            showAllRows();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            const suggestions = getSuggestions(searchTerm);
            displaySuggestions(suggestions);
            filterRows(searchTerm);
        }, 200);
    });
    
    function getSuggestions(term) {
        const lowerTerm = term.toLowerCase();
        const matches = new Set();
        
        allRows.forEach(row => {
            if (row.challanNo.toLowerCase().includes(lowerTerm)) {
                matches.add(JSON.stringify({challanNo: row.challanNo, supplier: row.supplier}));
            }
            if (row.supplier.toLowerCase().includes(lowerTerm)) {
                matches.add(JSON.stringify({challanNo: row.challanNo, supplier: row.supplier}));
            }
        });
        
        return Array.from(matches).slice(0, 5).map(s => JSON.parse(s));
    }
    
    function displaySuggestions(suggestions) {
        const container = document.getElementById('searchSuggestions');
        
        if (suggestions.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.innerHTML = suggestions.map(s => `
            <div class="suggestion-item" onclick="selectSuggestion('${s.challanNo}')">
                <div class="suggestion-challan">${s.challanNo}</div>
                <div class="suggestion-supplier">${s.supplier}</div>
            </div>
        `).join('');
        
        container.style.display = 'block';
    }
    
    function selectSuggestion(challanNo) {
        document.getElementById('supplierChallanSearch').value = challanNo;
        document.getElementById('searchSuggestions').style.display = 'none';
        filterRows(challanNo);
    }
    
    function filterRows(searchTerm) {
        const lowerTerm = searchTerm.toLowerCase();
        
        allRows.forEach(row => {
            const matches = row.challanNo.toLowerCase().includes(lowerTerm) ||
                          row.supplier.toLowerCase().includes(lowerTerm);
            row.element.style.display = matches ? '' : 'none';
        });
    }
    
    function showAllRows() {
        allRows.forEach(row => row.element.style.display = '');
    }
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.supplier-challan-search-wrapper')) {
            document.getElementById('searchSuggestions').style.display = 'none';
        }
    });
    
    // Filter panel toggle
    function toggleFilterPanel() {
        const panel = document.getElementById('filterPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    // Apply filters
    function applyFilters() {
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const status = document.getElementById('filterStatus').value;
        const supplier = document.getElementById('filterSupplier').value;
        
        allRows.forEach(row => {
            let show = true;
            
            // Date filter
            if (dateFrom || dateTo) {
                const rowDate = new Date(row.date);
                if (dateFrom && rowDate < new Date(dateFrom)) show = false;
                if (dateTo && rowDate > new Date(dateTo)) show = false;
            }
            
            // Status filter
            if (status && !row.status.includes(status)) show = false;
            
            // Supplier filter
            if (supplier && row.supplier !== supplier) show = false;
            
            row.element.style.display = show ? '' : 'none';
        });
        
        toggleFilterPanel();
    }
    
    // Reset filters
    function resetFilters() {
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterSupplier').value = '';
        document.getElementById('supplierChallanSearch').value = '';
        showAllRows();
        toggleFilterPanel();
    }
    
    // Delete challan function
    function deleteChallan(challanId, challanNo) {
        if (confirm(`Are you sure you want to delete Challan ${challanNo}?`)) {
            fetch(`/delete-supplier-challan/${challanId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Challan deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting challan');
            });
        }
    }
    
    // Checkbox functions
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.challan-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateCreateInvoiceBtn();
    }
    
    function updateCreateInvoiceBtn() {
        const selectedCheckboxes = document.querySelectorAll('.challan-checkbox:checked');
        const createBtn = document.getElementById('createInvoiceBtn');
        
        if (selectedCheckboxes.length > 0) {
            createBtn.style.display = 'flex';
        } else {
            createBtn.style.display = 'none';
        }
    }
    
    // Dialog functions
    function openCreateInvoiceDialog() {
        const selectedCheckboxes = document.querySelectorAll('.challan-checkbox:checked');
        const selectedChallansList = document.getElementById('selectedChallansList');
        let totalAmount = 0;
        
        selectedChallansList.innerHTML = '';
        
        selectedCheckboxes.forEach(checkbox => {
            const challanNo = checkbox.dataset.challanNo;
            const supplier = checkbox.dataset.supplier;
            const amount = parseFloat(checkbox.dataset.amount);
            
            totalAmount += amount;
            
            const challanItem = document.createElement('div');
            challanItem.className = 'selected-challan-item';
            challanItem.innerHTML = `
                <span><strong>${challanNo}</strong> - ${supplier}</span>
                <span>₹${amount.toFixed(2)}</span>
            `;
            selectedChallansList.appendChild(challanItem);
        });
        
        document.getElementById('totalAmount').value = `₹${totalAmount.toFixed(2)}`;
        document.getElementById('createInvoiceDialog').style.display = 'flex';
    }
    
    function closeCreateInvoiceDialog() {
        document.getElementById('createInvoiceDialog').style.display = 'none';
        document.getElementById('invoiceNo').value = '';
    }
    
    function saveInvoice() {
        const invoiceNo = document.getElementById('invoiceNo').value.trim();
        const invoiceDate = document.getElementById('invoiceDate').value;
        
        if (!invoiceNo) {
            alert('Please enter invoice number');
            return;
        }
        
        if (!invoiceDate) {
            alert('Please select invoice date');
            return;
        }
        
        const selectedCheckboxes = document.querySelectorAll('.challan-checkbox:checked');
        const selectedChallanIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.challanId);
        
        // Show loading state
        const saveBtn = document.querySelector('.btn-save-invoice');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Creating Invoice...';
        
        // Send data to server
        const formData = new FormData();
        formData.append('invoice_no', invoiceNo);
        formData.append('invoice_date', invoiceDate);
        formData.append('challan_ids', JSON.stringify(selectedChallanIds));
        
        fetch('/create-invoice-from-challans/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeCreateInvoiceDialog();
                
                // Reload page to remove invoiced challans from list
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating invoice');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Invoice';
        });
    }
</script>
{% endblock %}
