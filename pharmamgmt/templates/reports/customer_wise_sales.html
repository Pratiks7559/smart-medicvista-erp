{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customer_wise_sales.css' %}">
{% endblock %}

{% block content %}
<div class="cws-container">
    <div class="cws-page-header">
        <div class="cws-header-content">
            <div class="cws-title-section">
                <h4 class="cws-page-title">üìä Customer Wise Sales Report</h4>
                <p class="cws-page-subtitle">Analyze sales performance by customer with date filters</p>
            </div>
            <div class="cws-header-actions" id="cwsHeaderActions" style="display: none;">
                <button class="cws-export-btn cws-pdf-btn" onclick="exportReport('pdf')" title="Export PDF (Ctrl+Q)">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="cws-export-btn cws-excel-btn" onclick="exportReport('excel')" title="Export Excel (Ctrl+E)">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="cws-export-btn cws-print-btn" onclick="printReport()" title="Print (Ctrl+P)">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <!-- Search Filters -->
    <div class="cws-search-container">
        <form method="GET" id="cwsSalesReportForm">
            {% csrf_token %}
            <div class="cws-filters-grid">
                <div class="cws-filter-group">
                    <label class="cws-filter-label">Customer</label>
                    <div class="cws-customer-select-wrapper">
                        <select name="customer_id" id="cwsCustomerSelect" class="cws-filter-input cws-customer-select" required>
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.customerid }}" 
                                    {% if customer.customerid|stringformat:"s" == selected_customer_id %}selected{% endif %}>
                                {{ customer.customer_name }} - {{ customer.customer_mobile }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="cws-quick-search-btn" onclick="openQuickCustomerSearch()">
                            üîç Quick Search (Ctrl+F2)
                        </button>
                    </div>
                </div>
                
                <div class="cws-filter-group">
                    <label class="cws-filter-label">From Date</label>
                    <input type="date" name="from_date" class="cws-filter-input" 
                           value="{{ from_date }}" required>
                </div>
                
                <div class="cws-filter-group">
                    <label class="cws-filter-label">To Date</label>
                    <input type="date" name="to_date" class="cws-filter-input" 
                           value="{{ to_date }}" required>
                </div>
                
                <div class="cws-filter-group">
                    <button type="submit" class="cws-generate-btn">
                        üìà Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% if selected_customer %}
    <!-- Sales Summary -->
    <div class="cws-summary-container">
        <h5 class="cws-summary-title">üìã Sales Summary for {{ selected_customer.customer_name }}</h5>
        <div class="cws-summary-grid">
            <div class="cws-summary-card">
                <div class="cws-summary-value">{{ summary.total_invoices }}</div>
                <div class="cws-summary-label">Total Invoices</div>
            </div>
            <div class="cws-summary-card">
                <div class="cws-summary-value">‚Çπ{{ summary.grand_total|floatformat:2 }}</div>
                <div class="cws-summary-label">Total Sales Amount</div>
            </div>
            <div class="cws-summary-card">
                <div class="cws-summary-value">{{ summary.grand_quantity|floatformat:0 }}</div>
                <div class="cws-summary-label">Total Quantity</div>
            </div>
            <div class="cws-summary-card">
                <div class="cws-summary-value">‚Çπ{{ summary.challan_amount|floatformat:2 }}</div>
                <div class="cws-summary-label">Challan Sales</div>
            </div>
        </div>

        <!-- Sales Invoices -->
        {% if sales_data %}
        <h6 class="cws-section-title">üíº Sales Invoices</h6>
        <div class="cws-table-container">
            <table class="cws-table">
                <thead>
                    <tr>
                        <th>Invoice No</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Quantity</th>
                        <th>Amount</th>
                        <th>Balance Due</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_data %}
                    <tr>
                        <td>
                            <strong class="cws-invoice-number">{{ sale.invoice.sales_invoice_no }}</strong>
                            <div class="cws-invoice-items">
                                {% for item in sale.items %}
                                {{ item.product_name }} ({{ item.product_batch_no }}){% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        <td>{{ sale.invoice.sales_invoice_date|date:"d-m-Y" }}</td>
                        <td>{{ sale.items|length }} items</td>
                        <td>{{ sale.invoice_qty|floatformat:0 }}</td>
                        <td class="cws-amount">‚Çπ{{ sale.invoice_total|floatformat:2 }}</td>
                        <td class="cws-balance-due">‚Çπ{{ sale.balance_due|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Customer Challans -->
        {% if customer_challans %}
        <h6 class="cws-section-title">üìã Customer Challans</h6>
        <div class="cws-table-container">
            <table class="cws-table">
                <thead>
                    <tr>
                        <th>Challan No</th>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Batch</th>
                        <th>Quantity</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for challan in customer_challans %}
                    <tr>
                        <td>{{ challan.customer_challan_no }}</td>
                        <td>{{ challan.sales_entry_date|date:"d-m-Y" }}</td>
                        <td>{{ challan.product_name }}</td>
                        <td>{{ challan.product_batch_no }}</td>
                        <td>{{ challan.sale_quantity|floatformat:0 }}</td>
                        <td class="cws-amount">‚Çπ{{ challan.sale_total_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if error %}
    <div class="cws-error">{{ error }}</div>
    {% endif %}
</div>

<!-- Quick Customer Search Modal -->
<div id="cwsQuickCustomerSearchModal" class="cws-modal-overlay">
    <div class="cws-modal-content">
        <div class="cws-modal-header">
            <h5 class="cws-modal-title">üîç Quick Customer Search</h5>
            <input type="text" id="cwsQuickSearchInput" class="cws-search-input" 
                   placeholder="Type customer name, mobile, or GST number...">
            <div class="cws-shortcut-hint">‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</div>
        </div>
        <div class="cws-search-results" id="cwsQuickSearchResults">
            <div class="cws-search-message">
                Type at least 2 characters to search...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Quick Customer Search Functionality
let selectedCustomerIndex = -1;

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+F2: Open quick customer search
    if (e.ctrlKey && e.key === 'F2') {
        e.preventDefault();
        openQuickCustomerSearch();
    }
    
    // Ctrl+Q: Export PDF
    if (e.ctrlKey && e.key === 'q') {
        e.preventDefault();
        exportReport('pdf');
    }
    
    // Ctrl+E: Export Excel
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportReport('excel');
    }
    
    // Ctrl+P: Print
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printReport();
    }
    
    // Escape: Close modal
    if (e.key === 'Escape') {
        closeQuickCustomerSearch();
    }
});

function openQuickCustomerSearch() {
    document.getElementById('cwsQuickCustomerSearchModal').style.display = 'flex';
    document.getElementById('cwsQuickSearchInput').focus();
    selectedCustomerIndex = -1;
}

function closeQuickCustomerSearch() {
    document.getElementById('cwsQuickCustomerSearchModal').style.display = 'none';
    document.getElementById('cwsQuickSearchInput').value = '';
    document.getElementById('cwsQuickSearchResults').innerHTML = 
        '<div class="cws-search-message">Type at least 2 characters to search...</div>';
}

// Search customers
document.getElementById('cwsQuickSearchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    
    if (searchTerm.length < 2) {
        document.getElementById('cwsQuickSearchResults').innerHTML = 
            '<div class="cws-search-message">Type at least 2 characters to search...</div>';
        return;
    }
    
    // Show loading
    document.getElementById('cwsQuickSearchResults').innerHTML = 
        '<div class="cws-loading"><i class="fas fa-spinner cws-spinner"></i> Searching...</div>';
    
    // Search API call
    fetch(`/api/quick-customer-search/?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCustomerResults(data.customers);
            } else {
                document.getElementById('cwsQuickSearchResults').innerHTML = 
                    '<div class="cws-search-message">Error searching customers</div>';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            document.getElementById('cwsQuickSearchResults').innerHTML = 
                '<div class="cws-search-message">Search failed</div>';
        });
});

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('cwsQuickSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = 
            '<div class="cws-search-message">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach((customer, index) => {
        html += `
            <div class="cws-customer-result ${index === 0 ? 'cws-selected' : ''}" 
                 onclick="selectCustomer(${customer.customerid}, '${customer.customer_name}')"
                 data-index="${index}">
                <div class="cws-customer-name">${customer.customer_name}</div>
                <div class="cws-customer-details">
                    Mobile: ${customer.customer_mobile} | GST: ${customer.customer_gstno} | Type: ${customer.customer_type}
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
    selectedCustomerIndex = 0;
}

// Keyboard navigation in search results
document.getElementById('cwsQuickSearchInput').addEventListener('keydown', function(e) {
    const results = document.querySelectorAll('.cws-customer-result');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selectedCustomerIndex < results.length - 1) {
            results[selectedCustomerIndex]?.classList.remove('cws-selected');
            selectedCustomerIndex++;
            results[selectedCustomerIndex]?.classList.add('cws-selected');
            results[selectedCustomerIndex]?.scrollIntoView({ block: 'nearest' });
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selectedCustomerIndex > 0) {
            results[selectedCustomerIndex]?.classList.remove('cws-selected');
            selectedCustomerIndex--;
            results[selectedCustomerIndex]?.classList.add('cws-selected');
            results[selectedCustomerIndex]?.scrollIntoView({ block: 'nearest' });
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedCustomerIndex >= 0 && results[selectedCustomerIndex]) {
            results[selectedCustomerIndex].click();
        }
    }
});

function selectCustomer(customerId, customerName) {
    // Set customer in dropdown
    document.getElementById('cwsCustomerSelect').value = customerId;
    
    // Close modal
    closeQuickCustomerSearch();
    
    // Show success message
    alert(`Customer "${customerName}" selected!`);
    
    // Focus on from date
    document.querySelector('input[name="from_date"]').focus();
}

// Close modal when clicking outside
document.getElementById('cwsQuickCustomerSearchModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQuickCustomerSearch();
    }
});

// Set default dates (last 30 days)
document.addEventListener('DOMContentLoaded', function() {
    const fromDateInput = document.querySelector('input[name="from_date"]');
    const toDateInput = document.querySelector('input[name="to_date"]');
    
    if (!fromDateInput.value) {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        fromDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        toDateInput.value = today.toISOString().split('T')[0];
    }
    
    // Show export buttons if data is available
    if (document.querySelector('.cws-summary-container')) {
        document.getElementById('cwsHeaderActions').style.display = 'flex';
    }
});

// Export functions
function exportReport(format) {
    const customerId = document.getElementById('cwsCustomerSelect').value;
    const fromDate = document.querySelector('input[name="from_date"]').value;
    const toDate = document.querySelector('input[name="to_date"]').value;
    
    if (!customerId || !fromDate || !toDate) {
        alert('Please select customer and date range first');
        return;
    }
    
    const exportUrl = `/reports/customer-sales/?customer_id=${customerId}&from_date=${fromDate}&to_date=${toDate}&export=${format}`;
    
    if (format === 'pdf') {
        fetch(exportUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customer_sales_${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => {
                window.open(url, '_blank');
                window.URL.revokeObjectURL(url);
            }, 500);
        })
        .catch(error => {
            alert('Export failed. Please try again.');
        });
    } else {
        fetch(exportUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customer_sales_${new Date().toISOString().slice(0, 10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Export failed. Please try again.');
        });
    }
}

function printReport() {
    window.print();
}
</script>
{% endblock %}