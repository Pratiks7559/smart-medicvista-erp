{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/financial_report_modern.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
{% endblock %}

{% block content %}
<div class="finrep-container">
    <div class="finrep-header">
        <h1 class="finrep-title">{{ title }}</h1>
        <div class="finrep-actions no-print">
            <a href="{% url 'export_financial_pdf' %}" class="finrep-btn finrep-btn-pdf">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="{% url 'export_financial_excel' %}" class="finrep-btn finrep-btn-excel">
                <i class="fas fa-file-csv"></i> Excel
            </a>
            <button onclick="window.print()" class="finrep-btn finrep-btn-print">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="finrep-datecard">
        <div class="finrep-datecard-header">
            <h6 class="finrep-datecard-title">Select Date Range</h6>
        </div>
        <div class="finrep-datecard-body">
            <form method="get" class="finrep-dateform">
                <div class="finrep-dateinputs">
                    <div class="finrep-dategroup">
                        <label for="start_date" class="finrep-datelabel">Start Date</label>
                        <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="finrep-dateinput">
                    </div>
                    <div class="finrep-dategroup">
                        <label for="end_date" class="finrep-datelabel">End Date</label>
                        <input type="date" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="finrep-dateinput">
                    </div>
                </div>
                <button type="submit" class="finrep-applybtn">Apply</button>
            </form>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="finrep-summary">
        <div class="finrep-summarycard">
            <div class="finrep-summarycard-body">
                <div class="finrep-summarycard-content">
                    <div class="finrep-summarycard-text">
                        <div class="finrep-summarycard-label">Gross Sales</div>
                        <div class="finrep-summarycard-value">₹ {{ sales|floatformat:2 }}</div>
                        <small class="finrep-summarycard-meta">{{ sales_data.invoice_count }} invoices</small>
                    </div>
                    <div class="finrep-summarycard-icon">
                        <i class="fas fa-cart-plus"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="finrep-summarycard">
            <div class="finrep-summarycard-body">
                <div class="finrep-summarycard-content">
                    <div class="finrep-summarycard-text">
                        <div class="finrep-summarycard-label">Gross Purchases</div>
                        <div class="finrep-summarycard-value">₹ {{ purchases|floatformat:2 }}</div>
                        <small class="finrep-summarycard-meta">{{ purchase_data.invoice_count }} invoices</small>
                    </div>
                    <div class="finrep-summarycard-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="finrep-summarycard finrep-summarycard-warning">
            <div class="finrep-summarycard-body">
                <div class="finrep-summarycard-content">
                    <div class="finrep-summarycard-text">
                        <div class="finrep-summarycard-label">Sales Returns</div>
                        <div class="finrep-summarycard-value">₹ {{ sales_returns|floatformat:2 }}</div>
                    </div>
                    <div class="finrep-summarycard-icon">
                        <i class="fas fa-undo"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="finrep-summarycard finrep-summarycard-info">
            <div class="finrep-summarycard-body">
                <div class="finrep-summarycard-content">
                    <div class="finrep-summarycard-text">
                        <div class="finrep-summarycard-label">Purchase Returns</div>
                        <div class="finrep-summarycard-value">₹ {{ purchase_returns|floatformat:2 }}</div>
                    </div>
                    <div class="finrep-summarycard-icon">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Net Figures -->
    <div class="financial-net-figures-row">
        <div class="financial-net-sales-col">
            <div class="financial-net-sales-card">
                <div class="financial-net-sales-body">
                    <div class="financial-net-sales-content">
                        <div class="financial-net-sales-text">
                            <div class="financial-net-sales-label">
                                Net Sales (After Returns)</div>
                            <div class="financial-net-sales-value">₹ {{ net_sales|floatformat:2 }}</div>
                        </div>
                        <div class="financial-net-sales-icon">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="financial-net-purchases-col">
            <div class="financial-net-purchases-card">
                <div class="financial-net-purchases-body">
                    <div class="financial-net-purchases-content">
                        <div class="financial-net-purchases-text">
                            <div class="financial-net-purchases-label">
                                Net Purchases (After Returns)</div>
                            <div class="financial-net-purchases-value">₹ {{ net_purchases|floatformat:2 }}</div>
                        </div>
                        <div class="financial-net-purchases-icon">
                            <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gross Profit -->
    <div class="financial-gross-profit-row">
        <div class="financial-gross-profit-col">
            <div class="financial-gross-profit-card">
                <div class="financial-gross-profit-body">
                    <div class="financial-gross-profit-content">
                        <div class="financial-gross-profit-text">
                            <div class="financial-gross-profit-label">
                                Gross Profit</div>
                            <div class="financial-gross-profit-value {% if gross_profit > 0 %}financial-profit{% else %}financial-loss{% endif %}">
                                ₹ {{ gross_profit|floatformat:2 }}
                                {% if gross_profit > 0 %}
                                <small class="financial-profit-indicator">(Profit)</small>
                                {% else %}
                                <small class="financial-loss-indicator">(Loss)</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="financial-gross-profit-icon">
                            <i class="fas {% if gross_profit > 0 %}fa-smile{% else %}fa-frown{% endif %} fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row financial-section">
        <div class="col-md-3">
            <div class="financial-kpi-card">
                <div class="financial-metric-value">{{ profit_margin|floatformat:1 }}%</div>
                <div class="financial-metric-label">Profit Margin</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-kpi-card">
                <div class="financial-metric-value">{{ inventory_turnover|floatformat:1 }}</div>
                <div class="financial-metric-label">Inventory Turnover</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-kpi-card">
                <div class="financial-metric-value">{{ days_sales_outstanding|floatformat:0 }}</div>
                <div class="financial-metric-label">Days Sales Outstanding</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-kpi-card">
                <div class="financial-metric-value">{{ sales_data.collection_ratio|floatformat:1 }}%</div>
                <div class="financial-metric-label">Collection Ratio</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row financial-section">
        <div class="col-md-6">
            <div class="financial-chart-card">
                <div class="financial-chart-header">
                    <h6 class="financial-chart-title">Monthly Sales vs Purchases</h6>
                </div>
                <div class="financial-chart-body">
                    <div class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="financial-chart-card">
                <div class="financial-chart-header">
                    <h6 class="financial-chart-title">Cash Flow Trend</h6>
                </div>
                <div class="financial-chart-body">
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers Section -->
    <div class="financial-section">
        <h3>Top Performers</h3>
        <div class="row">
            <div class="col-md-4">
                <div class="financial-table">
                    <div class="card-header">
                        <h6>Top Products by Sales</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Sales (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in top_performers.products|slice:":5" %}
                                <tr>
                                    <td>{{ product.productid__product_name|truncatechars:20 }}</td>
                                    <td>₹{{ product.total_sales|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="financial-table">
                    <div class="card-header">
                        <h6>Top Customers</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Purchase (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in top_performers.customers|slice:":5" %}
                                <tr>
                                    <td>{{ customer.customerid__customer_name|truncatechars:20 }}</td>
                                    <td>₹{{ customer.total_purchase|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="financial-table">
                    <div class="card-header">
                        <h6>Top Suppliers</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>Purchase (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for supplier in top_performers.suppliers|slice:":5" %}
                                <tr>
                                    <td>{{ supplier.product_supplierid__supplier_name|truncatechars:20 }}</td>
                                    <td>₹{{ supplier.total_purchase|floatformat:0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Metrics -->
    <div class="financial-section">
        <h3>Inventory Overview</h3>
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">₹{{ inventory_metrics.total_stock_value|floatformat:0 }}</h5>
                        <p class="card-text">Total Stock Value</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">{{ inventory_metrics.total_items }}</h5>
                        <p class="card-text">Total Items</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ inventory_metrics.low_stock_items }}</h5>
                        <p class="card-text">Low Stock Items</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">{{ inventory_metrics.expired_items }}</h5>
                        <p class="card-text">Expired Items</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Outstanding Amounts -->
    <div class="financial-outstanding-row">
        <div class="financial-outstanding-col">
            <div class="financial-outstanding-card">
                <div class="financial-outstanding-header">
                    <h6 class="financial-outstanding-title">Outstanding Receivables (Top Customers)</h6>
                </div>
                <div class="financial-outstanding-body">
                    <div class="financial-table-wrapper">
                        <table id="receivablesTable" class="financial-receivables-table" width="100%" cellspacing="0">
                            <thead class="financial-receivables-thead">
                                <tr class="financial-receivables-header-row">
                                    <th class="financial-receivables-customer-header">Customer</th>
                                    <th class="financial-receivables-amount-header">Outstanding Amount</th>
                                </tr>
                            </thead>
                            <tbody class="financial-receivables-tbody">
                                {% for item in outstanding_receivables %}
                                <tr class="financial-receivables-row">
                                    <td class="financial-receivables-customer-cell">{{ item.customer_name }}</td>
                                    <td class="financial-receivables-amount-cell">₹ {{ item.outstanding|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr class="financial-receivables-empty-row">
                                    <td colspan="2" class="financial-receivables-no-data">No outstanding receivables</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="financial-receivables-tfoot">
                                <tr class="financial-receivables-total-row">
                                    <th class="financial-receivables-total-label">Total Receivables:</th>
                                    <th class="financial-receivables-total-value">₹ {{ total_receivables|floatformat:2 }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="financial-outstanding-col">
            <div class="financial-outstanding-card">
                <div class="financial-outstanding-header">
                    <h6 class="financial-outstanding-title">Outstanding Payables (Top Suppliers)</h6>
                </div>
                <div class="financial-outstanding-body">
                    <div class="financial-table-wrapper">
                        <table id="payablesTable" class="financial-payables-table" width="100%" cellspacing="0">
                            <thead class="financial-payables-thead">
                                <tr class="financial-payables-header-row">
                                    <th class="financial-payables-supplier-header">Supplier</th>
                                    <th class="financial-payables-amount-header">Outstanding Amount</th>
                                </tr>
                            </thead>
                            <tbody class="financial-payables-tbody">
                                {% for item in outstanding_payables %}
                                <tr class="financial-payables-row">
                                    <td class="financial-payables-supplier-cell">{{ item.supplier_name }}</td>
                                    <td class="financial-payables-amount-cell">₹ {{ item.outstanding|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr class="financial-payables-empty-row">
                                    <td colspan="2" class="financial-payables-no-data">No outstanding payables</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="financial-payables-tfoot">
                                <tr class="financial-payables-total-row">
                                    <th class="financial-payables-total-label">Total Payables:</th>
                                    <th class="financial-payables-total-value">₹ {{ total_payables|floatformat:2 }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize DataTables
        $('#receivablesTable').DataTable({
            "order": [[1, "desc"]],
            "pageLength": 10,
            "responsive": true
        });
        
        $('#payablesTable').DataTable({
            "order": [[1, "desc"]],
            "pageLength": 10,
            "responsive": true
        });

        // Monthly Sales vs Purchases Chart
        var monthlyLabels = [
            {% for item in monthly_sales %}
                "{{ item.month|date:'M Y' }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        var monthlySalesData = [
            {% for item in monthly_sales %}
                {{ item.total|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        var monthlyPurchasesData = [
            {% for item in monthly_purchases %}
                {{ item.total|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        var ctx1 = document.getElementById('monthlySalesChart').getContext('2d');
        var monthlySalesChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Sales',
                    data: monthlySalesData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Purchases',
                    data: monthlyPurchasesData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ₹' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Cash Flow Chart
        var cashFlowLabels = [
            {% for item in cash_flow_data.daily_inflow %}
                "{{ item.date|date:'M d' }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        var inflowData = [
            {% for item in cash_flow_data.daily_inflow %}
                {{ item.amount|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        var outflowData = [
            {% for item in cash_flow_data.daily_outflow %}
                {{ item.amount|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        var ctx2 = document.getElementById('cashFlowChart').getContext('2d');
        var cashFlowChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: cashFlowLabels,
                datasets: [{
                    label: 'Cash Inflow',
                    data: inflowData,
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }, {
                    label: 'Cash Outflow',
                    data: outflowData,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ₹' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Auto-refresh data every 5 minutes
        setInterval(function() {
            $.ajax({
                url: '{% url "financial_dashboard_api" %}',
                method: 'GET',
                success: function(data) {
                    // Update key metrics without full page reload
                    console.log('Financial data refreshed:', data);
                },
                error: function(xhr, status, error) {
                    console.error('Error refreshing financial data:', error);
                }
            });
        }, 300000); // 5 minutes
    });
</script>
{% endblock %}







