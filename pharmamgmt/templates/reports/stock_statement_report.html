{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_statement_report.css' %}">
<style>
@media print {
    /* Reset */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    body * { visibility: hidden; }
    .stock-statement-container, .stock-statement-container * { visibility: visible; }
    .stock-statement-container { position: absolute; left: 0; top: 0; width: 100%; }
    
    /* Hide unnecessary elements */
    .filters-section, .header-actions, .no-print, .pagination-container, .col-actions, .btn-action { display: none !important; }
    
    /* Page setup */
    @page { 
        size: A4 landscape;
        margin: 0.3in 0.25in;
    }
    
    body { 
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .stock-statement-container {
        padding: 0 !important;
        background: white !important;
    }
    
    /* Modern Header - Compact */
    .report-header {
        background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
        color: white !important;
        padding: 12px 15px !important;
        margin-bottom: 10px !important;
        border-radius: 0 !important;
        text-align: center !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .report-title {
        font-size: 18px !important;
        font-weight: 700 !important;
        margin: 0 !important;
        color: white !important;
    }
    
    .header-content {
        text-align: center !important;
    }
    
    /* Summary Cards - Compact Grid */
    .summary-cards {
        display: grid !important;
        grid-template-columns: repeat(5, 1fr) !important;
        gap: 6px !important;
        margin-bottom: 10px !important;
        page-break-inside: avoid;
    }
    
    .summary-card {
        background: white !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 4px !important;
        padding: 6px 8px !important;
        text-align: center !important;
        page-break-inside: avoid;
    }
    
    .summary-card.opening { border-left: 3px solid #6366f1 !important; }
    .summary-card.received { border-left: 3px solid #10b981 !important; }
    .summary-card.sold { border-left: 3px solid #f59e0b !important; }
    .summary-card.balance { border-left: 3px solid #8b5cf6 !important; }
    .summary-card.value { border-left: 3px solid #06b6d4 !important; }
    
    .card-value {
        font-size: 14px !important;
        font-weight: 700 !important;
        color: #111827 !important;
        margin: 2px 0 !important;
    }
    
    .card-content h3 {
        font-size: 9px !important;
        color: #6b7280 !important;
        margin: 0 0 2px 0 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        font-weight: 600 !important;
    }
    
    .card-icon {
        font-size: 16px !important;
        opacity: 0.2 !important;
    }
    
    /* Table Header - Compact */
    .table-header {
        background: #f3f4f6 !important;
        padding: 6px 10px !important;
        border-radius: 4px !important;
        margin-bottom: 6px !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .table-header h2 {
        font-size: 13px !important;
        font-weight: 600 !important;
        color: #374151 !important;
        margin: 0 !important;
    }
    
    .table-info {
        font-size: 10px !important;
        color: #6b7280 !important;
    }
    
    /* Modern Table - Ultra Compact */
    .table-container { page-break-inside: auto; }
    .table-wrapper { overflow: visible !important; }
    
    .stock-table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 7px !important;
        margin-top: 0 !important;
        page-break-inside: auto;
    }
    
    .stock-table thead {
        background: #6366f1 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        display: table-header-group;
    }
    
    .stock-table th {
        padding: 4px 2px !important;
        font-size: 8px !important;
        font-weight: 600 !important;
        text-align: left !important;
        border: 1px solid #4f46e5 !important;
        line-height: 1.2 !important;
    }
    
    .stock-table td {
        padding: 3px 2px !important;
        font-size: 7px !important;
        border: 1px solid #e5e7eb !important;
        vertical-align: top !important;
        line-height: 1.3 !important;
    }
    
    .stock-table tbody tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
    
    .stock-table tbody tr:nth-child(even) {
        background: #f9fafb !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Product Info - Compact */
    .product-info {
        font-size: 7px !important;
    }
    
    .product-name {
        font-weight: 600 !important;
        font-size: 7.5px !important;
        margin-bottom: 1px !important;
    }
    
    .product-details {
        font-size: 6.5px !important;
        color: #6b7280 !important;
    }
    
    .product-details span {
        margin-right: 4px !important;
        font-size: 6.5px !important;
    }
    
    /* Stock Values */
    .stock-value {
        font-size: 7px !important;
        font-weight: 600 !important;
    }
    
    .stock-value.positive { color: #10b981 !important; }
    .stock-value.negative { color: #ef4444 !important; }
    .stock-value.zero { color: #dc2626 !important; }
    .stock-value.low { color: #f59e0b !important; }
    .stock-value.normal { color: #111827 !important; }
    
    .currency-value {
        font-size: 7px !important;
    }
    
    /* Status Badges - Compact */
    .status-badge {
        padding: 2px 4px !important;
        border-radius: 2px !important;
        font-size: 7px !important;
        font-weight: 600 !important;
        display: inline-block !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .status-badge.status-in-stock,
    .status-badge.in-stock {
        background: #d1fae5 !important;
        color: #065f46 !important;
    }
    
    .status-badge.status-low-stock,
    .status-badge.low-stock {
        background: #fef3c7 !important;
        color: #92400e !important;
    }
    
    .status-badge.status-out-of-stock,
    .status-badge.out-of-stock {
        background: #fee2e2 !important;
        color: #991b1b !important;
    }
    
    /* No Data Message */
    .no-data {
        text-align: center !important;
        padding: 20px !important;
    }
    
    .no-data-message {
        font-size: 10px !important;
        color: #6b7280 !important;
    }
    
    /* Print Footer */
    .print-footer {
        margin-top: 10px !important;
        padding-top: 6px !important;
        border-top: 1px solid #e5e7eb !important;
        text-align: center !important;
        font-size: 8px !important;
        color: #6b7280 !important;
        page-break-inside: avoid !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="stock-statement-container">
    <!-- Header Section -->
    <div class="report-header">
        <div class="header-content">
            <h1 class="report-title">
                <i class="fas fa-warehouse"></i>
                Stock Statement Report
            </h1>
            <div class="header-actions">
                <a href="{% url 'export_stock_statement_pdf' %}" class="btn btn-export" title="Export PDF">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </a>
                <button class="btn btn-export" onclick="exportReport('excel')" title="Export Excel (Ctrl+E)">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="btn btn-print" onclick="printReport()" title="Print (Ctrl+P)">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <form method="GET" class="filters-form" id="filtersForm">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search">Search Products</label>
                    <input type="text" 
                           id="search" 
                           name="search" 
                           value="" 
                           placeholder="Product name, company, salt, barcode..."
                           class="filter-input"
                           autocomplete="off">
                </div>
                
                <div class="filter-group">
                    <label for="category">Category</label>
                    <select id="category" name="category" class="filter-select">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="company">Company</label>
                    <select id="company" name="company" class="filter-select">
                        <option value="">All Companies</option>
                        {% for company in companies %}
                        <option value="{{ company }}" {% if company == company_filter %}selected{% endif %}>
                            {{ company }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="stock_status">Stock Status</label>
                    <select id="stock_status" name="stock_status" class="filter-select">
                        <option value="all" {% if stock_status == 'all' %}selected{% endif %}>All Status</option>
                        <option value="in_stock" {% if stock_status == 'in_stock' %}selected{% endif %}>In Stock</option>
                        <option value="low_stock" {% if stock_status == 'low_stock' %}selected{% endif %}>Low Stock</option>
                        <option value="out_of_stock" {% if stock_status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label for="date_from">Date From</label>
                    <input type="date" 
                           id="date_from" 
                           name="date_from" 
                           value="{{ date_from }}" 
                           class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label for="date_to">Date To</label>
                    <input type="date" 
                           id="date_to" 
                           name="date_to" 
                           value="{{ date_to }}" 
                           class="filter-input">
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="card-icon opening">
                <i class="fas fa-box-open"></i>
            </div>
            <div class="card-content">
                <h3>Opening Stock</h3>
                <p class="card-value">{{ totals.opening|floatformat:0 }}</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon received">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="card-content">
                <h3>Received</h3>
                <p class="card-value">{{ totals.received|floatformat:0 }}</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon sold">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="card-content">
                <h3>Sold</h3>
                <p class="card-value">{{ totals.sold|floatformat:0 }}</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon balance">
                <i class="fas fa-warehouse"></i>
            </div>
            <div class="card-content">
                <h3>Current Balance</h3>
                <p class="card-value">{{ totals.balance|floatformat:0 }}</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon value">
                <i class="fas fa-rupee-sign"></i>
            </div>
            <div class="card-content">
                <h3>Stock Value</h3>
                <p class="card-value">₹{{ totals.value|floatformat:2 }}</p>
            </div>
        </div>
    </div>

    <!-- Stock Statement Table -->
    <div class="table-container">
        <div class="table-header">
            <h2>Stock Statement Details</h2>
            <div class="table-info">
                Showing {{ stock_data|length }} products
            </div>
        </div>
        
        <div class="table-wrapper">
            <table class="stock-table" id="stockTable">
                <thead>
                    <tr>
                        <th class="col-product">Product Details</th>
                        <th class="col-opening">Opening</th>
                        <th class="col-received">Received</th>
                        <th class="col-sold">Sold</th>
                        <th class="col-balance">Balance</th>
                        <th class="col-mrp">Avg MRP</th>
                        <th class="col-value">Stock Value</th>
                        <th class="col-status">Status</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stock_data %}
                    <tr class="stock-row" data-product-id="{{ item.product.productid }}">
                        <td class="col-product">
                            <div class="product-info">
                                <div class="product-name">{{ item.product.product_name }}</div>
                                <div class="product-details">
                                    <span class="company">{{ item.product.product_company }}</span>
                                    {% if item.product.product_packing %}
                                    <span class="packing">{{ item.product.product_packing }}</span>
                                    {% endif %}
                                    {% if item.product.product_category %}
                                    <span class="category">{{ item.product.product_category }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="col-opening">
                            <span class="stock-value">{{ item.opening_stock|floatformat:0 }}</span>
                        </td>
                        <td class="col-received">
                            <span class="stock-value positive">{{ item.received_stock|floatformat:0 }}</span>
                        </td>
                        <td class="col-sold">
                            <span class="stock-value negative">{{ item.sold_stock|floatformat:0 }}</span>
                        </td>
                        <td class="col-balance">
                            <span class="stock-value {% if item.balance_stock <= 0 %}zero{% elif item.balance_stock < 10 %}low{% else %}normal{% endif %}">
                                {{ item.balance_stock|floatformat:0 }}
                            </span>
                        </td>
                        <td class="col-mrp">
                            <span class="currency-value">₹{{ item.avg_mrp|floatformat:2 }}</span>
                        </td>
                        <td class="col-value">
                            <span class="currency-value">₹{{ item.stock_value|floatformat:2 }}</span>
                        </td>
                        <td class="col-status">
                            <span class="status-badge status-{{ item.status_class }}">
                                {{ item.status_label }}
                            </span>
                        </td>
                        <td class="col-actions">
                            <button class="btn-action" 
                                    onclick="viewBatchDetails({{ item.product.productid }})"
                                    title="View Batch Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action" 
                                    onclick="viewProductDetail({{ item.product.productid }})"
                                    title="Product Details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="no-data">
                            <div class="no-data-message">
                                <i class="fas fa-search"></i>
                                <p>No products found matching your criteria.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if products_page.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination-info">
            Page {{ products_page.number }} of {{ products_page.paginator.num_pages }}
            ({{ products_page.paginator.count }} total products)
        </div>
        
        <div class="pagination">
            {% if products_page.has_previous %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" 
               class="page-link">First</a>
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products_page.previous_page_number }}" 
               class="page-link">Previous</a>
            {% endif %}
            
            <span class="page-current">{{ products_page.number }}</span>
            
            {% if products_page.has_next %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products_page.next_page_number }}" 
               class="page-link">Next</a>
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products_page.paginator.num_pages }}" 
               class="page-link">Last</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Batch Details Modal -->
<div id="batchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Batch Details</h3>
            <span class="modal-close" onclick="closeBatchModal()">&times;</span>
        </div>
        <div class="modal-body" id="batchModalBody">
            <!-- Batch details will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock_statement_report.js' %}"></script>
<script>
// Enhanced Print Function
function printReport() {
    // Add print timestamp
    const printInfo = document.createElement('div');
    printInfo.className = 'print-footer';
    printInfo.innerHTML = `
        <strong>Report Generated:</strong> ${new Date().toLocaleString('en-IN')} | 
        <strong>Total Products:</strong> {{ stock_data|length }} | 
        <strong>System:</strong> Pharma Stock Management
    `;
    document.querySelector('.stock-statement-container').appendChild(printInfo);
    
    // Print
    setTimeout(() => {
        window.print();
        // Remove print info after print
        setTimeout(() => printInfo.remove(), 500);
    }, 100);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+P for Print
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printReport();
    }
});
</script>
{% endblock %}