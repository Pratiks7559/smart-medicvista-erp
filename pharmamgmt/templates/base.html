{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Modern Pharmacy Management System with Beautiful UI">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Pharmacy Management System{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Master Global CSS (Load First) -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Page specific CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Critical Input Fix Only -->
    <style>
    input, textarea, select {
        background-color: #ffffff !important;
        color: #1f2937 !important;
        -webkit-text-fill-color: #1f2937 !important;
    }
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
        -webkit-text-fill-color: #1f2937 !important;
    }
    </style>
</head>
<body class="body-gradient">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader-container">
            <div class="loader-logo-wrapper">
                <div class="medical-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="loader-ring"></div>
                <div class="loader-ring-2"></div>
                <div class="loader-ring-3"></div>
            </div>
            
            <div class="loading-text">MedicVista</div>
            <div class="loading-subtitle">Loading your pharmacy...</div>
            <div class="loading-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>
    
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Sidebar -->
        {% include 'sidebar.html' %}

        
        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Top Navigation -->
            {% include 'navbar.html' %}
            
            <!-- Main Content -->
            <main class="main-content">
                {% if messages %}
                    <div class="messages-container">
                        {% for message in messages %}
                            <div class="message-alert message-{{ message.tags|default:'info' }}" role="alert">
                                <div class="message-content">
                                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} message-icon"></i>
                                    {{ message }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    

    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Theme Toggle JavaScript -->
    <script src="{% static 'js/theme-toggle.js' %}"></script>
    
    <!-- Response Handler Utility -->
    <script src="{% static 'js/response-handler.js' %}"></script>
    
    <!-- Notification System -->
    <script src="{% static 'js/notification-system.js' %}"></script>
    
    <!-- Custom JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- Unified Date Utilities JavaScript -->
    <script src="{% static 'js/unified_date_utils.js' %}"></script>
    
    <!-- Universal Keyboard Navigation -->
    <script src="{% static 'js/universal-keyboard-navigation.js' %}"></script>
    
    <!-- Global Auto-Focus Script -->
    <script src="{% static 'js/auto-focus.js' %}"></script>
    

    
    <!-- Enhanced Universal ESC Navigation System -->
    <script>
        let inputHistory = [];
        let currentInputIndex = -1;
        let inputValues = new Map(); // Store input values
        
        // Show navigation info function
        function showNavigationInfo(current, total, message = '') {
            let navInfo = document.getElementById('navigationInfo');
            if (!navInfo) {
                navInfo = document.createElement('div');
                navInfo.id = 'navigationInfo';
                navInfo.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 10000;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(navInfo);
            }
            
            navInfo.textContent = message || `Input ${current} of ${total}`;
            navInfo.style.opacity = '1';
            
            setTimeout(() => {
                if (navInfo) {
                    navInfo.style.opacity = '0';
                    setTimeout(() => {
                        if (navInfo && navInfo.parentNode) {
                            navInfo.parentNode.removeChild(navInfo);
                        }
                    }, 300);
                }
            }, 2000);
        }
        
        // Save input value when it changes
        function saveInputValue(element) {
            if (element && (element.matches('input, textarea, select'))) {
                const key = getElementKey(element);
                inputValues.set(key, {
                    value: element.value,
                    selectionStart: element.selectionStart || 0,
                    selectionEnd: element.selectionEnd || 0
                });
            }
        }
        
        // Generate unique key for element
        function getElementKey(element) {
            return element.name || element.id || element.className || element.tagName + '_' + Array.from(element.parentNode.children).indexOf(element);
        }
        
        // Restore input value and cursor position
        function restoreInputValue(element) {
            const key = getElementKey(element);
            const saved = inputValues.get(key);
            if (saved) {
                element.value = saved.value;
                if (element.setSelectionRange && saved.selectionStart !== undefined && element.type !== 'date') {
                    setTimeout(() => {
                        try {
                            element.setSelectionRange(saved.selectionStart, saved.selectionEnd);
                        } catch (e) {
                            // Ignore selection errors for unsupported input types
                        }
                    }, 0);
                }
            }
        }
        
        // Track input focus and save values
        document.addEventListener('focusin', function(e) {
            const element = e.target;
            if (element.matches('input, textarea, select')) {
                // Save current value when focusing
                saveInputValue(element);
                
                // Remove element if already in history to avoid duplicates
                const existingIndex = inputHistory.findIndex(item => item.element === element);
                if (existingIndex !== -1) {
                    inputHistory.splice(existingIndex, 1);
                }
                
                // Add current element to history
                inputHistory.push({
                    element: element,
                    timestamp: Date.now(),
                    key: getElementKey(element)
                });
                
                // Keep unlimited history (remove the 10 limit)
                // No limit on history size for unlimited navigation
                
                currentInputIndex = inputHistory.length - 1;
            }
        });
        
        // Save values on input change
        document.addEventListener('input', function(e) {
            if (e.target.matches('input, textarea, select')) {
                saveInputValue(e.target);
            }
        });
        
        // Save values on change event
        document.addEventListener('change', function(e) {
            if (e.target.matches('input, textarea, select')) {
                saveInputValue(e.target);
            }
        });
        
        // Universal ESC key navigation with unlimited backward navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Check if we're in a modal or special context first
                const activeModals = document.querySelectorAll('.modal:not([style*="display: none"]), .modal-overlay:not([style*="display: none"]), .quick-search-overlay, .batch-modal-overlay');
                
                if (activeModals.length > 0) {
                    // Let existing modal handlers deal with ESC
                    return;
                }
                
                // Navigate to previous input if available (unlimited backward navigation)
                if (inputHistory.length > 1 && currentInputIndex > 0) {
                    e.preventDefault();
                    
                    // Save current input value before navigating
                    const currentElement = document.activeElement;
                    if (currentElement && currentElement.matches('input, textarea, select')) {
                        saveInputValue(currentElement);
                    }
                    
                    currentInputIndex--;
                    
                    const previousInput = inputHistory[currentInputIndex];
                    if (previousInput && previousInput.element && document.contains(previousInput.element)) {
                        // Focus without auto-scrolling to prevent interference
                        previousInput.element.focus({ preventScroll: true });
                        
                        // Only scroll if element is not visible
                        const rect = previousInput.element.getBoundingClientRect();
                        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                        
                        if (!isVisible) {
                            previousInput.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // Restore the saved value
                        restoreInputValue(previousInput.element);
                        
                        // Visual feedback
                        previousInput.element.style.boxShadow = '0 0 0 3px rgba(0, 123, 255, 0.3)';
                        setTimeout(() => {
                            if (previousInput.element) {
                                previousInput.element.style.boxShadow = '';
                            }
                        }, 500);
                        
                        // Show navigation info
                        showNavigationInfo(currentInputIndex + 1, inputHistory.length);
                    }
                } else if (inputHistory.length > 0 && currentInputIndex === 0) {
                    // At the beginning of history
                    e.preventDefault();
                    showNavigationInfo(1, inputHistory.length, 'At beginning of navigation history');
                }
                return;
            }
            
            // Ctrl+Shift for back navigation
            if (e.ctrlKey && e.shiftKey && !e.altKey) {
                e.preventDefault();
                window.history.back();
                return;
            }
            
            // Shift+ESC for forward navigation in input history
            if (e.key === 'Escape' && e.shiftKey) {
                e.preventDefault();
                
                // Navigate forward in input history
                if (inputHistory.length > 1 && currentInputIndex < inputHistory.length - 1) {
                    // Save current input value before navigating
                    const currentElement = document.activeElement;
                    if (currentElement && currentElement.matches('input, textarea, select')) {
                        saveInputValue(currentElement);
                    }
                    
                    currentInputIndex++;
                    
                    const nextInput = inputHistory[currentInputIndex];
                    if (nextInput && nextInput.element && document.contains(nextInput.element)) {
                        // Focus without auto-scrolling
                        nextInput.element.focus({ preventScroll: true });
                        
                        // Only scroll if element is not visible
                        const rect = nextInput.element.getBoundingClientRect();
                        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                        
                        if (!isVisible) {
                            nextInput.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // Restore the saved value
                        restoreInputValue(nextInput.element);
                        
                        // Visual feedback
                        nextInput.element.style.boxShadow = '0 0 0 3px rgba(0, 200, 0, 0.3)';
                        setTimeout(() => {
                            if (nextInput.element) {
                                nextInput.element.style.boxShadow = '';
                            }
                        }, 500);
                        
                        // Show navigation info
                        showNavigationInfo(currentInputIndex + 1, inputHistory.length);
                    }
                } else if (currentInputIndex === inputHistory.length - 1) {
                    // At the end of history
                    showNavigationInfo(inputHistory.length, inputHistory.length, 'At end of navigation history');
                }
                return;
            }
            
            // Ctrl+SI shortcut for Quick Invoice+Products
            if (e.ctrlKey && e.key === 's' && !e.shiftKey && !e.altKey) {
                e.preventDefault();
                // Check if next key is 'i'
                let nextKeyTimeout = setTimeout(() => {
                    clearTimeout(nextKeyTimeout);
                }, 500);
                
                document.addEventListener('keydown', function siHandler(e2) {
                    if (e2.key === 'i') {
                        clearTimeout(nextKeyTimeout);
                        document.removeEventListener('keydown', siHandler);
                        e2.preventDefault();
                        window.location.href = "{% url 'add_sales_invoice_with_products' %}";
                    } else {
                        document.removeEventListener('keydown', siHandler);
                    }
                }, { once: true });
            }
            
            // Alt shortcuts for reports and returns
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                switch(e.key.toLowerCase()) {
                    case 'm':
                        e.preventDefault();
                        window.location.href = "{% url 'sales2_report' %}";
                        break;
                    case 'n':
                        e.preventDefault();
                        window.location.href = "{% url 'purchase2_report' %}";
                        break;
                    case 'v':
                        e.preventDefault();
                        window.location.href = "{% url 'financial_report' %}";
                        break;
                    case 'g':
                        e.preventDefault();
                        window.location.href = "{% url 'purchase_return_list' %}";
                        break;
                    case 'h':
                        e.preventDefault();
                        window.location.href = "{% url 'sales_return_list' %}";
                        break;
                    case 'u':
                        e.preventDefault();
                        window.location.href = "{% url 'low_stock_update' %}";
                        break;
                }
            }
        });
        
        // Clean up input history when elements are removed from DOM
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                    inputHistory = inputHistory.filter(item => 
                        item.element && document.contains(item.element)
                    );
                    
                    // Reset index if it's out of bounds
                    if (currentInputIndex >= inputHistory.length) {
                        currentInputIndex = inputHistory.length - 1;
                    }
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- Loading Screen Styles and Script -->
    <style>
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #8c9ad8 0%, #b48cdc 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999999;
        transition: opacity 0.8s ease-out;
        overflow: hidden;
    }
    
    .loading-screen::before {
        content: '';
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 50px 50px;
        animation: backgroundMove 20s linear infinite;
    }
    
    @keyframes backgroundMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }
    
    .loader-container {
        text-align: center;
        color: white;
        position: relative;
        z-index: 1;
    }
    
    .loader-logo-wrapper {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .medical-icon {
        font-size: 60px;
        color: white;
        animation: iconPulse 2s ease-in-out infinite;
        z-index: 10;
        position: relative;
    }
    
    @keyframes iconPulse {
        0%, 100% { 
            transform: scale(1);
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
        }
        50% { 
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1));
        }
    }
    
    .loader-ring {
        position: absolute;
        width: 120px;
        height: 120px;
        border: 4px solid transparent;
        border-top-color: #fff;
        border-right-color: #fff;
        border-radius: 50%;
        animation: ringRotate 1.5s linear infinite;
    }
    
    .loader-ring-2 {
        position: absolute;
        width: 140px;
        height: 140px;
        border: 3px solid transparent;
        border-bottom-color: rgba(255, 255, 255, 0.7);
        border-left-color: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        animation: ringRotate 2s linear infinite reverse;
    }
    
    .loader-ring-3 {
        position: absolute;
        width: 160px;
        height: 160px;
        border: 2px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        animation: ringRotate 2.5s linear infinite;
    }
    
    @keyframes ringRotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        margin-top: 40px;
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        letter-spacing: 3px;
        animation: textGlow 2s ease-in-out infinite;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }
    
    @keyframes textGlow {
        0%, 100% { 
            opacity: 1;
            transform: translateY(0);
        }
        50% { 
            opacity: 0.8;
            transform: translateY(-5px);
        }
    }
    
    .loading-subtitle {
        margin-top: 15px;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 400;
    }
    
    .loading-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
    }
    
    .loading-dots span {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: dotBounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes dotBounce {
        0%, 80%, 100% { 
            transform: scale(0);
            opacity: 0.5;
        }
        40% { 
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .loading-screen.fade-out {
        opacity: 0;
        pointer-events: none;
    }
    
    @media (max-width: 768px) {
        .loader-logo-wrapper {
            width: 120px;
            height: 120px;
        }
        
        .medical-icon {
            font-size: 50px;
        }
        
        .loader-ring { width: 100px; height: 100px; }
        .loader-ring-2 { width: 120px; height: 120px; }
        .loader-ring-3 { width: 140px; height: 140px; }
        
        .loading-text {
            font-size: 2rem;
        }
    }
    </style>
    
    <script>
    // Hide loading screen and show main content
    window.addEventListener('load', function() {
        setTimeout(function() {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            loadingScreen.classList.add('fade-out');
            mainContainer.style.display = 'flex';
            
            setTimeout(function() {
                loadingScreen.style.display = 'none';
            }, 500);
        }, 1000);
    });
    </script>
</body>
</html>