{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invoice_detail.css' %}">
{% endblock %}

{% block page_actions %}
{% endblock %}

{% block content %}
<div class="purchase-invoice-detail-container">
    <div class="purchase-invoice-detail-card">
        <div class="purchase-invoice-detail-header">
            <div class="purchase-invoice-detail-title">
                <h5 class="purchase-invoice-detail-heading">Invoice Information</h5>
            </div>
            <div class="purchase-invoice-detail-actions">
                <button type="button" class="invoice-edit-btn" onclick="openEditInvoiceModal()">
                    <i class="fas fa-edit"></i> Edit Invoice
                </button>
                <div class="purchase-invoice-detail-status">
                    {% if invoice.payment_status == 'paid' %}
                        <span class="purchase-status-paid">Paid</span>
                    {% elif invoice.payment_status == 'partial' %}
                        <span class="purchase-status-partial">Partial</span>
                    {% elif invoice.payment_status == 'overdue' %}
                        <span class="purchase-status-overdue">Overdue</span>
                    {% else %}
                        <span class="purchase-status-pending">Pending</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="invoice-detail-body">
            <div class="invoice-detail-info-grid">
                <div class="invoice-detail-info-card">
                    <h6><i class="fas fa-file-invoice"></i> Invoice Details</h6>
                    <div class="invoice-detail-info-item">
                        <span class="invoice-detail-info-label">Invoice No:</span>
                        <span class="invoice-detail-info-value">{{ invoice.invoice_no }}</span>
                    </div>
                    <div class="invoice-detail-info-item">
                        <span class="invoice-detail-info-label">Date:</span>
                        <span class="invoice-detail-info-value">{{ invoice.invoice_date }}</span>
                    </div>

                </div>
                
                <div class="invoice-detail-info-card">
                    <h6><i class="fas fa-building"></i> Supplier Information</h6>
                    <div class="invoice-detail-info-item">
                        <span class="invoice-detail-info-label">Supplier:</span>
                        <span class="invoice-detail-info-value">
                            <a href="{% url 'supplier_detail' pk=invoice.supplierid.supplierid %}" class="supplier-link">
                                {{ invoice.supplierid.supplier_name }}
                            </a>
                        </span>
                    </div>
                    <div class="invoice-detail-info-item">
                        <span class="invoice-detail-info-label">Transport Charges:</span>
                        <span class="invoice-detail-info-value">{{ invoice.transport_charges|currency }}</span>
                    </div>
                    <div class="invoice-detail-info-item">
                        <span class="invoice-detail-info-label">Invoice Total:</span>
                        <span class="invoice-detail-info-value">{{ invoice.invoice_total|currency }}</span>
                    </div>
                </div>
            </div>

            <div class="invoice-detail-summary">
                <h6><i class="fas fa-chart-pie"></i> Payment Summary</h6>
                <div class="invoice-detail-summary-grid">
                    <div class="invoice-detail-summary-item">
                        <div class="invoice-detail-summary-label">Total Amount</div>
                        <div class="invoice-detail-summary-value">{{ invoice.invoice_total|currency }}</div>
                    </div>
                    <div class="invoice-detail-summary-item">
                        <div class="invoice-detail-summary-label">Amount Paid</div>
                        <div class="invoice-detail-summary-value">{{ invoice.invoice_paid|currency }}</div>
                    </div>
                    <div class="invoice-detail-summary-item">
                        <div class="invoice-detail-summary-label">Balance Due</div>
                        <div class="invoice-detail-summary-value balance-due-{% if invoice.balance_due > 0 %}pending{% else %}paid{% endif %}">{{ invoice.balance_due|currency }}</div>
                    </div>
                </div>
                <div class="payment-progress-container">
                    <div class="payment-progress-bar">
                        {% if invoice.invoice_total > 0 %}
                        <div class="payment-progress-fill" style="width: {{ invoice.invoice_paid|divide:invoice.invoice_total|multiply:100 }}%;">
                            {{ invoice.invoice_paid|divide:invoice.invoice_total|multiply:100|floatformat:1 }}%
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="invoice-detail-products-section">
                <div class="invoice-detail-products-header">
                    <h6><i class="fas fa-credit-card"></i> Payment History</h6>
                    {% if invoice.balance_due > 0 %}
                    <button type="button" onclick="openAddPaymentDialog()" class="invoice-detail-btn invoice-detail-btn-primary">
                        <i class="fas fa-plus"></i> Add Payment
                    </button>
                    {% endif %}
                </div>
                <table class="invoice-detail-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Mode</th>
                            <th>Reference</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.payment_date }}</td>
                            <td>{{ payment.payment_amount|currency }}</td>
                            <td>{{ payment.payment_mode }}</td>
                            <td>{{ payment.payment_ref_no }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" onclick="openEditPaymentDialog({{ payment.payment_id }}, '{{ payment.payment_date }}', {{ payment.payment_amount }}, '{{ payment.payment_mode }}', '{{ payment.payment_ref_no|default:"" }}')" class="invoice-detail-btn invoice-detail-btn-secondary btn-small">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" onclick="confirmDeletePayment({{ payment.payment_id }}, {{ payment.payment_amount }})" class="invoice-detail-btn invoice-detail-btn-danger btn-small">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="no-data">No payments recorded</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="invoice-detail-products-section">
                <div class="invoice-detail-products-header">
                    <h6><i class="fas fa-boxes"></i> Invoice Products</h6>
                </div>
                <table class="invoice-detail-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch No</th>
                            <th>Expiry</th>
                            <th>MRP</th>
                            <th>Rate</th>
                            <th>Qty</th>
                            <th>Discount</th>
                            <th>CGST %</th>
                            <th>SGST %</th>
                            <th>Total</th>
                            <th>Rate A</th>
                            <th>Rate B</th>
                            <th>Rate C</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases %}
                        <tr>
                            <td>
                                <a href="{% url 'product_detail' pk=purchase.productid.productid %}">
                                    {{ purchase.product_name }}
                                </a>
                                <div class="small text-muted">{{ purchase.product_company }} - {{ purchase.product_packing }}</div>
                            </td>
                            <td>{{ purchase.product_batch_no }}</td>
                            <td>{{ purchase.product_expiry }}</td>
                            <td>{{ purchase.product_MRP|currency }}</td>
                            <td>{{ purchase.product_purchase_rate|currency }}</td>
                            <td>{{ purchase.product_quantity }}</td>
                            <td>
                                {% if purchase.purchase_calculation_mode == 'flat' %}
                                    {{ purchase.product_discount_got|currency }}
                                {% else %}
                                    {{ purchase.product_discount_got }}%
                                {% endif %}
                            </td>
                            <td>{{ purchase.CGST }}%</td>
                            <td>{{ purchase.SGST }}%</td>
                            <td>{{ purchase.total_amount|currency }}</td>
                            <td>{{ purchase.rate_a|default:0|currency }}</td>
                            <td>{{ purchase.rate_b|default:0|currency }}</td>
                            <td>{{ purchase.rate_c|default:0|currency }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" onclick="confirmDeletePurchase({{ purchase.purchaseid }}, '{{ purchase.product_name|escapejs }}')" class="invoice-detail-btn invoice-detail-btn-danger btn-small">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="13" class="no-data">No products added to this invoice</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-footer">
                        <tr>
                            <td colspan="10" style="font-weight: 600;"><strong>Sum of Products:</strong></td>
                            <td style="font-weight: 600;">{{ purchases_total|currency }}</td>
                        </tr>
                        <tr>
                            <td colspan="10" style="font-weight: 600;"><strong>Transport Charges:</strong></td>
                            <td style="font-weight: 600;">{{ invoice.transport_charges|currency }}</td>
                        </tr>
                        <tr class="grand-total-row">
                            <td colspan="10" style="font-weight: 700; color: #2c3e50;"><strong>Invoice Total:</strong></td>
                            <td style="font-weight: 700; color: #2c3e50;">{{ invoice.invoice_total|currency }}</td>
                        </tr>
                        {% if has_pending_entries %}
                        <tr class="pending-entries-row">
                            <td colspan="10">
                                <strong>Pending Entries:</strong>
                                <div style="font-size: 0.8rem; color: #e74c3c;">
                                    {% if invoice_pending > 0 %}
                                    There are missing product entries worth {{ invoice_pending|currency }}
                                    {% else %}
                                    Product entries exceed invoice total by {{ invoice_pending|absolute|currency }}
                                    {% endif %}
                                </div>
                            </td>
                            <td style="color: #e74c3c; font-weight: 600;">{{ invoice_pending|currency }}</td>
                        </tr>
                        {% endif %}
                    </tfoot>
                </table>
            </div>
            

            
            <div class="invoice-detail-btn-group">
                <a href="{% url 'print_gst_purchase_invoice' invoice_id=invoice.invoiceid %}" target="_blank" class="invoice-detail-btn invoice-detail-btn-primary">
                    <i class="fas fa-print"></i> Print Receipt
                </a>
               
                <a href="{% url 'invoice_list' %}" class="invoice-detail-btn invoice-detail-btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Invoices
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Invoice Modal -->
<div id="editInvoiceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Invoice #{{ invoice.invoice_no }}</h3>
            <span class="close" onclick="closeEditInvoiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editInvoiceForm" method="post">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="invoice_no">Invoice No:</label>
                        <input type="text" id="invoice_no" name="invoice_no" value="{{ invoice.invoice_no }}" required>
                    </div>
                    <div class="form-group">
                        <label for="invoice_date">Invoice Date:</label>
                        <input type="date" id="invoice_date" name="invoice_date" value="{{ invoice.invoice_date|date:'Y-m-d' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="supplierid">Supplier:</label>
                        <select id="supplierid" name="supplierid" required>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.supplierid }}" {% if supplier.supplierid == invoice.supplierid.supplierid %}selected{% endif %}>
                                {{ supplier.supplier_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transport_charges">Transport Charges:</label>
                        <input type="number" id="transport_charges" name="transport_charges" value="{{ invoice.transport_charges }}" step="0.01">
                    </div>
                </div>
                
                <h4>Products</h4>
                <div id="productsContainer">
                    <!-- Existing products will be loaded here -->
                </div>
                
                <button type="button" onclick="addNewProduct()" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add New Product
                </button>
                
                <div class="invoice-total-display" style="margin-top: 1.5rem; padding: 1rem; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">Products Total:</span>
                        <span id="productsTotal" style="font-weight: 600; color: #27ae60;">‚Çπ0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">Transport Charges:</span>
                        <span id="transportChargesDisplay" style="font-weight: 600; color: #3498db;">‚Çπ0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 2px solid #27ae60;">
                        <span style="font-weight: 700; font-size: 1.1rem;">Invoice Total:</span>
                        <span id="invoiceTotal" style="font-weight: 700; font-size: 1.1rem; color: #27ae60;">‚Çπ0.00</span>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeEditInvoiceModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Invoice</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function openEditInvoiceModal() {
    document.getElementById('editInvoiceModal').style.display = 'block';
    loadExistingProducts();
    
    // Add event listener for transport charges
    const transportInput = document.getElementById('transport_charges');
    if (transportInput) {
        transportInput.addEventListener('input', updateInvoiceTotal);
    }
}

function closeEditInvoiceModal() {
    document.getElementById('editInvoiceModal').style.display = 'none';
}
</script>
<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
}

.modal-body {
    padding: 1.5rem;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.form-group input, .form-group select {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
}

.product-row {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f8f9fa;
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

/* Quick Search Modal Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-search-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: quickSearchFadeIn 0.2s ease-out;
}

@keyframes quickSearchFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.quick-search-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 1rem;
    text-align: center;
}

.quick-search-header h4 {
    margin: 0;
    font-size: 1.2rem;
}

.quick-search-header small {
    opacity: 0.9;
    font-size: 0.85rem;
}

.quick-search-input {
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.quick-search-input input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
}

.quick-search-input input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.quick-search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
}

.quick-result-item {
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    margin-bottom: 0.25rem;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #f8f9fa;
    border-color: #007bff;
    transform: translateX(4px);
}

.product-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.product-company {
    font-size: 0.85rem;
    color: #6c757d;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
    font-style: italic;
}

.quick-search-footer {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #eee;
}

.quick-search-footer small {
    color: #6c757d;
    font-size: 0.8rem;
}
</style>

<script>
let productCounter = 0;

// Handle form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editInvoiceForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Collect product data
            const products = [];
            const productRows = document.querySelectorAll('.product-row');
            
            productRows.forEach(row => {
                const productSelect = row.querySelector('select[name*="[productid]"]');
                const batchInput = row.querySelector('input[name*="[batch_no]"]');
                const expiryInput = row.querySelector('input[name*="[expiry]"]');
                const mrpInput = row.querySelector('input[name*="[mrp]"]');
                const rateInput = row.querySelector('input[name*="[purchase_rate]"]');
                const qtyInput = row.querySelector('input[name*="[quantity]"]');
                const discountInput = row.querySelector('input[name*="[discount]"]');
                const cgstInput = row.querySelector('input[name*="[cgst]"]');
                const sgstInput = row.querySelector('input[name*="[sgst]"]');
                const rateAInput = row.querySelector('input[name*="[rate_a]"]');
                const rateBInput = row.querySelector('input[name*="[rate_b]"]');
                const rateCInput = row.querySelector('input[name*="[rate_c]"]');
                
                if (productSelect && productSelect.value) {
                    products.push({
                        productid: productSelect.value,
                        batch_no: batchInput ? batchInput.value : '',
                        expiry: expiryInput ? expiryInput.value : '',
                        mrp: mrpInput ? parseFloat(mrpInput.value) || 0 : 0,
                        purchase_rate: rateInput ? parseFloat(rateInput.value) || 0 : 0,
                        quantity: qtyInput ? parseFloat(qtyInput.value) || 0 : 0,
                        discount: discountInput ? parseFloat(discountInput.value) || 0 : 0,
                        cgst: cgstInput ? parseFloat(cgstInput.value) || 0 : 0,
                        sgst: sgstInput ? parseFloat(sgstInput.value) || 0 : 0,
                        rate_A: rateAInput ? (parseFloat(rateAInput.value) || 0) : 0,
                        rate_B: rateBInput ? (parseFloat(rateBInput.value) || 0) : 0,
                        rate_C: rateCInput ? (parseFloat(rateCInput.value) || 0) : 0,
                        rate_a: rateAInput ? (parseFloat(rateAInput.value) || 0) : 0,
                        rate_b: rateBInput ? (parseFloat(rateBInput.value) || 0) : 0,
                        rate_c: rateCInput ? (parseFloat(rateCInput.value) || 0) : 0,
                        calculation_mode: 'flat'
                    });
                }
            });
            
            // Add products data as JSON
            formData.append('products_data', JSON.stringify(products));
            
            fetch('{% url "edit_invoice" pk=invoice.invoiceid %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating invoice');
            });
        });
    }
});

function formatExpiryToMMYYYY(dateStr) {
    if (!dateStr) return '';
    
    // If already in MM-YYYY format, return as is
    if (/^(0[1-9]|1[0-2])-[0-9]{4}$/.test(dateStr)) {
        return dateStr;
    }
    
    // Convert YYYY-MM-DD to MM-YYYY
    if (/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(dateStr)) {
        const parts = dateStr.split('-');
        return `${parts[1]}-${parts[0]}`;
    }
    
    // Convert MMYY to MM-YYYY
    if (/^[0-9]{4}$/.test(dateStr)) {
        return `${dateStr.substring(0,2)}-20${dateStr.substring(2,4)}`;
    }
    
    return dateStr;
}

function loadExistingProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    
    {% for purchase in purchases %}
    addProductRow({
        productid: {{ purchase.productid.productid }},
        product_name: '{{ purchase.product_name|escapejs }}',
        product_batch_no: '{{ purchase.product_batch_no|escapejs }}',
        product_expiry: formatExpiryToMMYYYY('{{ purchase.product_expiry }}'),
        product_MRP: {{ purchase.product_MRP }},
        product_purchase_rate: {{ purchase.product_purchase_rate }},
        product_quantity: {{ purchase.product_quantity }},
        product_discount_got: {{ purchase.product_discount_got }},
        purchase_calculation_mode: '{{ purchase.purchase_calculation_mode }}',
        CGST: {{ purchase.CGST }},
        SGST: {{ purchase.SGST }},
        rate_A: {{ purchase.rate_a|default:0 }},
        rate_B: {{ purchase.rate_b|default:0 }},
        rate_C: {{ purchase.rate_c|default:0 }}
    });
    {% endfor %}
    
    updateInvoiceTotal();
}

function updateInvoiceTotal() {
    let productsTotal = 0;
    const productRows = document.querySelectorAll('.product-row');
    
    productRows.forEach(row => {
        const rateInput = row.querySelector('input[name*="[purchase_rate]"]');
        const qtyInput = row.querySelector('input[name*="[quantity]"]');
        const discountInput = row.querySelector('input[name*="[discount]"]');
        const cgstInput = row.querySelector('input[name*="[cgst]"]');
        const sgstInput = row.querySelector('input[name*="[sgst]"]');
        
        if (rateInput && qtyInput) {
            const rate = parseFloat(rateInput.value) || 0;
            const qty = parseFloat(qtyInput.value) || 0;
            const discount = parseFloat(discountInput?.value) || 0;
            const cgst = parseFloat(cgstInput?.value) || 0;
            const sgst = parseFloat(sgstInput?.value) || 0;
            
            const baseAmount = rate * qty;
            const afterDiscount = baseAmount - discount;
            const gstAmount = (afterDiscount * (cgst + sgst)) / 100;
            const total = afterDiscount + gstAmount;
            
            productsTotal += total;
        }
    });
    
    const transportCharges = parseFloat(document.getElementById('transport_charges')?.value) || 0;
    const invoiceTotal = productsTotal + transportCharges;
    
    // Show exact amounts without rounding to fix the 2.00 vs 2.10 issue
    document.getElementById('productsTotal').textContent = '‚Çπ' + productsTotal.toFixed(2);
    document.getElementById('transportChargesDisplay').textContent = '‚Çπ' + transportCharges.toFixed(2);
    document.getElementById('invoiceTotal').textContent = '‚Çπ' + invoiceTotal.toFixed(2);
}

function addNewProduct() {
    addProductRow({});
}

function addProductRow(data = {}) {
    const container = document.getElementById('productsContainer');
    const productId = `product_${productCounter++}`;
    
    const productRow = document.createElement('div');
    productRow.className = 'product-row';
    
    // Create product options with proper selection
    let productOptions = '<option value="">Select Product</option>';
    {% for product in products %}
    productOptions += `<option value="{{ product.productid }}" ${data.productid == {{ product.productid }} ? 'selected' : ''}>{{ product.product_name|escapejs }} - {{ product.product_company|escapejs }}</option>`;
    {% endfor %}
    
    productRow.innerHTML = `
        <div class="product-grid">
            <div class="form-group">
                <label>Product:</label>
                <select name="products[${productId}][productid]">
                    ${productOptions}
                </select>
            </div>
            <div class="form-group">
                <label>Batch No:</label>
                <input type="text" name="products[${productId}][batch_no]" value="${data.product_batch_no || ''}">
            </div>
            <div class="form-group">
                <label>Expiry (MM-YYYY):</label>
                <input type="text" name="products[${productId}][expiry]" value="${data.product_expiry || ''}" placeholder="MM-YYYY" pattern="^(0[1-9]|1[0-2])-[0-9]{4}$" maxlength="7">
            </div>
            <div class="form-group">
                <label>MRP:</label>
                <input type="number" name="products[${productId}][mrp]" value="${data.product_MRP || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Purchase Rate:</label>
                <input type="number" name="products[${productId}][purchase_rate]" value="${data.product_purchase_rate || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" name="products[${productId}][quantity]" value="${data.product_quantity || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Discount:</label>
                <input type="number" name="products[${productId}][discount]" value="${data.product_discount_got || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>CGST %:</label>
                <input type="number" name="products[${productId}][cgst]" value="${data.CGST || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <label>SGST %:</label>
                <input type="number" name="products[${productId}][sgst]" value="${data.SGST || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <label>Rate A:</label>
                <input type="number" name="products[${productId}][rate_a]" value="${data.rate_A || data.rate_a || data.rate_A || 0}" step="0.01">
            </div>
            <div class="form-group">
                <label>Rate B:</label>
                <input type="number" name="products[${productId}][rate_b]" value="${data.rate_B || data.rate_b || data.rate_B || 0}" step="0.01">
            </div>
            <div class="form-group">
                <label>Rate C:</label>
                <input type="number" name="products[${productId}][rate_c]" value="${data.rate_C || data.rate_c || data.rate_C || 0}" step="0.01">
            </div>
            <div class="form-group">
                <button type="button" onclick="removeProduct(this)" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(productRow);
    
    // Add event listeners for real-time calculation
    const calcInputs = productRow.querySelectorAll('input[type="number"]');
    calcInputs.forEach(input => {
        input.addEventListener('input', updateInvoiceTotal);
    });
    
    // Add event listener for expiry date formatting
    const expiryInput = productRow.querySelector(`input[name="products[${productId}][expiry]"]`);
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 2) {
                value = value.substring(0,2) + '-' + value.substring(2,6);
            }
            e.target.value = value;
        });
        
        expiryInput.addEventListener('blur', function(e) {
            const value = e.target.value;
            if (value && !/^(0[1-9]|1[0-2])-[0-9]{4}$/.test(value)) {
                alert('Please enter expiry in MM-YYYY format (e.g., 12-2024)');
                e.target.focus();
            }
        });
    }
}

function removeProduct(button) {
    button.closest('.product-row').remove();
}

// Enhanced keyboard shortcuts and navigation
document.addEventListener('keydown', function(e) {
    // F2: Open quick product search (only when modal is open)
    if (e.key === 'F2') {
        e.preventDefault();
        const modal = document.getElementById('editInvoiceModal');
        if (modal && modal.style.display === 'block') {
            openQuickProductSearch();
        }
    }
    
    // Escape: Close modals
    if (e.key === 'Escape') {
        e.preventDefault();
        const quickModal = document.getElementById('quickProductModal');
        if (quickModal) {
            closeQuickSearch();
            return;
        }
        
        const editModal = document.getElementById('editInvoiceModal');
        if (editModal && editModal.style.display === 'block') {
            closeEditInvoiceModal();
        }
    }
});

// Quick product search functionality
function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name..." onkeyup="quickSearchProducts(event)">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        
        input.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('quickResults');
            
            switch(e.key) {
                case 'Escape':
                    closeQuickSearch();
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    navigateResults(1);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    navigateResults(-1);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    const selected = resultsDiv.querySelector('.selected') || resultsDiv.querySelector('.quick-result-item');
                    if (selected) {
                        const productName = selected.querySelector('.product-name').textContent;
                        const productCompany = selected.querySelector('.product-company').textContent;
                        
                        const products = [{% for product in products %}{
                            id: {{ product.productid }},
                            name: '{{ product.product_name|escapejs }}',
                            company: '{{ product.product_company|escapejs }}'
                        },{% endfor %}];
                        
                        const matchedProduct = products.find(p => 
                            p.name === productName && p.company === productCompany
                        );
                        
                        if (matchedProduct) {
                            quickSelectProduct(matchedProduct.id, matchedProduct.name, matchedProduct.company);
                        }
                    }
                    break;
            }
        });
    }, 100);
}

function quickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(event.key)) {
        return;
    }
    
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectProduct(${product.id}, '${product.name}', '${product.company}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function navigateResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function quickSelectProduct(productId, productName, productCompany) {
    // Find empty product row or add new one
    const productRows = document.querySelectorAll('.product-row');
    let targetRow = null;
    
    for (let row of productRows) {
        const productSelect = row.querySelector('select[name*="[productid]"]');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addNewProduct();
        setTimeout(() => {
            const newRows = document.querySelectorAll('.product-row');
            targetRow = newRows[newRows.length - 1];
            fillProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}

function fillProductInRow(row, productId) {
    const productSelect = row.querySelector('select[name*="[productid]"]');
    if (productSelect) {
        productSelect.value = productId;
        
        // Focus on batch field after selection
        setTimeout(() => {
            const batchField = row.querySelector('input[name*="[batch_no]"]');
            if (batchField) {
                batchField.focus();
                batchField.select();
            }
        }, 100);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) {
        modal.remove();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editInvoiceModal');
    if (event.target === modal) {
        closeEditInvoiceModal();
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+E for edit invoice
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        openEditInvoiceModal();
    }
    
    // Ctrl+P for print receipt
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        const receiptUrl = `{% url 'print_gst_purchase_invoice' invoice_id=invoice.invoiceid %}`;
        window.open(receiptUrl, '_blank');
    }
});

// Delete Purchase Confirmation Dialog
let deleteDialogPurchaseId = null;
let deleteDialogProductName = null;

function confirmDeletePurchase(purchaseId, productName) {
    deleteDialogPurchaseId = purchaseId;
    deleteDialogProductName = productName;
    
    const existingDialog = document.getElementById('deleteConfirmDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    const dialogHTML = `
        <div id="deleteConfirmDialog" class="delete-confirm-overlay">
            <div class="delete-confirm-content">
                <div class="delete-confirm-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Delete Product?</h3>
                <p>Are you sure you want to delete <strong>${productName}</strong> from this invoice?</p>
                <div class="delete-confirm-buttons">
                    <button type="button" class="btn-confirm-delete" onclick="executePurchaseDelete()">
                        <i class="fas fa-check"></i> Yes, Delete (Enter)
                    </button>
                    <button type="button" class="btn-cancel-delete" onclick="closeDeleteDialog()">
                        <i class="fas fa-times"></i> Cancel (Esc)
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    setTimeout(() => {
        document.querySelector('.btn-confirm-delete').focus();
    }, 100);
    
    document.addEventListener('keydown', handleDeleteDialogKeys);
}

function handleDeleteDialogKeys(e) {
    const dialog = document.getElementById('deleteConfirmDialog');
    if (!dialog) return;
    
    if (e.key === 'Enter') {
        e.preventDefault();
        executePurchaseDelete();
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeDeleteDialog();
    }
}

function executePurchaseDelete() {
    if (!deleteDialogPurchaseId) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/invoices/{{ invoice.invoiceid }}/delete-purchase/${deleteDialogPurchaseId}/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

function closeDeleteDialog() {
    const dialog = document.getElementById('deleteConfirmDialog');
    if (dialog) {
        dialog.remove();
    }
    document.removeEventListener('keydown', handleDeleteDialogKeys);
    deleteDialogPurchaseId = null;
    deleteDialogProductName = null;
}

// Add Payment Dialog
function openAddPaymentDialog() {
    const existingDialog = document.getElementById('addPaymentDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    const today = new Date().toISOString().split('T')[0];
    const balance = {{ invoice.balance_due }};
    
    const dialogHTML = `
        <div id="addPaymentDialog" class="payment-dialog-overlay">
            <div class="payment-dialog-content">
                <div class="payment-dialog-header">
                    <h3><i class="fas fa-money-bill-wave"></i> Add Payment</h3>
                    <span class="close" onclick="closePaymentDialog()">&times;</span>
                </div>
                <div class="payment-dialog-body">
                    <form id="addPaymentForm" method="post">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        
                        <div class="payment-balance-info">
                            <span>Balance Due:</span>
                            <strong>‚Çπ${balance.toFixed(2)}</strong>
                        </div>
                        
                        <div class="payment-form-row">
                            <div class="payment-form-group">
                                <label for="payment_amount">Amount <span class="required">*</span></label>
                                <input type="number" id="payment_amount" name="payment_amount" 
                                       step="0.01" min="0.01" max="${balance}" 
                                       value="${balance}" required autofocus>
                            </div>
                            <div class="payment-form-group">
                                <label for="payment_date">Date <span class="required">*</span></label>
                                <input type="date" id="payment_date" name="payment_date" 
                                       value="${today}" required>
                            </div>
                        </div>
                        
                        <div class="payment-form-row">
                            <div class="payment-form-group">
                                <label for="payment_mode">Payment Mode <span class="required">*</span></label>
                                <select id="payment_mode" name="payment_mode" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="payment-form-group">
                                <label for="payment_ref_no">Reference No</label>
                                <input type="text" id="payment_ref_no" name="payment_ref_no" 
                                       placeholder="Optional">
                            </div>
                        </div>
                        
                        <div class="payment-dialog-footer">
                            <button type="button" onclick="closePaymentDialog()" class="btn-payment-cancel">
                                <i class="fas fa-times"></i> Cancel (Esc)
                            </button>
                            <button type="submit" class="btn-payment-submit">
                                <i class="fas fa-check"></i> Add Payment (Enter)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    setTimeout(() => {
        document.getElementById('payment_amount').focus();
        document.getElementById('payment_amount').select();
    }, 100);
    
    document.getElementById('addPaymentForm').addEventListener('submit', handlePaymentSubmit);
    document.addEventListener('keydown', handlePaymentDialogKeys);
}

function handlePaymentDialogKeys(e) {
    const dialog = document.getElementById('addPaymentDialog');
    if (!dialog) return;
    
    if (e.key === 'Escape') {
        e.preventDefault();
        closePaymentDialog();
    }
}

function handlePaymentSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    fetch('{% url "add_invoice_payment" invoice_id=invoice.invoiceid %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return;
        if (data.success) {
            // Update payment summary with new values
            const balanceElement = document.querySelector('.balance-due-pending, .balance-due-paid');
            const paidElement = document.querySelector('.invoice-detail-summary-item:nth-child(2) .invoice-detail-summary-value');
            const statusElement = document.querySelector('.purchase-invoice-detail-status span');
            
            if (balanceElement) {
                balanceElement.textContent = '‚Çπ' + data.new_balance.toFixed(2);
                balanceElement.className = data.new_balance > 0 ? 'invoice-detail-summary-value balance-due-pending' : 'invoice-detail-summary-value balance-due-paid';
            }
            
            if (paidElement) {
                paidElement.textContent = '‚Çπ' + data.new_paid_amount.toFixed(2);
            }
            
            if (statusElement && data.payment_status) {
                const statusMap = {
                    'paid': { text: 'Paid', class: 'purchase-status-paid' },
                    'partial': { text: 'Partial', class: 'purchase-status-partial' },
                    'pending': { text: 'Pending', class: 'purchase-status-pending' },
                    'overdue': { text: 'Overdue', class: 'purchase-status-overdue' }
                };
                const status = statusMap[data.payment_status] || statusMap['pending'];
                statusElement.textContent = status.text;
                statusElement.className = status.class;
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.payment-progress-fill');
            if (progressBar && data.invoice_total) {
                const percentage = (data.new_paid_amount / data.invoice_total) * 100;
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage.toFixed(1) + '%';
            }
            
            closePaymentDialog();
            alert('Payment added successfully! Balance updated.');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert('Error adding payment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding payment');
    });
}

function closePaymentDialog() {
    const dialog = document.getElementById('addPaymentDialog');
    if (dialog) {
        dialog.remove();
    }
    document.removeEventListener('keydown', handlePaymentDialogKeys);
}

// Edit Payment Dialog
let editPaymentId = null;

function openEditPaymentDialog(paymentId, paymentDate, paymentAmount, paymentMode, paymentRef) {
    editPaymentId = paymentId;
    
    const existingDialog = document.getElementById('editPaymentDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Convert date to yyyy-MM-dd format
    let formattedDate = paymentDate;
    if (paymentDate && !paymentDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const dateObj = new Date(paymentDate);
        if (!isNaN(dateObj.getTime())) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            formattedDate = `${year}-${month}-${day}`;
        }
    }
    
    const dialogHTML = `
        <div id="editPaymentDialog" class="payment-dialog-overlay">
            <div class="payment-dialog-content">
                <div class="payment-dialog-header" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    <h3><i class="fas fa-edit"></i> Edit Payment</h3>
                    <span class="close" onclick="closeEditPaymentDialog()">&times;</span>
                </div>
                <div class="payment-dialog-body">
                    <form id="editPaymentForm" method="post">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        
                        <div class="payment-form-row">
                            <div class="payment-form-group">
                                <label for="edit_payment_amount">Amount <span class="required">*</span></label>
                                <input type="number" id="edit_payment_amount" name="payment_amount" 
                                       step="0.01" min="0.01" value="${paymentAmount}" required autofocus>
                            </div>
                            <div class="payment-form-group">
                                <label for="edit_payment_date">Date <span class="required">*</span></label>
                                <input type="date" id="edit_payment_date" name="payment_date" 
                                       value="${formattedDate}" required>
                            </div>
                        </div>
                        
                        <div class="payment-form-row">
                            <div class="payment-form-group">
                                <label for="edit_payment_mode">Payment Mode <span class="required">*</span></label>
                                <select id="edit_payment_mode" name="payment_mode" required>
                                    <option value="Cash" ${paymentMode === 'Cash' ? 'selected' : ''}>Cash</option>
                                    <option value="Card" ${paymentMode === 'Card' ? 'selected' : ''}>Card</option>
                                    <option value="UPI" ${paymentMode === 'UPI' ? 'selected' : ''}>UPI</option>
                                    <option value="Cheque" ${paymentMode === 'Cheque' ? 'selected' : ''}>Cheque</option>
                                    <option value="Bank Transfer" ${paymentMode === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                                </select>
                            </div>
                            <div class="payment-form-group">
                                <label for="edit_payment_ref_no">Reference No</label>
                                <input type="text" id="edit_payment_ref_no" name="payment_ref_no" 
                                       value="${paymentRef}" placeholder="Optional">
                            </div>
                        </div>
                        
                        <div class="payment-dialog-footer">
                            <button type="button" onclick="closeEditPaymentDialog()" class="btn-payment-cancel">
                                <i class="fas fa-times"></i> Cancel (Esc)
                            </button>
                            <button type="submit" class="btn-payment-submit" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                <i class="fas fa-save"></i> Update (Enter)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    setTimeout(() => {
        document.getElementById('edit_payment_amount').focus();
        document.getElementById('edit_payment_amount').select();
    }, 100);
    
    document.getElementById('editPaymentForm').addEventListener('submit', handleEditPaymentSubmit);
    document.addEventListener('keydown', handleEditPaymentDialogKeys);
}

function handleEditPaymentDialogKeys(e) {
    const dialog = document.getElementById('editPaymentDialog');
    if (!dialog) return;
    
    if (e.key === 'Escape') {
        e.preventDefault();
        closeEditPaymentDialog();
    }
}

function handleEditPaymentSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    fetch(`/invoices/{{ invoice.invoiceid }}/edit-payment/${editPaymentId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error updating payment.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating payment');
    });
}

function closeEditPaymentDialog() {
    const dialog = document.getElementById('editPaymentDialog');
    if (dialog) {
        dialog.remove();
    }
    document.removeEventListener('keydown', handleEditPaymentDialogKeys);
    editPaymentId = null;
}

// Delete Payment Dialog
let deletePaymentId = null;
let deletePaymentAmount = null;

function confirmDeletePayment(paymentId, amount) {
    deletePaymentId = paymentId;
    deletePaymentAmount = amount;
    
    const existingDialog = document.getElementById('deletePaymentDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    const dialogHTML = `
        <div id="deletePaymentDialog" class="delete-confirm-overlay">
            <div class="delete-confirm-content">
                <div class="delete-confirm-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Delete Payment?</h3>
                <p>Are you sure you want to delete payment of <strong>‚Çπ${amount.toFixed(2)}</strong>?</p>
                <p style="font-size: 0.9rem; color: #7f8c8d;">This will increase the invoice balance.</p>
                <div class="delete-confirm-buttons">
                    <button type="button" class="btn-confirm-delete" onclick="executePaymentDelete()">
                        <i class="fas fa-check"></i> Yes, Delete (Enter)
                    </button>
                    <button type="button" class="btn-cancel-delete" onclick="closeDeletePaymentDialog()">
                        <i class="fas fa-times"></i> Cancel (Esc)
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    setTimeout(() => {
        document.querySelector('.btn-confirm-delete').focus();
    }, 100);
    
    document.addEventListener('keydown', handleDeletePaymentDialogKeys);
}

function handleDeletePaymentDialogKeys(e) {
    const dialog = document.getElementById('deletePaymentDialog');
    if (!dialog) return;
    
    if (e.key === 'Enter') {
        e.preventDefault();
        executePaymentDelete();
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeDeletePaymentDialog();
    }
}

function executePaymentDelete() {
    if (!deletePaymentId) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/invoices/{{ invoice.invoiceid }}/delete-payment/${deletePaymentId}/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

function closeDeletePaymentDialog() {
    const dialog = document.getElementById('deletePaymentDialog');
    if (dialog) {
        dialog.remove();
    }
    document.removeEventListener('keydown', handleDeletePaymentDialogKeys);
    deletePaymentId = null;
    deletePaymentAmount = null;
}

// Print purchase receipt function
function printPurchaseReceipt() {
    // Open the purchase receipt in a new window
    const receiptUrl = `{% url 'print_gst_purchase_invoice' invoice_id=invoice.invoiceid %}`;
    window.open(receiptUrl, '_blank');
}

// Show shortcut hint on page load
window.addEventListener('load', function() {
    console.log('üí° Tip: Press Ctrl+P to print purchase receipt');
});
</script>

<style>
.delete-confirm-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.delete-confirm-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    text-align: center;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateY(-30px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.delete-confirm-icon {
    font-size: 3rem;
    color: #e74c3c;
    margin-bottom: 1rem;
}

.delete-confirm-content h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.delete-confirm-content p {
    color: #555;
    margin-bottom: 1.5rem;
    font-size: 1rem;
    line-height: 1.5;
}

.delete-confirm-content p strong {
    color: #e74c3c;
}

.delete-confirm-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn-confirm-delete,
.btn-cancel-delete {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-confirm-delete {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.btn-confirm-delete:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.btn-cancel-delete {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-cancel-delete:hover {
    background: linear-gradient(135deg, #7f8c8d, #6c7a7b);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
}

/* Payment Dialog Styles */
.payment-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.payment-dialog-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 550px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
    overflow: hidden;
}

.payment-dialog-header {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.payment-dialog-header h3 {
    margin: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.payment-dialog-header .close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: white;
    opacity: 0.9;
    transition: opacity 0.2s;
}

.payment-dialog-header .close:hover {
    opacity: 1;
}

.payment-dialog-body {
    padding: 1.5rem;
}

.payment-balance-info {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1rem;
    color: red;
}

.payment-balance-info strong {
    color: #27ae60;
    font-size: 1.3rem;
}

.payment-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.payment-form-group {
    display: flex;
    flex-direction: column;
}

.payment-form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-size: 0.9rem;
}

.payment-form-group .required {
    color: #e74c3c;
}

.payment-form-group input,
.payment-form-group select {
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
}

.payment-form-group input:focus,
.payment-form-group select:focus {
    outline: none;
    border-color: #27ae60;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
}

.payment-dialog-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

.btn-payment-cancel,
.btn-payment-submit {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-payment-cancel {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-payment-cancel:hover {
    background: linear-gradient(135deg, #7f8c8d, #6c7a7b);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
}

.btn-payment-submit {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.btn-payment-submit:hover {
    background: linear-gradient(135deg, #229954, #1e8449);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

@media (max-width: 600px) {
    .payment-form-row {
        grid-template-columns: 1fr;
    }
    
    .payment-dialog-content {
        width: 95%;
    }
}
.challan-badge {
    display: inline-block;
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
}

.direct-entry-badge {
    display: inline-block;
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
}
</style>
<div style="position: fixed; bottom: 0; left: 0; right: 0; background: #1f2937; color: #d1d5db; padding: 10px 20px; font-size: 0.8rem; display: flex; justify-content: center; gap: 30px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+E</span>
        <span>Edit Invoice</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+P</span>
        <span>Print Purchase Receipt</span>
    </div>
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Alt+W</span>
        <span>Batch Selector</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+S</span>
        <span>Save Invoice</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+D</span>
        <span>Duplicate Row</span>
    </div> -->
</div>
{% endblock %}