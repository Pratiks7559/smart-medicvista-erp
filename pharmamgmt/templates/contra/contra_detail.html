{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contra_detail.css' %}">
{% endblock %}

{% block content %}
<div class="contra-detail-container">
    <div class="contra-detail-header">
        <h2 class="contra-detail-title"><i class="fas fa-exchange-alt"></i> {{ title }}</h2>
        <div class="contra-detail-actions">
            <a href="{% url 'edit_contra' contra.contra_id %}" class="contra-btn contra-btn-edit">
                <i class="fas fa-edit"></i> Edit
            </a>
            {% if user.user_type == 'admin' %}
            <button onclick="showDeleteDialog()" class="contra-btn contra-btn-delete" style="border: none; cursor: pointer;">
                <i class="fas fa-trash"></i> Delete
            </button>
            {% endif %}
            <a href="{% url 'contra_list' %}" class="contra-btn contra-btn-back">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="contra-detail-card">
        <div class="contra-detail-grid">
            <div class="contra-detail-field">
                <div class="contra-detail-label">Contra No</div>
                <div class="contra-detail-value">{{ contra.contra_no }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">Date</div>
                <div class="contra-detail-value">{{ contra.contra_date|date:"d-m-Y" }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">Type</div>
                <div class="contra-detail-value">
                    {% if contra.contra_type == 'BANK_TO_CASH' %}
                    <span class="contra-type-badge contra-type-badge-success">Bank → Cash</span>
                    {% else %}
                    <span class="contra-type-badge contra-type-badge-info">Cash → Bank</span>
                    {% endif %}
                </div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">Amount</div>
                <div class="contra-detail-value">₹{{ contra.amount|floatformat:2 }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">From Account</div>
                <div class="contra-detail-value">{{ contra.from_account }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">To Account</div>
                <div class="contra-detail-value">{{ contra.to_account }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">Reference No</div>
                <div class="contra-detail-value">{{ contra.reference_no|default:"-" }}</div>
            </div>
            <div class="contra-detail-field">
                <div class="contra-detail-label">Created By</div>
                <div class="contra-detail-value">{{ contra.created_by.username|default:"-" }}</div>
            </div>
            <div class="contra-detail-field contra-detail-full">
                <div class="contra-detail-label">Narration</div>
                <div class="contra-detail-value">{{ contra.narration|default:"-" }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteContraDialog" class="contra-delete-dialog-overlay" style="display: none;">
    <div class="contra-delete-dialog-content">
        <div class="contra-delete-dialog-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>Delete Contra Entry</h4>
        </div>
        <div class="contra-delete-dialog-body">
            <p>Are you sure you want to delete this contra entry?</p>
            <div class="contra-delete-dialog-info">
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Contra No:</span>
                    <span>{{ contra.contra_no }}</span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Date:</span>
                    <span>{{ contra.contra_date|date:"d-m-Y" }}</span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Type:</span>
                    <span>{% if contra.contra_type == 'BANK_TO_CASH' %}Bank → Cash{% else %}Cash → Bank{% endif %}</span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Amount:</span>
                    <span>₹{{ contra.amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>
        <div class="contra-delete-dialog-actions">
            <button type="button" class="contra-btn contra-btn-cancel" onclick="closeDeleteDialog()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" id="confirmDeleteBtn" class="contra-btn contra-btn-delete" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<form style="display: none;">
    {% csrf_token %}
</form>

<script>
function showDeleteDialog() {
    document.getElementById('deleteContraDialog').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('confirmDeleteBtn').focus();
    }, 100);
}

function closeDeleteDialog() {
    document.getElementById('deleteContraDialog').style.display = 'none';
}

function confirmDelete() {
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/contra/{{ contra.contra_id }}/delete/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/contra/';
        } else {
            alert('Error deleting contra entry');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
    });
}

document.addEventListener('keydown', function(e) {
    const dialog = document.getElementById('deleteContraDialog');
    if (dialog.style.display === 'flex') {
        if (e.key === 'Escape') {
            e.preventDefault();
            closeDeleteDialog();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            confirmDelete();
        }
    }
});

document.getElementById('deleteContraDialog').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteDialog();
    }
});
</script>
{% endblock %}
