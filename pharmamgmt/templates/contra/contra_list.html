{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/contra_list.css' %}">
{% endblock %}

{% block content %}
<form style="display: none;">
    {% csrf_token %}
</form>
<div class="contra-list-container">
    <div class="contra-header">
        <h2 class="contra-title"><i class="fas fa-exchange-alt"></i> Contra Entries</h2>
        <a href="{% url 'add_contra' %}" class="contra-add-btn">
            <i class="fas fa-plus"></i> Add Contra Entry
        </a>
    </div>

    <div class="contra-filter-card">
        <form method="get" class="contra-filter-form">
            {% csrf_token %}
            <div class="contra-filter-field">
                <label>Start Date</label>
                <input type="date" name="start_date" class="contra-filter-input" value="{{ start_date }}">
            </div>
            <div class="contra-filter-field">
                <label>End Date</label>
                <input type="date" name="end_date" class="contra-filter-input" value="{{ end_date }}">
            </div>
            <div class="contra-filter-field">
                <label>Type</label>
                <select name="contra_type" class="contra-filter-input">
                    <option value="">All Types</option>
                    <option value="BANK_TO_CASH" {% if contra_type == 'BANK_TO_CASH' %}selected{% endif %}>Bank to Cash</option>
                    <option value="CASH_TO_BANK" {% if contra_type == 'CASH_TO_BANK' %}selected{% endif %}>Cash to Bank</option>
                </select>
            </div>
            <div class="contra-filter-actions">
                <button type="submit" class="contra-filter-btn contra-filter-btn-primary">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{% url 'contra_list' %}" class="contra-filter-btn contra-filter-btn-secondary">
                    <i class="fas fa-redo"></i> Reset
                </a>
            </div>
        </form>
    </div>

    <div class="contra-summary-grid">
        <div class="contra-summary-card contra-summary-card-success">
            <div class="contra-summary-title">Bank to Cash</div>
            <div class="contra-summary-amount">₹{{ bank_to_cash_total|floatformat:2 }}</div>
        </div>
        <div class="contra-summary-card contra-summary-card-info">
            <div class="contra-summary-title">Cash to Bank</div>
            <div class="contra-summary-amount">₹{{ cash_to_bank_total|floatformat:2 }}</div>
        </div>
    </div>

    <div class="contra-table-card">
        <div class="contra-table-wrapper">
            <table class="contra-table">
                <thead>
                    <tr>
                        <th>Contra No</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                        <th>Reference</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contra in contras %}
                    <tr>
                        <td><a href="{% url 'contra_detail' contra.contra_id %}">{{ contra.contra_no }}</a></td>
                        <td>{{ contra.contra_date|date:"d-m-Y" }}</td>
                        <td>
                            {% if contra.contra_type == 'BANK_TO_CASH' %}
                            <span class="contra-type-badge contra-type-badge-success">Bank → Cash</span>
                            {% else %}
                            <span class="contra-type-badge contra-type-badge-info">Cash → Bank</span>
                            {% endif %}
                        </td>
                        <td>{{ contra.from_account }}</td>
                        <td>{{ contra.to_account }}</td>
                        <td class="contra-amount-cell">₹{{ contra.amount|floatformat:2 }}</td>
                        <td>{{ contra.reference_no|default:"-" }}</td>
                        <td>
                            <a href="{% url 'edit_contra' contra.contra_id %}" class="contra-action-btn contra-action-btn-edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if user.user_type == 'admin' %}
                            <button onclick="showDeleteDialog({{ contra.contra_id }}, '{{ contra.contra_no }}', '{{ contra.contra_date|date:"d-m-Y" }}', '{{ contra.get_contra_type_display }}', {{ contra.amount }})" class="contra-action-btn contra-action-btn-delete" style="border: none; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="contra-empty-state">No contra entries found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteContraDialog" class="contra-delete-dialog-overlay" style="display: none;">
    <div class="contra-delete-dialog-content">
        <div class="contra-delete-dialog-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>Delete Contra Entry</h4>
        </div>
        <div class="contra-delete-dialog-body">
            <p>Are you sure you want to delete this contra entry?</p>
            <div class="contra-delete-dialog-info">
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Contra No:</span>
                    <span id="deleteContraNo"></span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Date:</span>
                    <span id="deleteContraDate"></span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Type:</span>
                    <span id="deleteContraType"></span>
                </div>
                <div class="contra-delete-dialog-row">
                    <span class="contra-delete-dialog-label">Amount:</span>
                    <span id="deleteContraAmount"></span>
                </div>
            </div>
        </div>
        <div class="contra-delete-dialog-actions">
            <button type="button" class="contra-btn contra-btn-cancel" onclick="closeDeleteDialog()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" id="confirmDeleteBtn" class="contra-btn contra-btn-delete" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<script>
let deleteContraId = null;

function showDeleteDialog(contraId, contraNo, contraDate, contraType, amount) {
    deleteContraId = contraId;
    document.getElementById('deleteContraNo').textContent = contraNo;
    document.getElementById('deleteContraDate').textContent = contraDate;
    document.getElementById('deleteContraType').textContent = contraType;
    document.getElementById('deleteContraAmount').textContent = '₹' + parseFloat(amount).toFixed(2);
    
    const dialog = document.getElementById('deleteContraDialog');
    dialog.style.display = 'flex';
    
    setTimeout(() => {
        document.getElementById('confirmDeleteBtn').focus();
    }, 100);
}

function closeDeleteDialog() {
    document.getElementById('deleteContraDialog').style.display = 'none';
    deleteContraId = null;
}

function confirmDelete() {
    if (!deleteContraId) return;
    
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/contra/${deleteContraId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            closeDeleteDialog();
            location.reload();
        } else {
            alert('Error deleting contra entry');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
    });
}

document.addEventListener('keydown', function(e) {
    const dialog = document.getElementById('deleteContraDialog');
    if (dialog.style.display === 'flex') {
        if (e.key === 'Escape') {
            e.preventDefault();
            closeDeleteDialog();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            confirmDelete();
        }
    }
});

document.getElementById('deleteContraDialog').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteDialog();
    }
});
</script>
{% endblock %}
