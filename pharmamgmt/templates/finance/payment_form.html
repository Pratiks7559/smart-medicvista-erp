{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
/* Fixed colors - no theme effects */
:root {
    --primary-color: #0066cc;
    --primary-hover: #004499;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-accent: #e9ecef;
    --bg-card: #ffffff;
    --text-primary: #333333;
    --text-secondary: #666666;
    --border-color: #cccccc;
    --border-focus: #0066cc;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
}

* {
    box-sizing: border-box;
}

.payment-form-container {
    max-width: 56rem;
    margin: 0 auto;
    padding: 1rem;
    background-color: #f5f5f5 !important;
    min-height: 100vh;
}

.payment-form-card {
    background-color: #ffffff !important;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    border: 2px solid #cccccc !important;
}

.payment-form-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: #333333 !important;
    margin: 0 0 2rem 0;
    text-align: center;
}

.search-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.search-dialog-overlay.active {
    opacity: 1;
    visibility: visible;
}

.search-dialog {
    background-color: #ffffff !important;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 600px;
    height: 500px;
    max-height: 80vh;
    border: 2px solid #cccccc !important;
    transform: scale(0.9) translateY(-20px);
    transition: transform 0.3s ease;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.search-dialog-overlay.active .search-dialog {
    transform: scale(1) translateY(0);
}

.search-dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.search-dialog-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #333333 !important;
}

.search-dialog-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #666666 !important;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.search-dialog-close:hover {
    background-color: #f8f9fa !important;
    color: #333333 !important;
}

.search-dialog-body {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.supplier-search-container {
    position: relative;
}

.supplier-search-input {
    width: 100%;
    padding: 1rem;
    border: 2px solid #cccccc !important;
    border-radius: var(--radius-md);
    font-size: 1rem;
    color: #333333 !important;
    background-color: #ffffff !important;
    transition: all 0.2s ease;
}

.supplier-search-input:focus {
    outline: none !important;
    border-color: #0066cc !important;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2) !important;
    background-color: #ffffff !important;
    color: #333333 !important;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: #ffffff !important;
    border: 2px solid #cccccc !important;
    border-radius: var(--radius-md);
    max-height: 300px;
    overflow-y: auto;
    z-index: 10;
    display: none;
    box-shadow: var(--shadow-lg);
    margin-top: 0.25rem;
}

.no-invoice-selected {
    text-align: center;
    padding: 2rem;
    background-color: #f8f9fa !important;
    border: 2px solid #e9ecef;
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
}

.no-invoice-selected p {
    margin: 0 0 1rem 0;
    color: #666666 !important;
}

.alert {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    position: relative;
}

.alert-success {
    background-color: #d1fae5;
    border-color: #a7f3d0;
    color: #065f46;
}

.alert-dismissible {
    padding-right: 3rem;
}

.btn-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    opacity: 0.5;
}

.btn-close:hover {
    opacity: 1;
}

.search-result-item {
    padding: 0.875rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #cccccc;
    transition: background-color 0.15s ease;
    color: #333333 !important;
}

.search-result-item:hover {
    background-color: #f8f9fa !important;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item.highlighted {
    background-color: #0066cc !important;
    color: #ffffff !important;
}

.search-result-item.highlighted * {
    color: white !important;
}

.selected-invoice-info {
    background-color: #e9ecef !important;
    padding: 1.25rem;
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
    display: none;
    border: 2px solid #cccccc !important;
}

.selected-invoice-info h5 {
    margin: 0 0 0.75rem 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #333333 !important;
}

.selected-invoice-info p {
    margin: 0.25rem 0;
    font-size: 0.875rem;
    color: #666666 !important;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 640px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #333333 !important;
    margin-bottom: 0.5rem;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #cccccc !important;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: #333333 !important;
    background-color: #ffffff !important;
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none !important;
    border-color: #0066cc !important;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2) !important;
    background-color: #ffffff !important;
    color: #333333 !important;
}

.form-control:disabled {
    background-color: #f8f9fa !important;
    color: #666666 !important;
    opacity: 0.6;
    cursor: not-allowed;
}

.form-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
    min-width: 8rem;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background-color: #0066cc !important;
    color: #ffffff !important;
    border: 2px solid #0066cc !important;
}

.btn-primary:hover:not(:disabled) {
    background-color: #004499 !important;
    border-color: #004499 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background-color: #6c757d !important;
    color: #ffffff !important;
    border: 2px solid #6c757d !important;
}

.btn-secondary:hover {
    background-color: #545b62 !important;
    border-color: #545b62 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-info {
    background-color: #17a2b8 !important;
    color: #ffffff !important;
    border: 2px solid #17a2b8 !important;
}

.btn-info:hover {
    background-color: #138496 !important;
    border-color: #138496 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-success {
    background-color: #28a745 !important;
    color: #ffffff !important;
    border: 2px solid #28a745 !important;
}

.btn-success:hover {
    background-color: #218838 !important;
    border-color: #218838 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-danger {
    background-color: #dc3545 !important;
    color: #ffffff !important;
    border: 2px solid #dc3545 !important;
}

.btn-danger:hover {
    background-color: #c82333 !important;
    border-color: #c82333 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.error-message {
    color: #dc3545 !important;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    background-color: #fff5f5;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #f8d7da;
}

.success-message {
    color: #28a745 !important;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    background-color: #f8fff8;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #d4edda;
}

/* Force visibility for all elements */
* {
    color: inherit !important;
}

body, .payment-form-container, .payment-form-card {
    background-color: #ffffff !important;
    color: #333333 !important;
}

input, select, textarea {
    background-color: #ffffff !important;
    color: #333333 !important;
    border: 2px solid #cccccc !important;
}

input:focus, select:focus, textarea:focus {
    background-color: #ffffff !important;
    color: #333333 !important;
    border-color: #0066cc !important;
}

/* Ensure text remains readable */
h1, h2, h3, h4, h5, h6, p, span, div, label, strong {
    color: #333333 !important;
}

/* Button visibility */
.btn {
    color: #ffffff !important;
}

.btn-primary {
    background-color: #0066cc !important;
    border-color: #0066cc !important;
}

.btn-secondary {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
}

/* Alert visibility */
.alert-success {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724 !important;
}

@media (max-width: 640px) {
    .payment-form-container {
        padding: 0.5rem;
    }
    
    .payment-form-card {
        padding: 1.5rem;
    }
    
    .payment-form-title {
        font-size: 1.5rem;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .payment-form-card {
        padding: 1rem;
    }
    
    .supplier-search-input,
    .form-control {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Search Dialog Modal -->
<div id="searchDialog" class="search-dialog-overlay">
    <div class="search-dialog">
        <div class="search-dialog-header">
            <h3>Select Supplier & Invoice</h3>
            <button type="button" class="search-dialog-close" id="closeDialog">&times;</button>
        </div>
        <div class="search-dialog-body">
            <div class="supplier-search-container">
                <input type="text" id="supplierSearch" class="supplier-search-input" 
                       placeholder="Type supplier name to search invoices..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
    </div>
</div>

<div class="payment-form-container">
    <div class="payment-form-card">
        <h1 class="payment-form-title">Add Payment</h1>
        
        <!-- Success Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Selected Invoice Info -->
        <div id="selectedInvoiceInfo" class="selected-invoice-info">
            <h5>Selected Invoice</h5>
            <div id="invoiceDetails"></div>
            <button type="button" class="btn btn-secondary" id="changeInvoice">Change Invoice</button>
        </div>
        
        <!-- No Invoice Selected State -->
        <div id="noInvoiceSelected" class="no-invoice-selected">
            <p>No invoice selected. Please select an invoice to proceed.</p>
            <button type="button" class="btn btn-primary" id="selectInvoice">Select Invoice</button>
        </div>
        
        <form method="post" id="paymentForm">
            {% csrf_token %}
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="{{ form.payment_date.id_for_label }}">Payment Date *</label>
                    {{ form.payment_date }}
                </div>
                <div class="form-group">
                    <label class="form-label" for="{{ form.payment_amount.id_for_label }}">Payment Amount *</label>
                    {{ form.payment_amount }}
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="{{ form.payment_mode.id_for_label }}">Payment Method *</label>
                    {{ form.payment_mode }}
                </div>
                <div class="form-group">
                    <label class="form-label" for="{{ form.payment_ref_no.id_for_label }}">Reference Number</label>
                    {{ form.payment_ref_no }}
                </div>
            </div>
            
            <div class="form-grid" id="bankNameRow" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="bankNameInput">Bank Name *</label>
                    <input type="text" id="bankNameInput" class="form-control" placeholder="Enter bank name">
                </div>
                <div class="form-group"></div>
            </div>
            
            {{ form.ip_invoiceid }}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <span class="loading-spinner" id="loadingSpinner" style="display: none;"></span>
                    <span id="submitText">Add Payment</span>
                </button>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
        
        <!-- Success Message Container -->
        <div id="successMessage" class="alert alert-success" style="display: none; margin-top: 1rem;">
            <i class="fas fa-check-circle"></i>
            <span id="successText">Payment added successfully!</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchDialog = document.getElementById('searchDialog');
    const closeDialog = document.getElementById('closeDialog');
    const selectInvoiceBtn = document.getElementById('selectInvoice');
    const changeInvoiceBtn = document.getElementById('changeInvoice');
    const searchInput = document.getElementById('supplierSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedInfo = document.getElementById('selectedInvoiceInfo');
    const noInvoiceSelected = document.getElementById('noInvoiceSelected');
    const invoiceDetails = document.getElementById('invoiceDetails');
    const invoiceField = document.getElementById('{{ form.ip_invoiceid.id_for_label }}');
    const amountField = document.getElementById('{{ form.payment_amount.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const paymentForm = document.getElementById('paymentForm');
    const paymentModeField = document.getElementById('{{ form.payment_mode.id_for_label }}');
    const bankNameRow = document.getElementById('bankNameRow');
    const bankNameInput = document.getElementById('bankNameInput');
    
    let searchTimeout;
    let isSearching = false;
    
    // Set today's date as default
    const dateField = document.getElementById('{{ form.payment_date.id_for_label }}');
    if (!dateField.value) {
        dateField.value = new Date().toISOString().split('T')[0];
    }
    
    // Auto-open dialog on page load
    setTimeout(() => {
        openDialog();
    }, 300);
    
    // Dialog functions
    function openDialog() {
        searchDialog.classList.add('active');
        resetHighlight();
        searchInput.value = '';
        searchResults.style.display = 'none';
        adjustDialogSize();
        setTimeout(() => {
            searchInput.focus();
        }, 100);
    }
    
    function closeDialogFunc() {
        searchDialog.classList.remove('active');
        searchInput.value = '';
        searchResults.style.display = 'none';
    }
    
    // Event listeners for dialog
    selectInvoiceBtn.addEventListener('click', openDialog);
    changeInvoiceBtn.addEventListener('click', openDialog);
    closeDialog.addEventListener('click', closeDialogFunc);
    
    // Close dialog on overlay click
    searchDialog.addEventListener('click', function(e) {
        if (e.target === searchDialog) {
            closeDialogFunc();
        }
    });
    
    // ESC key to close dialog
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && searchDialog.classList.contains('active')) {
            closeDialogFunc();
        }
    });
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            searchResults.style.display = 'none';
            adjustDialogSize();
            return;
        }
        
        isSearching = true;
        searchResults.innerHTML = '<div class="search-result-item">Searching...</div>';
        searchResults.style.display = 'block';
        adjustDialogSize();
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-supplier-invoices/?q=${encodeURIComponent(query)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                isSearching = false;
                console.log('Search results:', data);
                displaySearchResults(data);
                adjustDialogSize();
            })
            .catch(error => {
                isSearching = false;
                console.error('Search error:', error);
                searchResults.innerHTML = `<div class="search-result-item">Error loading results</div>`;
                adjustDialogSize();
            });
        }, 300);
    });
    
    // Function to adjust dialog size based on content
    function adjustDialogSize() {
        const dialog = document.querySelector('.search-dialog');
        const resultsVisible = searchResults.style.display !== 'none' && searchResults.children.length > 0;
        
        if (resultsVisible) {
            const resultCount = searchResults.children.length;
            const maxHeight = Math.min(resultCount * 80 + 200, window.innerHeight * 0.8);
            dialog.style.maxHeight = maxHeight + 'px';
        } else {
            dialog.style.maxHeight = '200px';
        }
    }
    
    function displaySearchResults(results) {
        searchResults.innerHTML = '';
        resetHighlight();
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-result-item">No unpaid invoices found</div>';
        } else {
            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <div style="font-weight: 600; color: var(--text-primary);">${result.supplier_name}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0;">
                        Invoice: ${result.invoice_no} | Date: ${result.invoice_date}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--success-color); font-weight: 600;">
                        Balance: ₹${result.balance_amount.toFixed(2)}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    selectInvoice(result);
                });
                
                item.addEventListener('mouseenter', () => {
                    resetHighlight();
                    currentHighlightIndex = index;
                    item.classList.add('highlighted');
                });
                
                item.addEventListener('mouseleave', () => {
                    item.classList.remove('highlighted');
                    currentHighlightIndex = -1;
                });
                
                searchResults.appendChild(item);
            });
        }
        
        searchResults.style.display = 'block';
    }
    
    function selectInvoice(invoice) {
        console.log('Selecting invoice:', invoice);
        
        // Close dialog
        closeDialogFunc();
        
        // Set form values
        if (invoiceField) {
            invoiceField.value = invoice.id;
            console.log('Set invoice field value to:', invoice.id);
        }
        if (amountField) {
            amountField.value = invoice.balance_amount.toFixed(2);
            console.log('Set amount field value to:', invoice.balance_amount.toFixed(2));
        }
        
        // Show selected invoice info
        if (invoiceDetails) {
            invoiceDetails.innerHTML = `
                <p><strong>Supplier:</strong> ${invoice.supplier_name}</p>
                <p><strong>Invoice:</strong> ${invoice.invoice_no} (${invoice.invoice_date})</p>
                <p><strong>Total:</strong> ₹${invoice.total_amount.toFixed(2)}</p>
                <p><strong>Paid:</strong> ₹${invoice.paid_amount.toFixed(2)}</p>
                <p><strong>Balance:</strong> <span style="color: var(--success-color); font-weight: 600;">₹${invoice.balance_amount.toFixed(2)}</span></p>
            `;
        }
        
        // Show/hide appropriate sections
        if (selectedInfo) selectedInfo.style.display = 'block';
        if (noInvoiceSelected) noInvoiceSelected.style.display = 'none';
        if (submitBtn) {
            submitBtn.disabled = false;
            console.log('Enabled submit button');
        }
        
        // Focus on date field after selection
        setTimeout(() => {
            if (dateField) dateField.focus();
        }, 100);
        
        // Validate amount doesn't exceed balance
        if (amountField) {
            amountField.addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                if (amount > invoice.balance_amount) {
                    this.value = invoice.balance_amount.toFixed(2);
                }
            });
        }
    }
    
    function resetForm() {
        if (selectedInfo) selectedInfo.style.display = 'none';
        if (noInvoiceSelected) noInvoiceSelected.style.display = 'block';
        if (invoiceField) invoiceField.value = '';
        if (amountField) amountField.value = '';
        if (submitBtn) submitBtn.disabled = true;
    }
    
    // Payment method change handler
    if (paymentModeField) {
        paymentModeField.addEventListener('change', function() {
            if (this.value === 'bank_transfer') {
                if (bankNameRow) bankNameRow.style.display = 'grid';
                if (bankNameInput) bankNameInput.required = true;
            } else {
                if (bankNameRow) bankNameRow.style.display = 'none';
                if (bankNameInput) {
                    bankNameInput.required = false;
                    bankNameInput.value = '';
                }
            }
        });
    }
    
    // Form submission
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate that an invoice is selected
            if (!invoiceField || !invoiceField.value) {
                alert('Please select an invoice first');
                openDialog();
                return;
            }
            
            // Validate payment amount
            if (!amountField || !amountField.value || parseFloat(amountField.value) <= 0) {
                alert('Please enter a valid payment amount');
                if (amountField) amountField.focus();
                return;
            }
            
            // Handle bank name for bank transfer
            if (paymentModeField && paymentModeField.value === 'bank_transfer') {
                const bankName = bankNameInput ? bankNameInput.value.trim() : '';
                if (!bankName) {
                    alert('Please enter bank name for bank transfer');
                    if (bankNameInput) bankNameInput.focus();
                    return;
                }
                paymentModeField.value = 'bank_transfer - ' + bankName;
            }
            
            // Show loading state
            const loadingSpinner = document.getElementById('loadingSpinner');
            const submitText = document.getElementById('submitText');
            const submitBtn = document.getElementById('submitBtn');
            
            if (loadingSpinner) loadingSpinner.style.display = 'inline-block';
            if (submitText) submitText.textContent = 'Processing...';
            if (submitBtn) submitBtn.disabled = true;
            
            // Submit form using fetch
            const formData = new FormData(paymentForm);
            
            fetch(paymentForm.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                // Show success message
                const successMessage = document.getElementById('successMessage');
                if (successMessage) {
                    successMessage.style.display = 'block';
                    successMessage.scrollIntoView({ behavior: 'smooth' });
                }
                
                // Reset form for next payment
                setTimeout(() => {
                    resetFormForNextPayment();
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Reset loading state
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (submitText) submitText.textContent = 'Add Payment';
                if (submitBtn) submitBtn.disabled = false;
                
                alert('Error submitting payment. Please try again.');
            });
        });
    }
    
    // Form submitted normally, page will reload with success message
    
    function resetFormForNextPayment() {
        if (paymentForm) paymentForm.reset();
        if (dateField) dateField.value = new Date().toISOString().split('T')[0];
        if (selectedInfo) selectedInfo.style.display = 'none';
        if (noInvoiceSelected) noInvoiceSelected.style.display = 'block';
        if (bankNameRow) bankNameRow.style.display = 'none';
        if (submitBtn) submitBtn.disabled = true;
    }
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
    
    // Enhanced keyboard navigation
    let currentHighlightIndex = -1;
    
    searchInput.addEventListener('keydown', function(e) {
        const items = searchResults.querySelectorAll('.search-result-item');
        if (items.length === 0 || isSearching) return;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateResults(items, 1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateResults(items, -1);
        } else if (e.key === 'Enter' && currentHighlightIndex >= 0) {
            e.preventDefault();
            const selectedItem = items[currentHighlightIndex];
            if (selectedItem && !selectedItem.textContent.includes('Searching') && !selectedItem.textContent.includes('Error')) {
                selectedItem.click();
            }
        }
    });
    
    function navigateResults(items, direction) {
        if (currentHighlightIndex >= 0 && items[currentHighlightIndex]) {
            items[currentHighlightIndex].classList.remove('highlighted');
        }
        
        if (direction === 1) {
            currentHighlightIndex = (currentHighlightIndex + 1) % items.length;
        } else {
            currentHighlightIndex = currentHighlightIndex <= 0 ? items.length - 1 : currentHighlightIndex - 1;
        }
        
        if (items[currentHighlightIndex]) {
            items[currentHighlightIndex].classList.add('highlighted');
            items[currentHighlightIndex].scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }
    }
    
    function resetHighlight() {
        currentHighlightIndex = -1;
        const items = searchResults.querySelectorAll('.search-result-item');
        items.forEach(item => item.classList.remove('highlighted'));
    }
});
</script>
{% endblock %}