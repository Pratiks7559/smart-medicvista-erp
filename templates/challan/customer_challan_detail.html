{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customer_challan_detail.css' %}">
{% endblock %}

{% block content %}
<div class="cust-chal-detail-container">
    <div class="cust-chal-detail-wrapper">
        <div class="cust-chal-detail-card">
            <!-- Header -->
            <div class="cust-chal-detail-header">
                <div class="header-left">
                    <h4 class="chal-title">Customer Challan Details</h4>
                    <span class="chal-number">{{ challan.customer_challan_no }}</span>
                </div>
                <div class="header-right">
                    <button type="button" class="edit-challan-btn" onclick="openEditChallanModal()">
                        <i class="fas fa-edit"></i> Edit Challan
                    </button>
                    <a href="{% url 'customer_challan_list' %}" class="chal-back-btn">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <!-- Challan Info -->
            <div class="cust-chal-info-section">
                <div class="info-row">
                    <div class="info-col">
                        <label class="info-label">Challan Number</label>
                        <div class="info-value">{{ challan.customer_challan_no }}</div>
                    </div>
                    <div class="info-col">
                        <label class="info-label">Challan Date</label>
                        <div class="info-value">{{ challan.customer_challan_date|date:"d-m-Y" }}</div>
                    </div>
                    <div class="info-col">
                        <label class="info-label">Customer Name</label>
                        <div class="info-value">{{ challan.customer_name.customer_name }}</div>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-col">
                        <label class="info-label">Series</label>
                        <div class="info-value">{{ challan.challan_series.series_name|default:"N/A" }}</div>
                    </div>
                    <div class="info-col">
                        <label class="info-label">Transport Charges</label>
                        <div class="info-value">‚Çπ{{ challan.customer_transport_charges|floatformat:2 }}</div>
                    </div>
                    <div class="info-col">
                        <label class="info-label">Created At</label>
                        <div class="info-value">{{ challan.created_at|date:"d-m-Y H:i" }}</div>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="cust-chal-products-section">
                <h5 class="section-title">Products</h5>
                <div class="products-table-wrapper">
                    <table class="chal-products-table">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Product Name</th>
                                <th>Company</th>
                                <th>Batch No</th>
                                <th>Expiry</th>
                                <th>MRP</th>
                                <th>Rate</th>
                                <th>Qty</th>
                                <th>Discount</th>
                                <th>CGST%</th>
                                <th>SGST%</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in challan_items %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="product-name-col">{{ item.product_name }}</td>
                                <td>{{ item.product_company }}</td>
                                <td>{{ item.product_batch_no }}</td>
                                <td>{{ item.product_expiry }}</td>
                                <td>‚Çπ{{ item.product_mrp|floatformat:2 }}</td>
                                <td>‚Çπ{{ item.sale_rate|floatformat:2 }}</td>
                                <td>{{ item.sale_quantity|floatformat:2 }}</td>
                                <td>‚Çπ{{ item.sale_discount|floatformat:2 }}</td>
                                <td>{{ item.sale_cgst|floatformat:2 }}%</td>
                                <td>{{ item.sale_sgst|floatformat:2 }}%</td>
                                <td class="total-col">‚Çπ{{ item.sale_total_amount|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12" class="no-data">No products found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            {% if challan.customer_transport_charges > 0 %}
                            <tr class="subtotal-row">
                                <td colspan="11" class="subtotal-label">Subtotal:</td>
                                <td class="subtotal-value">‚Çπ{{ grand_total|floatformat:2 }}</td>
                            </tr>
                            <tr class="transport-row">
                                <td colspan="11" class="transport-label">Transport Charges:</td>
                                <td class="transport-value">‚Çπ{{ challan.customer_transport_charges|floatformat:2 }}</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="11" class="total-label">Grand Total:</td>
                                <td class="grand-total">‚Çπ{{ final_total|floatformat:2 }}</td>
                            </tr>
                            {% else %}
                            <tr class="total-row">
                                <td colspan="11" class="total-label">Grand Total:</td>
                                <td class="grand-total">‚Çπ{{ grand_total|floatformat:2 }}</td>
                            </tr>
                            {% endif %}
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Challan Modal -->
<div id="editChallanModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Customer Challan #{{ challan.customer_challan_no }}</h3>
            <span class="close" onclick="closeEditChallanModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editChallanForm" method="post">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="challan_date">Challan Date:</label>
                        <input type="date" id="challan_date" name="challan_date" value="{{ challan.customer_challan_date|date:'Y-m-d' }}" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="customer_name">Customer:</label>
                        <select id="customer_name" name="customer_name" required>
                            {% for customer in customers %}
                            <option value="{{ customer.customerid }}" {% if customer.customerid == challan.customer_name.customerid %}selected{% endif %}>
                                {{ customer.customer_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transport_charges">Transport Charges:</label>
                        <input type="number" id="transport_charges" name="transport_charges" value="{{ challan.customer_transport_charges }}" step="0.01" min="0">
                    </div>
                </div>
                
                <h4>Products</h4>
                <div id="productsContainer"></div>
                
                <button type="button" onclick="addNewProduct()" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add Product
                </button>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeEditChallanModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Challan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productCounter = 0;
let customerRateType = 'A'; // Default rate type

function openEditChallanModal() {
    document.getElementById('editChallanModal').style.display = 'block';
    loadExistingProducts();
    fetchCustomerRateType();
    setTimeout(() => {
        document.getElementById('challan_date').focus();
    }, 300);
}

function fetchCustomerRateType() {
    const customerSelect = document.getElementById('customer_name');
    if (customerSelect && customerSelect.value) {
        fetch(`/api/customer-rate-info/?customer_id=${customerSelect.value}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API not available');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Extract rate type (A, B, or C)
                    const customerType = data.customer_type || '';
                    if (customerType.includes('A') || customerType === 'Type-A') {
                        customerRateType = 'A';
                    } else if (customerType.includes('B') || customerType === 'Type-B') {
                        customerRateType = 'B';
                    } else if (customerType.includes('C') || customerType === 'Type-C') {
                        customerRateType = 'C';
                    }
                    console.log('Customer Rate Type:', customerRateType);
                }
            })
            .catch(error => {
                console.warn('Could not fetch customer rate, using default Rate A:', error);
                customerRateType = 'A'; // Fallback to Rate A
            });
    }
}

// Update rate type when customer changes
document.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.getElementById('customer_name');
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            fetchCustomerRateType();
        });
    }
});

function closeEditChallanModal() {
    document.getElementById('editChallanModal').style.display = 'none';
}

function loadExistingProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    
    {% for item in challan_items %}
    addProductRow({
        productid: {{ item.product_id.productid }},
        product_name: '{{ item.product_name|escapejs }}',
        product_batch_no: '{{ item.product_batch_no|escapejs }}',
        product_expiry: '{{ item.product_expiry }}',
        product_mrp: {{ item.product_mrp }},
        sale_rate: {{ item.sale_rate }},
        sale_quantity: {{ item.sale_quantity }},
        sale_discount: {{ item.sale_discount }},
        sale_cgst: {{ item.sale_cgst }},
        sale_sgst: {{ item.sale_sgst }}
    });
    {% endfor %}
}

function addNewProduct() {
    addProductRow({});
}

function addProductRow(data = {}) {
    const container = document.getElementById('productsContainer');
    const productId = `product_${productCounter++}`;
    
    const productRow = document.createElement('div');
    productRow.className = 'product-row';
    
    let productOptions = '<option value="">Select Product</option>';
    {% for product in products %}
    productOptions += `<option value="{{ product.productid }}" ${data.productid && data.productid == {{ product.productid }} ? 'selected' : ''}>{{ product.product_name|escapejs }} - {{ product.product_company|escapejs }}</option>`;
    {% endfor %}
    
    productRow.innerHTML = `
        <div class="product-grid">
            <div class="form-group">
                <label>Product:</label>
                <select name="products[${productId}][productid]">
                    ${productOptions}
                </select>
            </div>
            <div class="form-group">
                <label>Batch No:</label>
                <input type="text" name="products[${productId}][batch_no]" value="${data.product_batch_no || ''}">
            </div>
            <div class="form-group">
                <label>Expiry:</label>
                <input type="text" name="products[${productId}][expiry]" value="${data.product_expiry || ''}" placeholder="MM-YYYY">
            </div>
            <div class="form-group">
                <label>MRP:</label>
                <input type="number" name="products[${productId}][mrp]" value="${data.product_mrp || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Rate:</label>
                <input type="number" name="products[${productId}][rate]" value="${data.sale_rate || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Quantity:</label>
                <input type="number" name="products[${productId}][quantity]" value="${data.sale_quantity || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>Discount:</label>
                <input type="number" name="products[${productId}][discount]" value="${data.sale_discount || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label>CGST %:</label>
                <input type="number" name="products[${productId}][cgst]" value="${data.sale_cgst || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <label>SGST %:</label>
                <input type="number" name="products[${productId}][sgst]" value="${data.sale_sgst || '2.5'}" step="0.01">
            </div>
            <div class="form-group">
                <button type="button" onclick="removeProduct(this)" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(productRow);
}

function removeProduct(button) {
    button.closest('.product-row').remove();
}

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editChallanForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const products = [];
            const productRows = document.querySelectorAll('.product-row');
            
            productRows.forEach(row => {
                const productSelect = row.querySelector('select[name*="[productid]"]');
                const batchInput = row.querySelector('input[name*="[batch_no]"]');
                const expiryInput = row.querySelector('input[name*="[expiry]"]');
                const mrpInput = row.querySelector('input[name*="[mrp]"]');
                const rateInput = row.querySelector('input[name*="[rate]"]');
                const qtyInput = row.querySelector('input[name*="[quantity]"]');
                const discountInput = row.querySelector('input[name*="[discount]"]');
                const cgstInput = row.querySelector('input[name*="[cgst]"]');
                const sgstInput = row.querySelector('input[name*="[sgst]"]');
                
                if (productSelect && productSelect.value) {
                    products.push({
                        productid: productSelect.value,
                        batch_no: batchInput ? batchInput.value : '',
                        expiry: expiryInput ? expiryInput.value : '',
                        mrp: mrpInput ? parseFloat(mrpInput.value) || 0 : 0,
                        rate: rateInput ? parseFloat(rateInput.value) || 0 : 0,
                        quantity: qtyInput ? parseFloat(qtyInput.value) || 0 : 0,
                        discount: discountInput ? parseFloat(discountInput.value) || 0 : 0,
                        cgst: cgstInput ? parseFloat(cgstInput.value) || 0 : 0,
                        sgst: sgstInput ? parseFloat(sgstInput.value) || 0 : 0
                    });
                }
            });
            
            formData.append('products_data', JSON.stringify(products));
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Backend returned HTML instead of JSON - endpoint not implemented
                    throw new Error('Edit functionality not yet implemented on backend');
                }
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Edit challan functionality is not yet implemented. Please contact administrator.');
            });
        });
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('editChallanModal');
    if (event.target === modal) {
        closeEditChallanModal();
    }
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('editChallanModal');
    
    // Ctrl+E to open modal (works globally)
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        if (!modal || modal.style.display === 'none') {
            openEditChallanModal();
        }
        return;
    }
    
    // Other shortcuts only work when modal is open
    if (!modal || modal.style.display === 'none') return;
    
    // F2 for quick product search
    if (e.key === 'F2') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    // Alt+W for batch selection
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        if (focusedElement && focusedElement.name && focusedElement.name.includes('[batch_no]')) {
            const row = focusedElement.closest('.product-row');
            const productSelect = row.querySelector('select[name*="[productid]"]');
            if (productSelect && productSelect.value) {
                showBatchSelectionDialog(productSelect.value, row);
            } else {
                alert('Please select a product first!');
            }
        }
    }
    
    // Escape to close
    if (e.key === 'Escape') {
        const quickModal = document.getElementById('quickProductModal');
        const batchModal = document.getElementById('batchSelectionModal');
        if (quickModal) {
            closeQuickSearch();
        } else if (batchModal) {
            closeBatchModal();
        } else {
            closeEditChallanModal();
        }
    }
});

// Quick Product Search
function openQuickProductSearch() {
    const existingModal = document.getElementById('quickProductModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name...">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        input.addEventListener('input', quickSearchProducts);
        input.addEventListener('keydown', handleQuickSearchKeys);
    }, 100);
}

function quickSearchProducts(e) {
    const searchTerm = e.target.value.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    const filtered = products.filter(p => 
        p.name.toLowerCase().startsWith(searchTerm) || 
        p.company.toLowerCase().startsWith(searchTerm)
    ).sort((a, b) => a.name.localeCompare(b.name));
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             data-product-id="${product.id}"
             onclick="selectQuickProduct(${product.id})">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function handleQuickSearchKeys(e) {
    const resultsDiv = document.getElementById('quickResults');
    const items = resultsDiv.querySelectorAll('.quick-result-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateQuickResults(1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateQuickResults(-1);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = resultsDiv.querySelector('.selected');
        if (selected) {
            const productId = selected.getAttribute('data-product-id');
            selectQuickProduct(productId);
        }
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeQuickSearch();
    }
}

function navigateQuickResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function selectQuickProduct(productId) {
    const rows = document.querySelectorAll('.product-row');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('select[name*="[productid]"]');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addNewProduct();
        setTimeout(() => {
            const newRows = document.querySelectorAll('.product-row');
            targetRow = newRows[newRows.length - 1];
            fillProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}

function fillProductInRow(row, productId) {
    const productSelect = row.querySelector('select[name*="[productid]"]');
    if (productSelect) {
        productSelect.value = productId;
        // Auto-open batch selection after product selection
        setTimeout(() => {
            showBatchSelectionDialog(productId, row);
        }, 200);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) modal.remove();
}

// Batch Selection
function showBatchSelectionDialog(productId, row) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createBatchSelectionModal(data.batches, row);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading batch information.');
        });
}

function createBatchSelectionModal(batches, row) {
    const existingModal = document.getElementById('batchSelectionModal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="batchSelectionModal" class="batch-modal-overlay">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" class="batch-modal-close" onclick="closeBatchModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="batchSearch" placeholder="Search batch...">
                    </div>
                    <div class="batch-list" id="batchList">
                        ${batches.map((batch, index) => `
                            <div class="batch-item ${index === 0 ? 'batch-selected' : ''}" 
                                 data-batch-index="${index}" 
                                 data-batch-data='${JSON.stringify(batch)}'
                                 onclick="selectBatch(this)">
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span>Exp: ${batch.expiry}</span>
                                        <span>Stock: ${batch.stock}</span>
                                        <span>MRP: ‚Çπ${batch.mrp}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const searchInput = document.getElementById('batchSearch');
        searchInput.focus();
        searchInput.addEventListener('input', filterBatches);
        document.addEventListener('keydown', handleBatchKeys);
    }, 50);
}

function filterBatches(e) {
    const searchTerm = e.target.value.toLowerCase();
    const batchItems = document.querySelectorAll('.batch-item');
    
    batchItems.forEach(item => item.classList.remove('batch-selected'));
    
    let firstVisible = null;
    batchItems.forEach(item => {
        const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
        if (batchNo.includes(searchTerm)) {
            item.style.display = 'block';
            if (!firstVisible) firstVisible = item;
        } else {
            item.style.display = 'none';
        }
    });
    
    if (firstVisible) firstVisible.classList.add('batch-selected');
}

function handleBatchKeys(e) {
    const modal = document.getElementById('batchSelectionModal');
    if (!modal) return;
    
    const visibleItems = Array.from(document.querySelectorAll('.batch-item')).filter(item => item.style.display !== 'none');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateBatches(visibleItems, 1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateBatches(visibleItems, -1);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = document.querySelector('.batch-item.batch-selected');
        if (selected) selectBatch(selected);
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeBatchModal();
    }
}

function navigateBatches(items, direction) {
    if (items.length === 0) return;
    
    const current = items.find(item => item.classList.contains('batch-selected'));
    let newIndex = 0;
    
    if (current) {
        const currentIndex = items.indexOf(current);
        newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        current.classList.remove('batch-selected');
    }
    
    items[newIndex].classList.add('batch-selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function selectBatch(element) {
    const batchData = JSON.parse(element.getAttribute('data-batch-data'));
    const rows = document.querySelectorAll('.product-row');
    
    // Find the active row (where batch selection was triggered)
    let targetRow = null;
    for (let row of rows) {
        const batchInput = row.querySelector('input[name*="[batch_no]"]');
        if (batchInput && (document.activeElement.closest('.product-row') === row || !batchInput.value)) {
            targetRow = row;
            break;
        }
    }
    
    // If no specific row found, use the last row
    if (!targetRow && rows.length > 0) {
        targetRow = rows[rows.length - 1];
    }
    
    if (targetRow) {
        // Determine rate based on customer rate type
        let selectedRate = batchData.mrp; // Default fallback
        let rateSource = 'MRP (Fallback)';
        
        if (batchData.rates) {
            if (customerRateType === 'A' && batchData.rates.rate_A && batchData.rates.rate_A > 0) {
                selectedRate = batchData.rates.rate_A;
                rateSource = 'Rate A';
            } else if (customerRateType === 'B' && batchData.rates.rate_B && batchData.rates.rate_B > 0) {
                selectedRate = batchData.rates.rate_B;
                rateSource = 'Rate B';
            } else if (customerRateType === 'C' && batchData.rates.rate_C && batchData.rates.rate_C > 0) {
                selectedRate = batchData.rates.rate_C;
                rateSource = 'Rate C';
            }
        }
        
        console.log(`Applied ${rateSource}: ‚Çπ${selectedRate} for customer type ${customerRateType}`);
        
        // Auto-fill all batch details with customer-specific rate
        targetRow.querySelector('input[name*="[batch_no]"]').value = batchData.batch_no;
        targetRow.querySelector('input[name*="[expiry]"]').value = batchData.expiry;
        targetRow.querySelector('input[name*="[mrp]"]').value = batchData.mrp;
        targetRow.querySelector('input[name*="[rate]"]').value = selectedRate; // Customer-specific rate
        targetRow.querySelector('input[name*="[quantity]"]').value = '1';
        targetRow.querySelector('input[name*="[discount]"]').value = '0';
        targetRow.querySelector('input[name*="[cgst]"]').value = '2.5';
        targetRow.querySelector('input[name*="[sgst]"]').value = '2.5';
        
        // Focus on quantity field
        setTimeout(() => {
            const qtyField = targetRow.querySelector('input[name*="[quantity]"]');
            if (qtyField) {
                qtyField.focus();
                qtyField.select();
            }
        }, 100);
    }
    
    closeBatchModal();
}

function closeBatchModal() {
    const modal = document.getElementById('batchSelectionModal');
    if (modal) modal.remove();
    document.removeEventListener('keydown', handleBatchKeys);
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 1000px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
}

.modal-header h3 {
    font-size: 1.1rem;
    margin: 0;
}

.modal-body {
    padding: 1rem;
}

.close {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #2c3e50;
    font-size: 0.85rem;
}

.form-group input, .form-group select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.85rem;
}

.product-row {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: #f8f9fa;
}

.product-row h4 {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
}

.btn-primary {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid #ddd;
}

.edit-challan-btn {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-right: 0.5rem;
}

.edit-challan-btn:hover {
    background: linear-gradient(135deg, #2980b9, #21618c);
}

/* Quick Search Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-search-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.quick-search-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 1rem;
    text-align: center;
}

.quick-search-input {
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.quick-search-input input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.quick-search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
}

.quick-result-item {
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    margin-bottom: 0.25rem;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #f8f9fa;
    border-color: #007bff;
    transform: translateX(4px);
}

.product-name {
    font-weight: 600;
    color: #2c3e50;
}

.product-company {
    font-size: 0.85rem;
    color: #6c757d;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.quick-search-footer {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #eee;
}

/* Batch Selection Styles */
.batch-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
}

.batch-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.batch-modal-header {
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
}

.batch-modal-body {
    padding: 1rem;
}

.batch-search {
    margin-bottom: 1rem;
}

.batch-search input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
}

.batch-list {
    max-height: 400px;
    overflow-y: auto;
}

.batch-item {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.batch-item:hover,
.batch-item.batch-selected {
    background: #e8f5e9;
    border-color: #28a745;
}

.batch-no {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.batch-details {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: #6c757d;
}

.batch-modal-footer {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #eee;
}
</style>
{% endblock %}
