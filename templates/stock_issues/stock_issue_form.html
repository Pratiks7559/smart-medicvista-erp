{% extends 'base.html' %}
{% load static %}

{% block title %}New Stock Issue{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_issue_form.css' %}">
{% endblock %}

{% block content %}
<div class="stock-issue-form-container">
    <div class="header-section">
        <div class="page-title">
            <h1><i class="fas fa-minus-circle"></i> New Stock Issue</h1>
            <p>Create a new stock adjustment or issue entry</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'stock_issue_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <form method="POST" id="stockIssueForm" class="stock-issue-form">
        {% csrf_token %}
        
        <div class="form-sections">
            <!-- Issue Information -->
            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> Issue Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="issue_type">Issue Type *</label>
                        <select name="issue_type" id="issue_type" required class="form-control">
                            <option value="">Select Issue Type</option>
                            {% for type_code, type_name in issue_types %}
                                <option value="{{ type_code }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issue_date">Issue Date *</label>
                        <input type="date" name="issue_date" id="issue_date" 
                               value="{{ today|date:'Y-m-d' }}" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="remarks">Remarks</label>
                        <textarea name="remarks" id="remarks" rows="3" 
                                  placeholder="Enter any additional remarks..." class="form-control"></textarea>
                    </div>
                </div>
            </div>



            <!-- Selected Products -->
            <div class="form-section">
                <h3><i class="fas fa-list"></i> Selected Products</h3>
                <div class="shortcuts-info" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; color: #6c757d;">
                    <strong>Keyboard Shortcuts:</strong> Press <kbd>Ctrl + F2</kbd> to open Quick Product Search
                </div>
                <div class="products-table-container">
                    <table id="selectedProductsTable" class="products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Batch No</th>
                                <th>Expiry</th>
                                <th>Issue Qty</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Remarks</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr class="empty-row">
                                <td colspan="8" class="text-center">No products selected</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="5"><strong>Total Value:</strong></td>
                                <td><strong id="totalValue">‚Çπ0.00</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Create Stock Issue
            </button>
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>

        <input type="hidden" name="products_data" id="productsData">
    </form>
</div>

<!-- Quick Product Search Modal -->
<div id="quickProductModal" class="quick-search-overlay" style="display: none;">
    <div class="quick-search-content">
        <div class="quick-search-header">
            <h4>üîç Quick Product Search</h4>
            <small>Type product name and press Enter</small>
        </div>
        <div class="quick-search-input">
            <input type="text" id="quickProductInput" placeholder="Type product name...">
        </div>
        <div class="quick-search-results" id="quickResults"></div>
        <div class="quick-search-footer">
            <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close | Ctrl+F2: Open Search</small>
        </div>
    </div>
</div>

<!-- Batch Selection Modal will be created dynamically -->

<script>
let selectedProducts = [];
let selectedProduct = null;

// Pre-load products array (client-side approach like purchase form)
window.allProducts = [{% for product in products %}{
    id: {{ product.productid }},
    name: '{{ product.product_name|escapejs }}',
    company: '{{ product.product_company|escapejs }}',
    packing: '{{ product.product_packing|escapejs }}',
    barcode: '{{ product.product_barcode|escapejs }}'
},{% endfor %}];
console.log('Loaded', window.allProducts.length, 'products for stock issue');

function performFrontendSearch(searchTerm, resultsDiv) {
    const originalSearchTerm = searchTerm;
    const lowerSearchTerm = searchTerm.toLowerCase();
    
    // Filter products that START with the search term (same logic as purchase form)
    const filtered = window.allProducts.filter(p => {
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(lowerSearchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(lowerSearchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches (same as purchase form)
        let aScore = 0, bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(lowerSearchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(lowerSearchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(lowerSearchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(lowerSearchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    displayQuickResults(filtered.slice(0, 20));
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('stockIssueForm').addEventListener('submit', function(e) {
        if (selectedProducts.length === 0) {
            e.preventDefault();
            alert('Please add at least one product to the stock issue.');
            return;
        }
        document.getElementById('productsData').value = JSON.stringify(selectedProducts);
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'F2') {
            e.preventDefault();
            openQuickProductSearch();
        }
    });
});







function showBatchModal(product) {
    console.log('üì¶ Fetching batches for product:', product.id, product.name);
    console.log('üîó API URL:', `/stock-issues/api/product-batch-info/?product_id=${product.id}`);
    
    fetch(`/stock-issues/api/product-batch-info/?product_id=${product.id}`)
        .then(response => {
            console.log('üì° API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä API Data received:', data);
            
            if (data.success && data.batches.length > 0) {
                console.log('‚úÖ Creating batch modal with', data.batches.length, 'batches');
                createBatchSelectionModal(data.batches, product);
            } else {
                console.log('‚ö†Ô∏è No batches found');
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('‚ùå Error fetching batches:', error);
            alert('Error loading batch information.');
        });
}

function createBatchSelectionModal(batches, product) {
    // Remove existing modal if any
    const existingModal = document.getElementById('batchSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal HTML
    const modalHTML = `
        <div id="batchSelectionModal" class="batch-modal-overlay">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch for Stock Issue</h3>
                    <button type="button" class="batch-modal-close" onclick="closeBatchSelectionModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="batchSearch" placeholder="Search batch...">
                    </div>
                    <div class="batch-list" id="batchList" tabindex="0">
                        ${batches.map((batch, index) => `
                            <div class="batch-item ${index === 0 ? 'batch-selected' : ''} ${batch.stock > 0 ? '' : 'batch-unavailable'}" 
                                 data-batch-index="${index}" data-batch-data='${JSON.stringify(batch)}'>
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span class="batch-expiry">Exp: ${batch.expiry}</span>
                                        <span class="batch-stock">Stock: ${batch.stock}</span>
                                        <span class="batch-mrp">MRP: ‚Çπ${batch.mrp}</span>
                                    </div>
                                    <div class="batch-rates">
                                        <span>Rate: ‚Çπ${batch.purchase_rate || batch.mrp}</span>
                                    </div>
                                </div>
                                <div class="batch-status">
                                    ${batch.stock > 0 ? '<span class="status-available">Available</span>' : '<span class="status-unavailable">Out of Stock</span>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <div class="batch-shortcuts">
                        <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="closeBatchSelectionModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Initialize batch selection after modal is added
    setTimeout(() => {
        initializeBatchSelectionModal();
        const batchList = document.getElementById('batchList');
        if (batchList) {
            batchList.focus();
        }
    }, 100);
}

function initializeBatchSelectionModal() {
    const modal = document.getElementById('batchSelectionModal');
    const searchInput = document.getElementById('batchSearch');
    const batchList = document.getElementById('batchList');
    
    if (!modal || !searchInput || !batchList) {
        console.error('Batch modal elements not found');
        return;
    }
    
    batchList.focus();
    
    function handleModalKeydown(e) {
        e.stopPropagation();
        
        const visibleItems = batchList.querySelectorAll('.batch-item:not([style*="display: none"])');
        let selectedIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('batch-selected'));
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (visibleItems.length > 0) {
                    visibleItems.forEach(item => item.classList.remove('batch-selected'));
                    selectedIndex = selectedIndex < visibleItems.length - 1 ? selectedIndex + 1 : 0;
                    visibleItems[selectedIndex].classList.add('batch-selected');
                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (visibleItems.length > 0) {
                    visibleItems.forEach(item => item.classList.remove('batch-selected'));
                    selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : visibleItems.length - 1;
                    visibleItems[selectedIndex].classList.add('batch-selected');
                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                const selectedItem = batchList.querySelector('.batch-item.batch-selected');
                if (selectedItem) {
                    const batchData = JSON.parse(selectedItem.getAttribute('data-batch-data'));
                    selectBatchForIssue(batchData);
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                closeBatchSelectionModal();
                break;
        }
    }
    
    modal.addEventListener('keydown', handleModalKeydown);
    
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const batchItems = batchList.querySelectorAll('.batch-item');
        
        batchItems.forEach(item => item.classList.remove('batch-selected'));
        
        let firstVisible = null;
        batchItems.forEach(item => {
            const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
            const batchDetails = item.querySelector('.batch-details').textContent.toLowerCase();
            
            if (batchNo.includes(searchTerm) || batchDetails.includes(searchTerm)) {
                item.style.display = 'block';
                if (!firstVisible) firstVisible = item;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (firstVisible) {
            firstVisible.classList.add('batch-selected');
        }
    });
    
    const batchItems = batchList.querySelectorAll('.batch-item');
    batchItems.forEach(item => {
        item.addEventListener('click', function() {
            const batchData = JSON.parse(this.getAttribute('data-batch-data'));
            selectBatchForIssue(batchData);
        });
    });
}

function selectBatchForIssue(batchData) {
    const product = {
        product_id: selectedProduct.id,
        product_name: selectedProduct.name,
        product_company: selectedProduct.company,
        product_packing: selectedProduct.packing,
        batch_no: batchData.batch_no,
        expiry_date: batchData.expiry,
        unit_rate: batchData.purchase_rate || batchData.mrp,
        mrp: batchData.mrp,
        quantity_issued: 1,
        remarks: ''
    };
    
    addProductToTable(product);
    closeBatchSelectionModal();
    selectedProduct = null;
}

function closeBatchSelectionModal() {
    const modal = document.getElementById('batchSelectionModal');
    if (modal) {
        modal.remove();
    }
}

function addProductToTable(product) {
    selectedProducts.push(product);
    updateProductsTable();
}

function updateProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    
    if (selectedProducts.length === 0) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="9" class="text-center">No products selected</td></tr>';
        updateTotalValue();
        return;
    }
    
    const html = selectedProducts.map((product, index) => `
        <tr>
            <td>
                <div class="product-info">
                    <div class="product-name">${product.product_name}</div>
                    <div class="product-details">${product.product_company} - ${product.product_packing}</div>
                </div>
            </td>
            <td>${product.batch_no}</td>
            <td>${product.expiry_date}</td>
            <td>
                <input type="number" value="${product.quantity_issued}" min="0.01" 
                       step="0.01" class="form-control qty-input" onchange="updateQuantity(${index}, this.value)">
            </td>
            <td>‚Çπ${product.unit_rate}</td>
            <td class="amount">‚Çπ${(product.quantity_issued * product.unit_rate).toFixed(2)}</td>
            <td>
                <input type="text" value="${product.remarks}" placeholder="Remarks..." 
                       class="form-control remarks-input" onchange="updateRemarks(${index}, this.value)">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeProduct(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
    updateTotalValue();
}

function updateQuantity(index, quantity) {
    selectedProducts[index].quantity_issued = parseFloat(quantity) || 0;
    updateProductsTable();
}

function updateRemarks(index, remarks) {
    selectedProducts[index].remarks = remarks;
}

function removeProduct(index) {
    selectedProducts.splice(index, 1);
    updateProductsTable();
}

function updateTotalValue() {
    const total = selectedProducts.reduce((sum, product) => {
        return sum + (product.quantity_issued * product.unit_rate);
    }, 0);
    
    document.getElementById('totalValue').textContent = `‚Çπ${total.toFixed(2)}`;
}

// Removed old batch modal functions - using new batch selection modal



function openQuickProductSearch() {
    const modal = document.getElementById('quickProductModal');
    modal.style.display = 'flex';
    
    setTimeout(() => {
        const input = document.getElementById('quickProductInput');
        input.focus();
        input.value = '';
        
        document.getElementById('quickResults').innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        
        let searchTimeout;
        input.onkeyup = function(e) {
            if (e.key === 'Escape') {
                closeQuickSearch();
                return;
            }
            
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                navigateQuickResults(e.key === 'ArrowDown' ? 1 : -1);
                return;
            }
            
            if (e.key === 'Enter') {
                selectQuickResult();
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                quickSearchProducts(this.value);
            }, 50);
        };
    }, 100);
}

function quickSearchProducts(searchTerm) {
    const resultsDiv = document.getElementById('quickResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    // No loading message needed for frontend search
    
    // Client-side search only (like purchase form)
    performFrontendSearch(searchTerm, resultsDiv);
}

function displayQuickResults(products) {
    const resultsDiv = document.getElementById('quickResults');
    
    if (products.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products found</div>';
        return;
    }
    
    resultsDiv.innerHTML = products.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             data-product-id="${product.id}" 
             data-product-name="${product.name}" 
             data-product-company="${product.company}"
             data-product-packing="${product.packing || ''}">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}${product.packing ? ' - ' + product.packing : ''}</div>
        </div>
    `).join('');
    
    resultsDiv.querySelectorAll('.quick-result-item').forEach(item => {
        item.onclick = function() {
            const productId = this.getAttribute('data-product-id');
            const productName = this.getAttribute('data-product-name');
            const productCompany = this.getAttribute('data-product-company');
            const productPacking = this.getAttribute('data-product-packing');
            quickSelectProduct(productId, productName, productCompany, productPacking);
        };
    });
}

function navigateQuickResults(direction) {
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = items.length - 1;
        if (newIndex >= items.length) newIndex = 0;
        
        current.classList.remove('selected');
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ block: 'nearest' });
}

function selectQuickResult() {
    const selected = document.querySelector('.quick-result-item.selected');
    if (selected) {
        const productId = selected.getAttribute('data-product-id');
        const productName = selected.getAttribute('data-product-name');
        const productCompany = selected.getAttribute('data-product-company');
        quickSelectProduct(productId, productName, productCompany);
    }
}

function quickSelectProduct(productId, productName, productCompany, productPacking) {
    console.log('Selected product:', productId, productName, productCompany, productPacking);
    
    selectedProduct = {
        id: productId,
        name: productName,
        company: productCompany,
        packing: productPacking || ''
    };
    
    closeQuickSearch();
    
    setTimeout(() => {
        showBatchModal(selectedProduct);
    }, 100);
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    modal.style.display = 'none';
}

document.addEventListener('click', function(e) {
    if (e.target.id === 'quickProductModal') {
        closeQuickSearch();
    }
});
</script>
{% endblock %}